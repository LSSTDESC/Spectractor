

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectractor.simulation.simulator &mdash; Spectractor 1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'1.1',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Spectractor
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spectractor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>spectractor.simulation.simulator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectractor.simulation.simulator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">simulator</span>
<span class="sd">=============----</span>

<span class="sd">author : Sylvie Dagoret-Campagne, Jérémy Neveu</span>
<span class="sd">affiliation : LAL/CNRS/IN2P3/FRANCE</span>
<span class="sd">Collaboration : DESC-LSST</span>

<span class="sd">Purpose : Simulate a series of spectra for each experimental spectra measured by auxiliary telescope.</span>
<span class="sd">Structure in parallel to Spectractor.</span>
<span class="sd">For each experimental spectra a fits file image is generated which holds all possible auxiliary telescope spectra</span>
<span class="sd">corresponding to different conditions in aerosols, pwv, and ozone.</span>

<span class="sd">creation date : April 18th</span>
<span class="sd">Last update : July 2018</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">RegularGridInterpolator</span>

<span class="kn">from</span> <span class="nn">spectractor.extractor.images</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.spectrum</span> <span class="k">import</span> <span class="n">Spectrum</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.dispersers</span> <span class="k">import</span> <span class="n">Hologram</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.targets</span> <span class="k">import</span> <span class="n">Target</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.psf</span> <span class="k">import</span> <span class="n">PSF2D</span>
<span class="kn">from</span> <span class="nn">spectractor.tools</span> <span class="k">import</span> <span class="n">fftconvolve_gaussian</span><span class="p">,</span> <span class="n">ensure_dir</span>
<span class="kn">from</span> <span class="nn">spectractor.config</span> <span class="k">import</span> <span class="n">set_logger</span>
<span class="kn">import</span> <span class="nn">spectractor.parameters</span> <span class="k">as</span> <span class="nn">parameters</span>

<span class="kn">import</span> <span class="nn">spectractor.simulation.libradtran</span> <span class="k">as</span> <span class="nn">libradtran</span>
<span class="kn">from</span> <span class="nn">spectractor.simulation.throughput</span> <span class="k">import</span> <span class="n">Throughput</span><span class="p">,</span> <span class="n">plot_transmission_simple</span>

<span class="kn">import</span> <span class="nn">slitless.fourier.arrays</span> <span class="k">as</span> <span class="nn">FA</span>
<span class="kn">import</span> <span class="nn">slitless.fourier.fourier</span> <span class="k">as</span> <span class="nn">F</span>


<div class="viewcode-block" id="Atmosphere"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.Atmosphere">[docs]</a><span class="k">class</span> <span class="nc">Atmosphere</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class to evaluate an atmospheric transmission using Libradtran.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        airmass: float</span>
<span class="sd">            Airmass of the source object.</span>
<span class="sd">        pressure: float</span>
<span class="sd">            Pressure of the atmosphere in hPa.</span>
<span class="sd">        temperature: float</span>
<span class="sd">            Temperature of the atmosphere in Celsius degrees.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = Atmosphere(airmass=1.2, pressure=800, temperature=5)</span>
<span class="sd">        &gt;&gt;&gt; print(a.airmass)</span>
<span class="sd">        1.2</span>
<span class="sd">        &gt;&gt;&gt; print(a.pressure)</span>
<span class="sd">        800</span>
<span class="sd">        &gt;&gt;&gt; print(a.temperature)</span>
<span class="sd">        5</span>
<span class="sd">        &gt;&gt;&gt; print(a.transmission(500))</span>
<span class="sd">        1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="n">airmass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ozone</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aerosols</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="Atmosphere.set_title"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.Atmosphere.set_title">[docs]</a>    <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a title string for the simulation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Atmospheric transmission with z=</span><span class="si">{self.airmass:4.2f}</span><span class="s1">, P=</span><span class="si">{self.pressure:4.2f}</span><span class="s1"> hPa, &#39;</span> \
                     <span class="n">f</span><span class="s1">&#39;T=</span><span class="si">{self.temperature:4.2f}</span><span class="s1">$\degree$C&#39;</span></div>

<div class="viewcode-block" id="Atmosphere.set_label"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.Atmosphere.set_label">[docs]</a>    <span class="k">def</span> <span class="nf">set_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a label string for the simulation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;PWV=</span><span class="si">{self.pwv:4.2f}</span><span class="s1">mm, OZ=</span><span class="si">{self.ozone:4.2f}</span><span class="s1">DB, VAOD=</span><span class="si">{self.aerosols:4.2f}</span><span class="s1"> &#39;</span></div>

<div class="viewcode-block" id="Atmosphere.simulate"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.Atmosphere.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate the atmosphere transparency with Libradtran given atmospheric composition.</span>

<span class="sd">        Values outside the Libradtran simulation range are set to zero.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ozone: float</span>
<span class="sd">            Ozone quantity in Dobson</span>
<span class="sd">        pwv: float</span>
<span class="sd">            Precipitable Water Vapor quantity in mm</span>
<span class="sd">        aerosols: float</span>
<span class="sd">            VAOD Vertical Aerosols Optical Depth</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        transmission: callable</span>
<span class="sd">            The transmission function of wavelengths in nm.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = Atmosphere(airmass=1.2, pressure=800, temperature=5)</span>
<span class="sd">        &gt;&gt;&gt; transmission = a.simulate(ozone=400, pwv=5, aerosols=0.05)</span>
<span class="sd">        &gt;&gt;&gt; assert transmission is not None</span>
<span class="sd">        &gt;&gt;&gt; assert a.transmission(500) &gt; 0</span>
<span class="sd">        &gt;&gt;&gt; a.ozone</span>
<span class="sd">        400</span>
<span class="sd">        &gt;&gt;&gt; a.pwv</span>
<span class="sd">        5</span>
<span class="sd">        &gt;&gt;&gt; a.aerosols</span>
<span class="sd">        0.05</span>
<span class="sd">        &gt;&gt;&gt; a.plot_transmission()</span>

<span class="sd">        ..plot:</span>
<span class="sd">            fig = plt.figure()</span>
<span class="sd">            plot_transmission_simple(plt.gca(), lambdas, transmission(lambdas), title=a.title, label=a.label)</span>
<span class="sd">            plt.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pwv</span> <span class="o">=</span> <span class="n">pwv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ozone</span> <span class="o">=</span> <span class="n">ozone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aerosols</span> <span class="o">=</span> <span class="n">aerosols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_label</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{self.title}</span><span class="se">\n\t\t</span><span class="si">{self.label}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">lib</span> <span class="o">=</span> <span class="n">libradtran</span><span class="o">.</span><span class="n">Libradtran</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">atm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">atm</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span></div>

<div class="viewcode-block" id="Atmosphere.plot_transmission"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.Atmosphere.plot_transmission">[docs]</a>    <span class="k">def</span> <span class="nf">plot_transmission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the atmospheric transmission computed with Libradtran.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = Atmosphere(airmass=1.2, pressure=800, temperature=5)</span>
<span class="sd">        &gt;&gt;&gt; transmission = a.simulate(ozone=400, pwv=5, aerosols=0.05)</span>
<span class="sd">        &gt;&gt;&gt; a.plot_transmission()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plot_transmission_simple</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">),</span>
                                 <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<span class="c1"># ----------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AtmosphereGrid"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid">[docs]</a><span class="k">class</span> <span class="nc">AtmosphereGrid</span><span class="p">(</span><span class="n">Atmosphere</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mf">800.</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
                 <span class="n">pwv_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">ozone_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">aerosol_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Class to load and interpolate grids of atmospheric transmission computed with Libradtran.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image_filename: str, optional</span>
<span class="sd">            The original image fits file name from which the grid was computed or has to be computed (default: &quot;&quot;).</span>
<span class="sd">        filename: str, optional</span>
<span class="sd">            The file name of the atmospheric grid if it exists (default: &quot;&quot;).</span>
<span class="sd">        airmass: float, optional</span>
<span class="sd">            Airmass of the source object (default: 1).</span>
<span class="sd">        pressure: float, optional</span>
<span class="sd">            Pressure of the atmosphere in hPa (default: 800).</span>
<span class="sd">        temperature: float, optional</span>
<span class="sd">            Temperature of the atmosphere in Celsius degrees (default: 10).</span>
<span class="sd">        pwv_grid: list</span>
<span class="sd">            List of 3 numbers for the PWV quantity: min, max, number of simulations (default: [0, 10, 10]).</span>
<span class="sd">        ozone_grid: list</span>
<span class="sd">            List of 3 numbers for the ozone quantity: min, max, number of simulations (default: [100, 700, 7]).</span>
<span class="sd">        aerosol_grid: list</span>
<span class="sd">            List of 3 numbers for the aerosol quantity: min, max, number of simulations (default: [0, 0.1, 10]).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = AtmosphereGrid(filename=&#39;./tests/data/reduc_20170530_134_atmsim.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a.image_filename.split(&#39;/&#39;)[-1]</span>
<span class="sd">        &#39;reduc_20170530_134_spectrum.fits&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Atmosphere</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_filename</span> <span class="o">=</span> <span class="n">image_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c1"># ------------------------------------------------------------------------</span>
        <span class="c1"># Definition of data format for the atmospheric grid</span>
        <span class="c1"># -----------------------------------------------------------------------------</span>

        <span class="c1">#  row 0 : count number</span>
        <span class="c1">#  row 1 : aerosol value</span>
        <span class="c1">#  row 2 : pwv value</span>
        <span class="c1">#  row 3 : ozone value</span>
        <span class="c1">#  row 4 : data start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_aer</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_pwv</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_oz</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="c1"># specify parameters for the atmospheric grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_HEADER</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_DATA</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_POINTS</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="n">pwv_grid</span><span class="o">=</span><span class="n">pwv_grid</span><span class="p">,</span> <span class="n">ozone_grid</span><span class="o">=</span><span class="n">ozone_grid</span><span class="p">,</span> <span class="n">aerosol_grid</span><span class="o">=</span><span class="n">aerosol_grid</span><span class="p">)</span>

        <span class="c1"># the interpolated grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="AtmosphereGrid.set_grid"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid.set_grid">[docs]</a>    <span class="k">def</span> <span class="nf">set_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pwv_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">ozone_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">aerosol_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Set the size of the simulation grid self.atmgrid before compute it.</span>

<span class="sd">        The first column of self.atmgrid will contain the wavelengths set by parameters.LAMBDAS,</span>
<span class="sd">        the other columns the future simulations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pwv_grid: list</span>
<span class="sd">            List of 3 numbers for the PWV quantity: min, max, number of simulations (default: [0, 10, 10]).</span>
<span class="sd">        ozone_grid: list</span>
<span class="sd">            List of 3 numbers for the ozone quantity: min, max, number of simulations (default: [100, 700, 7]).</span>
<span class="sd">        aerosol_grid: list</span>
<span class="sd">            List of 3 numbers for the aerosol quantity: min, max, number of simulations (default: [0, 0.1, 10]).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># aerosols</span>
        <span class="n">NB_AER_POINTS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">aerosol_grid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">AER_MIN</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">aerosol_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">AER_MAX</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">aerosol_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># ozone</span>
        <span class="n">NB_OZ_POINTS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ozone_grid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">OZ_MIN</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ozone_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">OZ_MAX</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ozone_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># pwv</span>
        <span class="n">NB_PWV_POINTS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pwv_grid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">PWV_MIN</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pwv_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">PWV_MAX</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pwv_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># definition of the grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">AER_MIN</span><span class="p">,</span> <span class="n">AER_MAX</span><span class="p">,</span> <span class="n">NB_AER_POINTS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">OZ_MIN</span><span class="p">,</span> <span class="n">OZ_MAX</span><span class="p">,</span> <span class="n">NB_OZ_POINTS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">PWV_MIN</span><span class="p">,</span> <span class="n">PWV_MAX</span><span class="p">,</span> <span class="n">NB_PWV_POINTS</span><span class="p">)</span>

        <span class="c1"># total number of points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_POINTS</span> <span class="o">=</span> <span class="n">NB_AER_POINTS</span> <span class="o">*</span> <span class="n">NB_OZ_POINTS</span> <span class="o">*</span> <span class="n">NB_PWV_POINTS</span>

        <span class="c1"># create the numpy array that will contains the atmospheric grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_POINTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_HEADER</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_DATA</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span></div>

<div class="viewcode-block" id="AtmosphereGrid.compute"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute atmospheric transmissions and fill self.atmgrid.</span>

<span class="sd">        The wavelengths used for the computation are the ones set by parameters.LAMBDAS.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        atmospheric_grid: array_like</span>
<span class="sd">            The atmospheric grid self.atmgrid.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = AtmosphereGrid(image_filename=&#39;tests/data/reduc_20170605_028.fits&#39;,</span>
<span class="sd">        ... pwv_grid=[5, 5, 1], ozone_grid=[400, 400, 1], aerosol_grid=[0.0, 0.1, 2])</span>
<span class="sd">        &gt;&gt;&gt; atmospheric_grid = a.compute()</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(a.atmgrid[0, a.index_atm_data:], parameters.LAMBDAS))</span>
<span class="sd">        &gt;&gt;&gt; assert not np.any(np.isclose(a.atmgrid[1, a.index_atm_data:], np.zeros_like(parameters.LAMBDAS), rtol=1e-6))</span>
<span class="sd">        &gt;&gt;&gt; assert a.atmgrid.shape == (3, a.index_atm_data+len(parameters.LAMBDAS))</span>
<span class="sd">        &gt;&gt;&gt; a.save_file(a.image_filename.replace(&#39;.fits&#39;, &#39;_atmsim.fits&#39;))</span>
<span class="sd">        &gt;&gt;&gt; a.plot_transmission()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first determine the length</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Atmosphere simulations for z=</span><span class="si">{self.airmass:4.2f}</span><span class="s1">, P=</span><span class="si">{self.pressure:4.2f}</span><span class="s1">hPa, &#39;</span>
                                <span class="n">f</span><span class="s1">&#39;T=</span><span class="si">{self.temperature:4.2f}</span><span class="s1">$\degree$C, for data-file=</span><span class="si">{self.image_filename}</span><span class="s1"> &#39;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">aer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pwv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">oz</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># fills headers info in the numpy array</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_aer</span><span class="p">]</span> <span class="o">=</span> <span class="n">aer</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_pwv</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwv</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_oz</span><span class="p">]</span> <span class="o">=</span> <span class="n">oz</span>
                    <span class="n">transmission</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AtmosphereGrid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">oz</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aer</span><span class="p">)</span>
                    <span class="n">transm</span> <span class="o">=</span> <span class="n">transmission</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">=</span> <span class="n">transm</span>  <span class="c1"># each of atmospheric spectrum</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span></div>

<div class="viewcode-block" id="AtmosphereGrid.plot_transmission"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid.plot_transmission">[docs]</a>    <span class="k">def</span> <span class="nf">plot_transmission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the atmospheric transmission contained in the grid.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = AtmosphereGrid(image_filename=&#39;tests/data/reduc_20170605_028.fits&#39;,</span>
<span class="sd">        ... pwv_grid=[5, 5, 1], ozone_grid=[400, 400, 1], aerosol_grid=[0.0, 0.1, 2])</span>
<span class="sd">        &gt;&gt;&gt; atmospheric_grid = a.compute()</span>
<span class="sd">        &gt;&gt;&gt; a.plot_transmission()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;PWV=</span><span class="si">{self.atmgrid[int(count), self.index_atm_pwv]}</span><span class="s1"> &#39;</span> \
                    <span class="n">f</span><span class="s1">&#39;OZ=</span><span class="si">{self.atmgrid[int(count), self.index_atm_oz]}</span><span class="s1"> &#39;</span> \
                    <span class="n">f</span><span class="s1">&#39;VAOD=</span><span class="si">{self.atmgrid[int(count), self.index_atm_aer]}</span><span class="s1">&#39;</span>
            <span class="n">plot_transmission_simple</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:],</span>
                                     <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Atmospheric grid&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtmosphereGrid.plot_transmission_image"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid.plot_transmission_image">[docs]</a>    <span class="k">def</span> <span class="nf">plot_transmission_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the atmospheric transmission contained in the grid using imshow.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = AtmosphereGrid(filename=&#39;tests/data/reduc_20170530_134_atmsim.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a.plot_transmission_image()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Simulation number&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot; Atmospheric variations&quot;</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Atmospheric transmission&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="AtmosphereGrid.save_file"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid.save_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the atmospheric grid in a fits file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: str</span>
<span class="sd">            The output file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">No file name is given...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ATMSIM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;libradtran&quot;</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SIMVERS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2.0.1&quot;</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_filename</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SIMUFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PRESSURE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TEMPERAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBATMPTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_POINTS</span>

            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBAERPTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span><span class="o">.</span><span class="n">size</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AERMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AERMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBPWVPTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span><span class="o">.</span><span class="n">size</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PWVMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PWVMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBOZPTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span><span class="o">.</span><span class="n">size</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OZMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OZMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AER_PTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span><span class="p">)</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PWV_PTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span><span class="p">)</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OZ_PTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span><span class="p">)</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBWLBIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="o">.</span><span class="n">size</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;WLMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;WLMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span>

            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_CNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_count</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_AER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_aer</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_PWV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_pwv</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_OZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_oz</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_DATA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span>

            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Atmosphere.save atm-file=</span><span class="si">{self.filename}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AtmosphereGrid.load_file"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid.load_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the atmospheric grid from a fits file and interpolate across the points</span>
<span class="sd">        using RegularGridInterpolator. Automatically called from __init__.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: str</span>
<span class="sd">            The input file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">No file name is given...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">hdr</span>

            <span class="c1"># hdr[&#39;ATMSIM&#39;] = &quot;libradtran&quot;</span>
            <span class="c1"># hdr[&#39;SIMVERS&#39;] = &quot;2.0.1&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_filename</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]</span>
            <span class="c1"># hdr[&#39;SIMUFILE&#39;]=os.path.basename(self.file_name)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PRESSURE&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TEMPERAT&#39;</span><span class="p">]</span>

            <span class="c1"># hope those are the same parameters : TBD !!!!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_POINTS</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBATMPTS&#39;</span><span class="p">]</span>

            <span class="n">NB_AER_POINTS</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBAERPTS&#39;</span><span class="p">]</span>
            <span class="n">AER_MIN</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AERMIN&#39;</span><span class="p">]</span>
            <span class="n">AER_MAX</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AERMAX&#39;</span><span class="p">]</span>

            <span class="n">NB_PWV_POINTS</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBPWVPTS&#39;</span><span class="p">]</span>
            <span class="n">PWV_MIN</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PWVMIN&#39;</span><span class="p">]</span>
            <span class="n">PWV_MAX</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PWVMAX&#39;</span><span class="p">]</span>

            <span class="n">NB_OZ_POINTS</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBOZPTS&#39;</span><span class="p">]</span>
            <span class="n">OZ_MIN</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OZMIN&#39;</span><span class="p">]</span>
            <span class="n">OZ_MAX</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;OZMAX&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">AER_MIN</span><span class="p">,</span> <span class="n">AER_MAX</span><span class="p">,</span> <span class="n">NB_AER_POINTS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">OZ_MIN</span><span class="p">,</span> <span class="n">OZ_MAX</span><span class="p">,</span> <span class="n">NB_OZ_POINTS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">PWV_MIN</span><span class="p">,</span> <span class="n">PWV_MAX</span><span class="p">,</span> <span class="n">NB_PWV_POINTS</span><span class="p">)</span>

            <span class="n">NBWLBINS</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBWLBIN&#39;</span><span class="p">]</span>
            <span class="c1"># WLMIN = hdr[&#39;WLMIN&#39;]</span>
            <span class="c1"># WLMAX = hdr[&#39;WLMAX&#39;]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_count</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_CNT&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_aer</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_AER&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_pwv</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_PWV&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_oz</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_OZ&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;IDX_DATA&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_POINTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NB_ATM_HEADER</span> <span class="o">+</span> <span class="n">NBWLBINS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Atmosphere.load_image atm-file=</span><span class="si">{self.filename}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># interpolate the grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OZ_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PWV_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AER_Points</span><span class="p">),</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NB_AER_POINTS</span><span class="p">,</span> <span class="n">NB_PWV_POINTS</span><span class="p">,</span>
                                                               <span class="n">NB_OZ_POINTS</span><span class="p">,</span>
                                                               <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="AtmosphereGrid.simulate"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.AtmosphereGrid.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolate from the atmospheric grid to get the atmospheric transmission.</span>

<span class="sd">        First ozone, second pwv, last aerosols, to respect order of loops when generating the grid</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ozone: float</span>
<span class="sd">            Ozone quantity in Dobson</span>
<span class="sd">        pwv: float</span>
<span class="sd">            Precipitable Water Vapor quantity in mm</span>
<span class="sd">        aerosols: float</span>
<span class="sd">            VAOD Vertical Aerosols Optical Depth</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; a = AtmosphereGrid(filename=&#39;tests/data/reduc_20170530_134_atmsim.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; lambdas = np.arange(200, 1200)</span>
<span class="sd">        &gt;&gt;&gt; fig = plt.figure()</span>
<span class="sd">        &gt;&gt;&gt; for pwv in np.arange(5):</span>
<span class="sd">        ...     transmission = a.simulate(ozone=400, pwv=pwv, aerosols=0.05)</span>
<span class="sd">        ...     plot_transmission_simple(plt.gca(), lambdas, transmission(lambdas),</span>
<span class="sd">        ...     title=a.title, label=a.label)</span>
<span class="sd">        &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwv</span> <span class="o">=</span> <span class="n">pwv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ozone</span> <span class="o">=</span> <span class="n">ozone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aerosols</span> <span class="o">=</span> <span class="n">aerosols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_label</span><span class="p">()</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">ozone</span> <span class="o">*</span> <span class="n">ones</span><span class="p">,</span> <span class="n">pwv</span> <span class="o">*</span> <span class="n">ones</span><span class="p">,</span> <span class="n">aerosols</span> <span class="o">*</span> <span class="n">ones</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">atm</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span></div></div>


<div class="viewcode-block" id="TelescopeTransmission"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.TelescopeTransmission">[docs]</a><span class="k">class</span> <span class="nc">TelescopeTransmission</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transmission of the telescope as product of the following transmissions:</span>
<span class="sd">        </span>
<span class="sd">        - mirrors</span>
<span class="sd">        - throughput</span>
<span class="sd">        - quantum efficiency</span>
<span class="sd">        - Filter</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filter_name: str, optional</span>
<span class="sd">            The filter string name.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; t = TelescopeTransmission()</span>
<span class="sd">        &gt;&gt;&gt; t.plot_transmission()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_transmission</span><span class="p">()</span>

<div class="viewcode-block" id="TelescopeTransmission.load_transmission"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.TelescopeTransmission.load_transmission">[docs]</a>    <span class="k">def</span> <span class="nf">load_transmission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the transmission files and make a function.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        transmission: callable</span>
<span class="sd">            The transmission function using wavelengths in nm.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; t = TelescopeTransmission()</span>
<span class="sd">        &gt;&gt;&gt; assert t.transmission is not None</span>
<span class="sd">        &gt;&gt;&gt; assert t.transmission_err is not None</span>
<span class="sd">        &gt;&gt;&gt; t.plot_transmission()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        # QE</span>
<span class="sd">        wl,qe=ctio.load_quantum_efficiency(datapath)</span>
<span class="sd">        self.qe=interp1d(wl,qe,kind=&#39;linear&#39;,bounds_error=False,fill_value=0.)</span>

<span class="sd">        #  Throughput</span>
<span class="sd">        wl,trt=ctio.load_telescope_throughput(datapath)</span>
<span class="sd">        self.to=interp1d(wl,trt,kind=&#39;linear&#39;,bounds_error=False,fill_value=0.)</span>

<span class="sd">        # Mirrors</span>
<span class="sd">        wl,trm=ctio.load_mirror_reflectivity(datapath)</span>
<span class="sd">        self.tm=interp1d(wl,trm,kind=&#39;linear&#39;,bounds_error=False,fill_value=0.)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">throughput</span> <span class="o">=</span> <span class="n">Throughput</span><span class="p">()</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">trm</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">throughput</span><span class="o">.</span><span class="n">load_total_throughput</span><span class="p">()</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">trm</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">parameters</span><span class="o">.</span><span class="n">OBS_TRANSMISSION_SYSTEMATICS</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">to_err</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># Filter RG715</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">trg</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">throughput</span><span class="o">.</span><span class="n">load_RG715</span><span class="p">()</span>
        <span class="n">tfr</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">trg</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># Filter FGB37</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">trb</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">throughput</span><span class="o">.</span><span class="n">load_FGB37</span><span class="p">()</span>
        <span class="n">tfb</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">trb</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s2">&quot;RG715&quot;</span><span class="p">:</span>
            <span class="n">TF</span> <span class="o">=</span> <span class="n">tfr</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s2">&quot;FGB37&quot;</span><span class="p">:</span>
            <span class="n">TF</span> <span class="o">=</span> <span class="n">tfb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TF</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">tf</span> <span class="o">=</span> <span class="n">TF</span>

        <span class="c1"># self.transmission=lambda x: self.qe(x)*self.to(x)*(self.tm(x)**2)*self.tf(x)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission_err</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">to_err</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span></div>

<div class="viewcode-block" id="TelescopeTransmission.plot_transmission"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.TelescopeTransmission.plot_transmission">[docs]</a>    <span class="k">def</span> <span class="nf">plot_transmission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the transmission function and the associated uncertainties.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; t = TelescopeTransmission()</span>
<span class="sd">        &gt;&gt;&gt; t.plot_transmission()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plot_transmission_simple</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">),</span>
                                 <span class="n">uncertainties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transmission_err</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SpectrumSimulation"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulation">[docs]</a><span class="k">class</span> <span class="nc">SpectrumSimulation</span><span class="p">(</span><span class="n">Spectrum</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class to simulate cross spectrum.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spectrum: Spectrum</span>
<span class="sd">            Spectrum instance to load main properties before simulation.</span>
<span class="sd">        atmosphere: Atmosphere</span>
<span class="sd">            Atmosphere or AtmosphereGrid instance to make the atmospheric simulation.</span>
<span class="sd">        telescope: TelescopeTransmission</span>
<span class="sd">            Telescope transmission.</span>
<span class="sd">        disperser: Grating</span>
<span class="sd">            Disperser instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Spectrum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">disperser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">atmosphere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<div class="viewcode-block" id="SpectrumSimulation.simulate_without_atmosphere"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulation.simulate_without_atmosphere">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_without_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the spectrum of an object and its uncertainties</span>
<span class="sd">        after its transmission throught the instrument except the atmosphere.</span>
<span class="sd">        The units remains the ones of the Target instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lambdas: array_like</span>
<span class="sd">            The wavelength array in nm</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        spectrum: array_like</span>
<span class="sd">            The spectrum in Target units.</span>
<span class="sd">        spectrum_err: array_like</span>
<span class="sd">            The spectrum uncertainties in Target units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">sed</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># self.data *= self.lambdas*self.lambdas_binwidths</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span></div>

<div class="viewcode-block" id="SpectrumSimulation.simulate"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulation.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">reso</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate the cross spectrum of an object and its uncertainties</span>
<span class="sd">        after its transmission throught the instrument and the atmosphere.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        A1: float</span>
<span class="sd">            Global amplitude of the spectrum (default: 1).</span>
<span class="sd">        A2: float</span>
<span class="sd">            Relative amplitude of the order 2 spectrum contamination (default: 0).</span>
<span class="sd">        ozone: float</span>
<span class="sd">            Ozone quantity in Dobson</span>
<span class="sd">        pwv: float</span>
<span class="sd">            Precipitable Water Vapor quantity in mm</span>
<span class="sd">        aerosols: float</span>
<span class="sd">            VAOD Vertical Aerosols Optical Depth</span>
<span class="sd">        reso: float</span>
<span class="sd">            Gaussian kernel size for the convolution (default: 0).</span>
<span class="sd">        D: float</span>
<span class="sd">            Distance between the CCD and the disperser in mm (default: parameters.DISTANCE2CCD)</span>
<span class="sd">        shift: float</span>
<span class="sd">            Shift in pixels of the order 0 position estimate (default: 0).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lambdas: array_like</span>
<span class="sd">            The wavelength array in nm used for the interpolation.</span>
<span class="sd">        spectrum: callable</span>
<span class="sd">            The spectrum interpolated function in Target units.</span>
<span class="sd">        spectrum_err: array_like</span>
<span class="sd">            The spectrum uncertainties interpolated function in Target units.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift</span>
        <span class="n">new_x0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulate_without_atmosphere</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">atmospheric_transmission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">)(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="c1"># np.savetxt(&#39;atmospheric_transmission_20170530_130.txt&#39;, np.array([lambdas, atmospheric_transmission(lambdas)]).T)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">atmospheric_transmission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">*=</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">atmospheric_transmission</span>
        <span class="c1"># Now add the systematics</span>
        <span class="k">if</span> <span class="n">reso</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fftconvolve_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">reso</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftconvolve_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reso</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">A2</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">sim_conv</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">err_conv</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sim_conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">sim_conv</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">err_conv</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">err_conv</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="c1"># now we include effects related to the wrong extraction of the spectrum:</span>
        <span class="c1"># wrong estimation of the order 0 position and wrong DISTANCE2CCD</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span></div></div>


<div class="viewcode-block" id="SpectrogramModel"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel">[docs]</a><span class="k">class</span> <span class="nc">SpectrogramModel</span><span class="p">(</span><span class="n">Spectrum</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class to simulate a spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spectrum: Spectrum</span>
<span class="sd">            Spectrum instance to load main properties before simulation.</span>
<span class="sd">        atmosphere: Atmosphere</span>
<span class="sd">            Atmosphere or AtmosphereGrid instance to make the atmospheric simulation.</span>
<span class="sd">        telescope: TelescopeTransmission</span>
<span class="sd">            Telescope transmission.</span>
<span class="sd">        disperser: Grating</span>
<span class="sd">            Disperser instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Spectrum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">disperser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">atmosphere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixels_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixels_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">Ny</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_spectrum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_psf_cube</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="SpectrogramModel.simulate_spectrum"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate the spectrum of the object and return the result in Target units.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lambdas: array_like</span>
<span class="sd">            The wavelength array in nm.</span>
<span class="sd">        ozone: float</span>
<span class="sd">            Ozone quantity in Dobson</span>
<span class="sd">        pwv: float</span>
<span class="sd">            Precipitable Water Vapor quantity in mm</span>
<span class="sd">        aerosols: float</span>
<span class="sd">            VAOD Vertical Aerosols Optical Depth</span>
<span class="sd">        shift_t: float</span>
<span class="sd">            Shift of the transmission in nm (default: 0).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        spectrum: array_like</span>
<span class="sd">            The spectrum array in Target units.</span>
<span class="sd">        spectrum_err: array_like</span>
<span class="sd">            The spectrum uncertainty array in Target units.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spectrum_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">sed</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="n">shift_t</span><span class="p">)</span>
        <span class="n">telescope_transmission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="n">shift_t</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">*=</span> <span class="n">telescope_transmission</span>
        <span class="n">spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">)(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">spectrum_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">telescope_transmission</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spectrum_err</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">telescope_transmission</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># fig = plt.figure()</span>
        <span class="c1"># plt.plot(lambdas, spectrum/np.max(spectrum), label=&quot;spec&quot;)</span>
        <span class="c1"># plt.plot(lambdas, telescope_transmission/np.max(telescope_transmission), label=&quot;transmission&quot;)</span>
        <span class="c1"># plt.plot(lambdas, self.disperser.transmission(lambdas-shift_t), label=&quot;disperser trans&quot;)</span>
        <span class="c1"># plt.legend()</span>
        <span class="c1"># plt.show()</span>
        <span class="k">return</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">spectrum_err</span></div>

<div class="viewcode-block" id="SpectrogramModel.simulate_psf"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate_psf">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_poly_params_to_profile_params</span><span class="p">(</span><span class="n">psf_poly_params</span><span class="p">,</span> <span class="n">force_positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">fill_table_with_profile_params</span><span class="p">(</span><span class="n">profile_params</span><span class="p">)</span>
        <span class="c1"># self.chromatic_psf.from_profile_params_to_shape_params(profile_params)</span>
        <span class="c1"># self.chromatic_psf.table[&#39;Dx&#39;] = np.arange(self.spectrogram_Nx) - self.spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">])</span>
        <span class="c1"># derotate</span>
        <span class="c1"># self.my_logger.warning(f&quot;\n\tbefore\n {self.chromatic_psf.table[[&#39;Dx_rot&#39;, &#39;Dx&#39;, &#39;Dy&#39;, &#39;Dy_mean&#39;]][:5]} {angle}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">rotate_table</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">)</span></div>
        <span class="c1"># self.my_logger.warning(f&quot;\n\tafter\n {self.chromatic_psf.table[[&#39;Dx_rot&#39;, &#39;Dx&#39;, &#39;Dy&#39;, &#39;Dy_mean&#39;]][:5]}  {angle}&quot;)</span>

<div class="viewcode-block" id="SpectrogramModel.simulate_dispersion"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate_dispersion">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">r0</span><span class="p">):</span>
        <span class="n">new_x0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">]</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">get_distance_along_dispersion_axis</span><span class="p">(</span><span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lambdas_order2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">lambdas_order2</span> <span class="o">=</span> <span class="n">lambdas_order2</span><span class="p">[</span><span class="n">lambdas_order2</span> <span class="o">&gt;</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span><span class="p">]</span>

        <span class="n">distances_order2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_lambda_to_pixel</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Dx_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">Dy_mean_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">dy_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">],</span>
                           <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">dispersion_law</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span>
        <span class="n">dispersion_law_order2</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="p">(</span><span class="n">Dx_func</span><span class="p">(</span><span class="n">lambdas_order2</span><span class="p">)</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">Dy_mean_func</span><span class="p">(</span><span class="n">lambdas_order2</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy_func</span><span class="p">(</span><span class="n">lambdas_order2</span><span class="p">)</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">,</span> <span class="n">dispersion_law_order2</span></div>

<div class="viewcode-block" id="SpectrogramModel.simulate"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span>
                 <span class="n">shift_x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        A1</span>
<span class="sd">        A2</span>
<span class="sd">        ozone</span>
<span class="sd">        pwv</span>
<span class="sd">        aerosols</span>
<span class="sd">        psf_poly_params</span>
<span class="sd">        D</span>
<span class="sd">        shift_x</span>
<span class="sd">        shift_y</span>
<span class="sd">        angle</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; from spectractor.extractor.psf import  ChromaticPSF1D</span>
<span class="sd">        &gt;&gt;&gt; spectrum, telescope, disperser, target = SimulatorInit(&#39;./tests/data/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; airmass = spectrum.header[&#39;AIRMASS&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pressure = spectrum.header[&#39;OUTPRESS&#39;]</span>
<span class="sd">        &gt;&gt;&gt; temperature = spectrum.header[&#39;OUTTEMP&#39;]</span>
<span class="sd">        &gt;&gt;&gt; atmosphere = Atmosphere(airmass, pressure, temperature)</span>
<span class="sd">        &gt;&gt;&gt; psf_poly_params = spectrum.chromatic_psf.from_table_to_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; spec = SpectrogramModel(spectrum, atmosphere, telescope, disperser)</span>
<span class="sd">        &gt;&gt;&gt; lambdas, data, err = spec.simulate(psf_poly_params=psf_poly_params, angle=spec.rotation_angle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulate_psf</span><span class="p">(</span><span class="n">psf_poly_params</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate PSF: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_x0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_y0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">,</span> <span class="n">dispersion_law_order2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_dispersion</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">r0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate disp: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="p">,</span> <span class="n">spectrum_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">shift_t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate spec: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">nlbda</span> <span class="o">=</span> <span class="n">lambdas</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># PSF cube</span>
        <span class="kn">import</span> <span class="nn">pyfftw</span>
        <span class="n">nima</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">FA</span><span class="o">.</span><span class="n">create_coords</span><span class="p">((</span><span class="n">nima</span><span class="p">,</span> <span class="n">nima</span><span class="p">),</span> <span class="n">starts</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>  <span class="c1"># (ny, nx)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_psf_cube</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlbda</span><span class="p">,</span> <span class="n">nima</span><span class="p">,</span> <span class="n">nima</span><span class="p">))</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">pyfftw</span><span class="o">.</span><span class="n">empty_aligned</span><span class="p">((</span><span class="n">nlbda</span><span class="p">,</span> <span class="n">nima</span><span class="p">,</span> <span class="n">nima</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="n">shape_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PSF2D</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="mi">3</span><span class="p">:]])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlbda</span><span class="p">):</span>
                <span class="n">ima</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">shape_params</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                <span class="n">ima</span> <span class="o">/=</span> <span class="n">ima</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Flux normalization: the flux should go in the spectrum</span>
                <span class="n">cube</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ima</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="o">=</span> <span class="n">cube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Extended image (nima × nlbda) has to be perfecty centered</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="n">nlbda</span><span class="p">)</span>  <span class="c1"># Rectangular minimal embedding</span>
        <span class="n">hcube</span> <span class="o">=</span> <span class="n">FA</span><span class="o">.</span><span class="n">embed_array</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="p">(</span><span class="n">nlbda</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>

        <span class="c1"># Generate slitless-spectroscopy image from Fourier analysis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_psf_cube</span><span class="p">:</span>
            <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="n">fhcube</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">fft_cube</span><span class="p">(</span><span class="n">hcube</span><span class="p">)</span>  <span class="c1"># same shape as hima</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uh</span> <span class="o">=</span> <span class="n">uh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vh</span> <span class="o">=</span> <span class="n">vh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span> <span class="o">=</span> <span class="n">fhcube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uh</span>
            <span class="n">vh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vh</span>
            <span class="n">fhcube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after fourier cube: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_x0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span> \
             <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_y0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span>
        <span class="n">fdima0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">disperse_fcube</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="n">fhcube</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>  <span class="c1"># FT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate after fourier: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Dispersed image (noiseless)</span>
        <span class="n">dima0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ifft_image</span><span class="p">(</span><span class="n">fdima0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate inverse fourier: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Now add the systematics</span>
        <span class="c1"># if reso &gt; 1:</span>
        <span class="c1">#     self.data = fftconvolve_gaussian(self.data, reso)</span>
        <span class="c1">#     self.err = np.sqrt(np.abs(fftconvolve_gaussian(self.err ** 2, reso)))</span>
        <span class="n">dima0_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dima0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A2</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">nlbda_order2</span> <span class="o">=</span> <span class="n">dispersion_law_order2</span><span class="o">.</span><span class="n">size</span>
            <span class="n">fdima0_2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">disperse_fcube</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="n">fhcube</span><span class="p">[</span><span class="o">-</span><span class="n">nlbda_order2</span><span class="p">:],</span> <span class="n">spectrum</span><span class="p">[:</span><span class="n">nlbda_order2</span><span class="p">],</span> <span class="n">dispersion_law_order2</span><span class="p">,</span>
                                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>  <span class="c1"># FT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate after fourier order 2: {time.time()-start}&#39;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dima0_2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ifft_image</span><span class="p">(</span><span class="n">fdima0_2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate inverse fourier order 2: {time.time()-start}&#39;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># sim_conv = interp1d(lambdas, self.data, kind=&quot;linear&quot;, bounds_error=False, fill_value=(0, 0))</span>
            <span class="c1"># err_conv = interp1d(lambdas, self.err, kind=&quot;linear&quot;, bounds_error=False, fill_value=(0, 0))</span>
            <span class="c1"># self.model = lambda x: sim_conv(x) + A2 * sim_conv(x / 2)</span>
            <span class="c1"># self.model_err = lambda x: np.sqrt(np.abs((err_conv(x)) ** 2 + (0.5 * A2 * err_conv(x / 2)) ** 2))</span>
            <span class="c1"># self.data = self.model(lambdas)</span>
            <span class="c1"># self.err = self.model_err(lambdas)</span>
        <span class="c1"># Going to observable spectrum: must convert units (ie multiply by dlambda)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">*</span> <span class="p">(</span><span class="n">dima0</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">dima0_2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_from_flam_to_ADUrate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_bgd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># now we include effects related to the wrong extraction of the spectrum:</span>
        <span class="c1"># wrong estimation of the order 0 position and wrong DISTANCE2CCD</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">get_distance_along_dispersion_axis</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># self.model = interp1d(self.lambdas, self.data, kind=&quot;linear&quot;, bounds_error=False, fill_value=(0, 0))</span>
        <span class="c1"># self.model_err = interp1d(self.lambdas, self.err, kind=&quot;linear&quot;, bounds_error=False, fill_value=(0, 0))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after conclusions: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span></div></div>


<div class="viewcode-block" id="SpectrumSimGrid"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid">[docs]</a><span class="k">class</span> <span class="nc">SpectrumSimGrid</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; SpectrumSim class used to store information and methods</span>
<span class="sd">    relative to spectrum simulation.</span>
<span class="sd">    NEED TO ADAPT THIS CLASS TO THE FULL SIMULATION WITH SYSTEMATICS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">atmgrid</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            filename (:obj:`str`): path to the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">disperser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span> <span class="o">=</span> <span class="n">atmgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">load_spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="SpectrumSimGrid.compute"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">SpectrumSimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="p">)</span>
        <span class="c1"># product of all sed and transmissions except atmosphere</span>
        <span class="n">all_transm</span><span class="p">,</span> <span class="n">all_transm_err</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">simulate_without_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="c1"># copy atmospheric grid parameters into spectra grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">]</span>
        <span class="c1"># Is broadcasting working OK ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">*</span> <span class="n">all_transm</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span></div>

<div class="viewcode-block" id="SpectrumSimGrid.plot_spectra"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.plot_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux [ADU/s]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Spectra for Atmospheric variations&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SpectrumSimGrid.plot_spectra_img"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.plot_spectra_img">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectra_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Simulation number&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Spectra for atmospheric variations&quot;</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Flux [ADU/s]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SpectrumSimGrid.save_spectra"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.save_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">save_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">SPECTRA.save atm-file=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SimulatorInit"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SimulatorInit">[docs]</a><span class="k">def</span> <span class="nf">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorInit</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SIMULATOR initialisation&#39;</span><span class="p">)</span>
    <span class="c1"># Load data spectrum</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># TELESCOPE TRANSMISSION</span>
    <span class="c1"># ------------------------</span>
    <span class="n">telescope</span> <span class="o">=</span> <span class="n">TelescopeTransmission</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Telescope transmission :  ===============&#39;</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">telescope</span><span class="o">.</span><span class="n">plot_transmission</span><span class="p">()</span>

    <span class="c1"># DISPERSER TRANSMISSION</span>
    <span class="c1"># ------------------------</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">disperser</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">disperser</span> <span class="o">=</span> <span class="n">Hologram</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Disperser transmission :  ===============&#39;</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">disperser</span><span class="o">.</span><span class="n">plot_transmission</span><span class="p">()</span>

    <span class="c1"># STAR SPECTRUM</span>
    <span class="c1"># ------------------------</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">target</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">target</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= SED : </span><span class="si">%s</span><span class="s1">  ===============&#39;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">label</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">plot_spectra</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span></div>


<div class="viewcode-block" id="SpectrumSimulatorCore"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulatorCore">[docs]</a><span class="k">def</span> <span class="nf">SpectrumSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">reso</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorCore</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTRUMSIMULATOR core program&#39;</span><span class="p">)</span>
    <span class="c1"># SIMULATE ATMOSPHERE</span>
    <span class="c1"># -------------------</span>
    <span class="n">atmosphere</span> <span class="o">=</span> <span class="n">Atmosphere</span><span class="p">(</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>

    <span class="c1"># SPECTRUM SIMULATION</span>
    <span class="c1"># --------------------</span>
    <span class="n">spectrum_simulation</span> <span class="o">=</span> <span class="n">SpectrumSimulation</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">)</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">reso</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Spectra simulation :  ===============&#39;</span>
        <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">spectrum_simulation</span></div>


<div class="viewcode-block" id="SpectrogramSimulatorCore"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramSimulatorCore">[docs]</a><span class="k">def</span> <span class="nf">SpectrogramSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                             <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                             <span class="n">psf_poly_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorCore</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTROGRAMSIMULATOR core program&#39;</span><span class="p">)</span>
    <span class="c1"># SIMULATE ATMOSPHERE</span>
    <span class="c1"># -------------------</span>

    <span class="n">atmosphere</span> <span class="o">=</span> <span class="n">Atmosphere</span><span class="p">(</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>

    <span class="c1"># SPECTRUM SIMULATION</span>
    <span class="c1"># --------------------</span>
    <span class="n">spectrogram_simulation</span> <span class="o">=</span> <span class="n">SpectrogramModel</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">)</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spectrogram_simulation</span></div>


<div class="viewcode-block" id="SpectrumSimulatorSimGrid"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulatorSimGrid">[docs]</a><span class="k">def</span> <span class="nf">SpectrumSimulatorSimGrid</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outputdir</span><span class="p">,</span> <span class="n">pwv_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">ozone_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
                             <span class="n">aerosol_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorSimGrid</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SIMULATORGRID&#39;</span><span class="p">)</span>
    <span class="c1"># Initialisation</span>
    <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># Set output path</span>
    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">outputdir</span><span class="p">)</span>
    <span class="c1"># extract the basename : simimar as os.path.basename(file)</span>
    <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrasim&#39;</span><span class="p">))</span>
    <span class="n">output_atmfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;atmsim&#39;</span><span class="p">))</span>

    <span class="c1"># SIMULATE ATMOSPHERE GRID</span>
    <span class="c1"># ------------------------</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTPRESS&#39;</span><span class="p">]</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTTEMP&#39;</span><span class="p">]</span>
    <span class="n">atm</span> <span class="o">=</span> <span class="n">AtmosphereGrid</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
    <span class="n">atm</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="n">pwv_grid</span><span class="p">,</span> <span class="n">ozone_grid</span><span class="p">,</span> <span class="n">aerosol_grid</span><span class="p">)</span>

    <span class="c1"># test if file already exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">:</span>
        <span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s2">&quot; atmospheric simulation file </span><span class="si">%s</span><span class="s2"> of size </span><span class="si">%d</span><span class="s2"> already exists, thus load_image it ...&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">output_atmfilename</span><span class="p">,</span> <span class="n">filesize</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">output_atmfilename</span><span class="p">)</span>
        <span class="c1"># libradtran.clean_simulation_directory()</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Atmospheric simulation :  ===============&#39;</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">plot_transmission</span><span class="p">()</span>  <span class="c1"># plot all atm transp profiles</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">plot_transmission_image</span><span class="p">()</span>  <span class="c1"># plot 2D image summary of atm simulations</span>

    <span class="c1"># SPECTRA-GRID</span>
    <span class="c1"># -------------</span>
    <span class="c1"># in any case we re-calculate the spectra in case of change of spectrum function</span>
    <span class="n">spectra</span> <span class="o">=</span> <span class="n">SpectrumSimGrid</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">atm</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">spectragrid</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">spectra</span><span class="o">.</span><span class="n">save_spectra</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Spectra simulation :  ===============&#39;</span>
        <span class="n">spectra</span><span class="o">.</span><span class="n">plot_spectra</span><span class="p">()</span>
        <span class="n">spectra</span><span class="o">.</span><span class="n">plot_spectra_img</span><span class="p">()</span></div>
    <span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="SpectrumSimulator"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulator">[docs]</a><span class="k">def</span> <span class="nf">SpectrumSimulator</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                      <span class="n">reso</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simulator</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTRACTORSIM&#39;</span><span class="p">)</span>
    <span class="c1"># Initialisation</span>
    <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># SIMULATE SPECTRUM</span>
    <span class="c1"># -------------------</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTPRESS&#39;</span><span class="p">]</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTTEMP&#39;</span><span class="p">]</span>

    <span class="n">spectrum_simulation</span> <span class="o">=</span> <span class="n">SpectrumSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span>
                                                <span class="n">temperature</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="n">A2</span><span class="p">,</span> <span class="n">reso</span><span class="o">=</span><span class="n">reso</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span>
                                                <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>

    <span class="c1"># Save the spectrum</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OZONE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ozone</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PWV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwv</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;VAOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aerosols</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RESO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reso</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;X0SHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outputdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">))</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">save_spectrum</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spectrum_simulation</span></div>


<div class="viewcode-block" id="SpectrogramSimulator"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramSimulator">[docs]</a><span class="k">def</span> <span class="nf">SpectrogramSimulator</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                         <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simulator</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTRACTORSIM&#39;</span><span class="p">)</span>
    <span class="c1"># Initialisation</span>
    <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">psf_poly_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Use PSF parameters from _table.csv file.&#39;</span><span class="p">)</span>
        <span class="n">psf_poly_params</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_table_to_poly_params</span><span class="p">()</span>

    <span class="c1"># SIMULATE SPECTRUM</span>
    <span class="c1"># -------------------</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTPRESS&#39;</span><span class="p">]</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTTEMP&#39;</span><span class="p">]</span>

    <span class="n">spectrogram_simulation</span> <span class="o">=</span> <span class="n">SpectrogramSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span>
                                                      <span class="n">temperature</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span>
                                                      <span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span>
                                                      <span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span>
                                                      <span class="n">psf_poly_params</span><span class="o">=</span><span class="n">psf_poly_params</span><span class="p">)</span>

    <span class="c1"># Save the spectrum</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OZONE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ozone</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PWV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwv</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;VAOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aerosols</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;X0SHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_x</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y0SHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_y</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_t</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outputdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">))</span>
    <span class="c1"># spectrogram_simulation.save_spectrum(output_filename, overwrite=True)</span>

    <span class="k">return</span> <span class="n">spectrogram_simulation</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jeremy Neveu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>