

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectractor.simulation.simulator &mdash; Spectractor 1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Spectractor
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/modules.html">spectractor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spectractor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>spectractor.simulation.simulator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectractor.simulation.simulator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">simulator</span>
<span class="sd">=============----</span>

<span class="sd">author : Sylvie Dagoret-Campagne, Jérémy Neveu</span>
<span class="sd">affiliation : LAL/CNRS/IN2P3/FRANCE</span>
<span class="sd">Collaboration : DESC-LSST</span>

<span class="sd">Purpose : Simulate a series of spectra for each experimental spectra measured by auxiliary telescope.</span>
<span class="sd">Structure in parallel to Spectractor.</span>
<span class="sd">For each experimental spectra a fits file image is generated which holds all possible auxiliary telescope spectra</span>
<span class="sd">corresponding to different conditions in aerosols, pwv, and ozone.</span>

<span class="sd">creation date : April 18th</span>
<span class="sd">Last update : July 2018</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">quad</span>

<span class="kn">from</span> <span class="nn">spectractor.extractor.images</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.spectrum</span> <span class="k">import</span> <span class="n">Spectrum</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.dispersers</span> <span class="k">import</span> <span class="n">Hologram</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.targets</span> <span class="k">import</span> <span class="n">Target</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.psf</span> <span class="k">import</span> <span class="n">PSF2DAstropy</span>
<span class="kn">from</span> <span class="nn">spectractor.tools</span> <span class="k">import</span> <span class="n">fftconvolve_gaussian</span><span class="p">,</span> <span class="n">ensure_dir</span><span class="p">,</span> <span class="n">rebin</span>
<span class="kn">from</span> <span class="nn">spectractor.config</span> <span class="k">import</span> <span class="n">set_logger</span>
<span class="kn">from</span> <span class="nn">spectractor.simulation.throughput</span> <span class="k">import</span> <span class="n">TelescopeTransmission</span>
<span class="kn">from</span> <span class="nn">spectractor.simulation.atmosphere</span> <span class="k">import</span> <span class="n">Atmosphere</span><span class="p">,</span> <span class="n">AtmosphereGrid</span>
<span class="kn">import</span> <span class="nn">spectractor.parameters</span> <span class="k">as</span> <span class="nn">parameters</span>

<span class="kn">import</span> <span class="nn">pyfftw</span>


<div class="viewcode-block" id="SpectrumSimulation"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulation">[docs]</a><span class="k">class</span> <span class="nc">SpectrumSimulation</span><span class="p">(</span><span class="n">Spectrum</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class to simulate cross spectrum.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spectrum: Spectrum</span>
<span class="sd">            Spectrum instance to load main properties before simulation.</span>
<span class="sd">        atmosphere: Atmosphere</span>
<span class="sd">            Atmosphere or AtmosphereGrid instance to make the atmospheric simulation.</span>
<span class="sd">        telescope: TelescopeTransmission</span>
<span class="sd">            Telescope transmission.</span>
<span class="sd">        disperser: Grating</span>
<span class="sd">            Disperser instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Spectrum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">disperser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">atmosphere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<div class="viewcode-block" id="SpectrumSimulation.simulate_without_atmosphere"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulation.simulate_without_atmosphere">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_without_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the spectrum of an object and its uncertainties</span>
<span class="sd">        after its transmission throught the instrument except the atmosphere.</span>
<span class="sd">        The units remains the ones of the Target instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lambdas: array_like</span>
<span class="sd">            The wavelength array in nm</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        spectrum: array_like</span>
<span class="sd">            The spectrum in Target units.</span>
<span class="sd">        spectrum_err: array_like</span>
<span class="sd">            The spectrum uncertainties in Target units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">sed</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># self.data *= self.lambdas*self.lambdas_binwidths</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span></div>

<div class="viewcode-block" id="SpectrumSimulation.simulate"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulation.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">reso</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate the cross spectrum of an object and its uncertainties</span>
<span class="sd">        after its transmission throught the instrument and the atmosphere.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        A1: float</span>
<span class="sd">            Global amplitude of the spectrum (default: 1).</span>
<span class="sd">        A2: float</span>
<span class="sd">            Relative amplitude of the order 2 spectrum contamination (default: 0).</span>
<span class="sd">        ozone: float</span>
<span class="sd">            Ozone quantity in Dobson</span>
<span class="sd">        pwv: float</span>
<span class="sd">            Precipitable Water Vapor quantity in mm</span>
<span class="sd">        aerosols: float</span>
<span class="sd">            VAOD Vertical Aerosols Optical Depth</span>
<span class="sd">        reso: float</span>
<span class="sd">            Gaussian kernel size for the convolution (default: 0).</span>
<span class="sd">        D: float</span>
<span class="sd">            Distance between the CCD and the disperser in mm (default: parameters.DISTANCE2CCD)</span>
<span class="sd">        shift: float</span>
<span class="sd">            Shift in pixels of the order 0 position estimate (default: 0).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lambdas: array_like</span>
<span class="sd">            The wavelength array in nm used for the interpolation.</span>
<span class="sd">        spectrum: callable</span>
<span class="sd">            The spectrum interpolated function in Target units.</span>
<span class="sd">        spectrum_err: array_like</span>
<span class="sd">            The spectrum uncertainties interpolated function in Target units.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift</span>
        <span class="n">new_x0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulate_without_atmosphere</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">atmospheric_transmission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">)(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="c1"># np.savetxt(&#39;atmospheric_transmission_20170530_130.txt&#39;, np.array([lambdas, atmospheric_transmission(lambdas)]).T)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">atmospheric_transmission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">*=</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">atmospheric_transmission</span>
        <span class="c1"># Now add the systematics</span>
        <span class="k">if</span> <span class="n">reso</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fftconvolve_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">reso</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fftconvolve_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reso</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">A2</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">sim_conv</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">err_conv</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sim_conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">sim_conv</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">err_conv</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">err_conv</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="c1"># now we include effects related to the wrong extraction of the spectrum:</span>
        <span class="c1"># wrong estimation of the order 0 position and wrong DISTANCE2CCD</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span></div></div>


<div class="viewcode-block" id="SpectrogramModel"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel">[docs]</a><span class="k">class</span> <span class="nc">SpectrogramModel</span><span class="p">(</span><span class="n">Spectrum</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">with_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fast_sim</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class to simulate a spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spectrum: Spectrum</span>
<span class="sd">            Spectrum instance to load main properties before simulation.</span>
<span class="sd">        atmosphere: Atmosphere</span>
<span class="sd">            Atmosphere or AtmosphereGrid instance to make the atmospheric simulation.</span>
<span class="sd">        telescope: TelescopeTransmission</span>
<span class="sd">            Telescope transmission.</span>
<span class="sd">        disperser: Grating</span>
<span class="sd">            Disperser instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Spectrum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">disperser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">atmosphere</span>
        <span class="c1">#self.pixels_x = np.arange(self.chromatic_psf.Nx).astype(int)</span>
        <span class="c1">#self.pixels_y = np.arange(self.chromatic_psf.Ny).astype(int)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_spectrum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_psf_cube</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sim</span> <span class="o">=</span> <span class="n">fast_sim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span> <span class="o">=</span> <span class="n">with_background</span>

<div class="viewcode-block" id="SpectrogramModel.simulate_spectrum"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate the spectrum of the object and return the result in Target units.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lambdas: array_like</span>
<span class="sd">            The wavelength array in nm.</span>
<span class="sd">        ozone: float</span>
<span class="sd">            Ozone quantity in Dobson</span>
<span class="sd">        pwv: float</span>
<span class="sd">            Precipitable Water Vapor quantity in mm</span>
<span class="sd">        aerosols: float</span>
<span class="sd">            VAOD Vertical Aerosols Optical Depth</span>
<span class="sd">        shift_t: float</span>
<span class="sd">            Shift of the transmission in nm (default: 0).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        spectrum: array_like</span>
<span class="sd">            The spectrum array in ADU/s units.</span>
<span class="sd">        spectrum_err: array_like</span>
<span class="sd">            The spectrum uncertainty array in ADU/s units.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">atmosphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_sim</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">sed</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="n">spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="n">shift_t</span><span class="p">)</span>
            <span class="n">telescope_transmission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="n">shift_t</span><span class="p">)</span>
            <span class="n">spectrum</span> <span class="o">*=</span> <span class="n">telescope_transmission</span>
            <span class="n">spectrum</span> <span class="o">*=</span> <span class="n">atmosphere</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="n">spectrum_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">telescope_transmission</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spectrum</span> <span class="o">*=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">FLAM_TO_ADURATE</span> <span class="o">*</span> <span class="n">lambdas</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="n">spectrum_err</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">telescope_transmission</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="n">lbda</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">lbda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">sed</span><span class="p">(</span><span class="n">lbda</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">shift_t</span><span class="p">)</span> \
                       <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">shift_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">atmosphere</span><span class="p">(</span><span class="n">lbda</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">FLAM_TO_ADURATE</span> <span class="o">*</span> <span class="n">quad</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="c1"># fig = plt.figure()</span>
        <span class="c1"># plt.plot(lambdas, spectrum/np.max(spectrum), label=&quot;spec&quot;)</span>
        <span class="c1"># plt.plot(lambdas, telescope_transmission/np.max(telescope_transmission), label=&quot;transmission&quot;)</span>
        <span class="c1"># plt.plot(lambdas, self.disperser.transmission(lambdas-shift_t), label=&quot;disperser trans&quot;)</span>
        <span class="c1"># plt.legend()</span>
        <span class="c1"># plt.show()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span></div>

<div class="viewcode-block" id="SpectrogramModel.simulate_psf"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate_psf">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="p">):</span>
        <span class="n">psf_poly_params_with_saturation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">psf_poly_params</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_saturation</span><span class="p">]])</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_poly_params_to_profile_params</span><span class="p">(</span><span class="n">psf_poly_params_with_saturation</span><span class="p">,</span>
                                                                               <span class="n">force_positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">fill_table_with_profile_params</span><span class="p">(</span><span class="n">profile_params</span><span class="p">)</span>
        <span class="c1"># self.chromatic_psf.from_profile_params_to_shape_params(profile_params)</span>
        <span class="c1"># self.chromatic_psf.table[&#39;Dx&#39;] = np.arange(self.spectrogram_Nx) - self.spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">])</span>
        <span class="c1"># derotate</span>
        <span class="c1"># self.my_logger.warning(f&quot;\n\tbefore\n {self.chromatic_psf.table[[&#39;Dx_rot&#39;, &#39;Dx&#39;, &#39;Dy&#39;, &#39;Dy_mean&#39;]][:5]} {angle}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">rotate_table</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">profile_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_table_to_profile_params</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">plot_summary</span><span class="p">()</span>
        <span class="c1"># self.my_logger.warning(f&quot;\n\tafter\n {self.chromatic_psf.table[[&#39;Dx_rot&#39;, &#39;Dx&#39;, &#39;Dy&#39;, &#39;Dy_mean&#39;]][:5]}  {angle}&quot;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">profile_params</span></div>

<div class="viewcode-block" id="SpectrogramModel.simulate_dispersion"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate_dispersion">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">r0</span><span class="p">):</span>
        <span class="n">new_x0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">]</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">get_distance_along_dispersion_axis</span><span class="p">(</span><span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">))</span>
        <span class="c1"># must have odd size</span>
        <span class="k">if</span> <span class="n">distance</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lambdas_order2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">lambdas_order2</span> <span class="o">=</span> <span class="n">lambdas_order2</span><span class="p">[</span><span class="n">lambdas_order2</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)]</span>
        <span class="n">distances_order2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_lambda_to_pixel</span><span class="p">(</span><span class="n">lambdas_order2</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">new_x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Dx_func = interp1d(lambdas / 2, self.chromatic_psf.table[&#39;Dx&#39;], bounds_error=False, fill_value=(0, 0))</span>
        <span class="c1"># Dy_mean_func = interp1d(lambdas / 2, self.chromatic_psf.table[&#39;Dy_mean&#39;], bounds_error=False, fill_value=(0, 0))</span>
        <span class="c1"># dy_func = interp1d(lambdas / 2, self.chromatic_psf.table[&#39;Dy&#39;] - self.chromatic_psf.table[&#39;Dy_mean&#39;],</span>
        <span class="c1">#                    bounds_error=False, fill_value=(0, 0))</span>
        <span class="c1"># dispersion_law = r0 + (self.chromatic_psf.table[&#39;Dx&#39;] - shift_x) + 1j * (</span>
        <span class="c1">#             self.chromatic_psf.table[&#39;Dy&#39;] - shift_y)</span>
        <span class="c1"># dispersion_law_order2 = r0 + (Dx_func(lambdas_order2) - shift_x) + 1j * (</span>
        <span class="c1">#             Dy_mean_func(lambdas_order2) + dy_func(lambdas_order2) - shift_y)</span>
        <span class="c1"># Dx_func = interp1d(lambdas, self.chromatic_psf.table[&#39;Dx&#39;], bounds_error=False, fill_value=(0, 0))</span>
        <span class="c1"># Dy_mean_func = interp1d(lambdas, self.chromatic_psf.table[&#39;Dy_mean&#39;], bounds_error=False, fill_value=(0, 0))</span>
        <span class="n">dy_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">][:</span><span class="n">distance</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">][:</span><span class="n">distance</span><span class="o">.</span><span class="n">size</span><span class="p">],</span>
                           <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">dispersion_law</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">][:</span><span class="n">distance</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">][:</span><span class="n">distance</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span>
        <span class="n">dispersion_law_order2</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="p">(</span><span class="n">distances_order2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">distances_order2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy_func</span><span class="p">(</span><span class="n">lambdas_order2</span><span class="p">)</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span>
        <span class="n">dispersion_law_order2</span> <span class="o">=</span> <span class="n">dispersion_law_order2</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">lambdas_order2</span> <span class="o">=</span> <span class="n">lambdas_order2</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">][:</span><span class="mi">6</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">][:</span><span class="mi">6</span><span class="p">],</span>
                  <span class="n">dy_func</span><span class="p">(</span><span class="n">lambdas_order2</span><span class="p">)[:</span><span class="mi">6</span><span class="p">])</span>
            <span class="kn">from</span> <span class="nn">spectractor.tools</span> <span class="k">import</span> <span class="n">from_lambda_to_colormap</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="n">r0</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">dispersion_law</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="o">-</span><span class="n">r0</span><span class="o">.</span><span class="n">imag</span> <span class="o">+</span> <span class="n">dispersion_law</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;dispersion_law&quot;</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">from_lambda_to_colormap</span><span class="p">(</span><span class="n">lambdas</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="n">r0</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">dispersion_law_order2</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="o">-</span><span class="n">r0</span><span class="o">.</span><span class="n">imag</span> <span class="o">+</span> <span class="n">dispersion_law_order2</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;dispersion_law_order2&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">from_lambda_to_colormap</span><span class="p">(</span><span class="n">lambdas_order2</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">lambdas_order2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{new_x0}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">,</span> <span class="n">dispersion_law_order2</span></div>

<div class="viewcode-block" id="SpectrogramModel.build_spectrogram"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.build_spectrogram">[docs]</a>    <span class="k">def</span> <span class="nf">build_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_params</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">):</span>
        <span class="c1"># Spectrum units must in ADU/s</span>
        <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span><span class="p">]</span>
        <span class="n">simul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span><span class="p">))</span>
        <span class="n">nlbda</span> <span class="o">=</span> <span class="n">dispersion_law</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># TODO: increase rapidity (multithreading, optimisation...)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nlbda</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># TODO: replace and test  with new PSF2D or chromaticpsf2D</span>
            <span class="n">psf_lambda</span> <span class="o">=</span> <span class="n">PSF2DAstropy</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="o">*</span><span class="n">profile_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">:])</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">PSF2DAstropy</span><span class="o">.</span><span class="n">normalisation</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">profile_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">psf_lambda</span> <span class="o">/=</span> <span class="n">norm</span>
            <span class="c1"># here spectrum is in ADU/s</span>
            <span class="n">psf_lambda</span> <span class="o">*=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">simul</span> <span class="o">+=</span> <span class="n">psf_lambda</span>
        <span class="k">return</span> <span class="n">simul</span></div>

    <span class="c1">#@profile</span>
<div class="viewcode-block" id="SpectrogramModel.simulate"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span>
                 <span class="n">shift_x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        A1</span>
<span class="sd">        A2</span>
<span class="sd">        ozone</span>
<span class="sd">        pwv</span>
<span class="sd">        aerosols</span>
<span class="sd">        psf_poly_params</span>
<span class="sd">        D</span>
<span class="sd">        shift_x</span>
<span class="sd">        shift_y</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; from spectractor.extractor.psf import  ChromaticPSF1D</span>
<span class="sd">        &gt;&gt;&gt; spectrum, telescope, disperser, target = SimulatorInit(&#39;outputs/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; airmass = spectrum.header[&#39;AIRMASS&#39;]</span>
<span class="sd">        &gt;&gt;&gt; pressure = spectrum.header[&#39;OUTPRESS&#39;]</span>
<span class="sd">        &gt;&gt;&gt; temperature = spectrum.header[&#39;OUTTEMP&#39;]</span>
<span class="sd">        &gt;&gt;&gt; atmosphere = Atmosphere(airmass, pressure, temperature)</span>
<span class="sd">        &gt;&gt;&gt; psf_poly_params = spectrum.chromatic_psf.from_table_to_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; spec = SpectrogramModel(spectrum, atmosphere, telescope, disperser, with_background=True)</span>
<span class="sd">        &gt;&gt;&gt; lambdas, data, err = spec.simulate(A2=0, angle=spectrum.rotation_angle, psf_poly_params=psf_poly_params)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">start</span><span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">=</span> <span class="n">angle</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_psf</span><span class="p">(</span><span class="n">psf_poly_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">After psf: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_x0</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_y0</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">,</span> <span class="n">dispersion_law_order2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_dispersion</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">r0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">After dispersion: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="p">,</span> <span class="n">spectrum_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">After spectrum: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">ima1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_spectrogram</span><span class="p">(</span><span class="n">profile_params</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">After build ima1: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Add order 2</span>
        <span class="n">ima2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ima1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A2</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">nlbda_order2</span> <span class="o">=</span> <span class="n">dispersion_law_order2</span><span class="o">.</span><span class="n">size</span>
            <span class="n">ima2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_spectrogram</span><span class="p">(</span><span class="n">profile_params</span><span class="p">[</span><span class="o">-</span><span class="n">nlbda_order2</span><span class="p">:],</span> <span class="n">spectrum</span><span class="p">[:</span><span class="n">nlbda_order2</span><span class="p">],</span> <span class="n">dispersion_law_order2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">After build ima2: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># self.data is in ADU/s units here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">*</span> <span class="p">(</span><span class="n">ima1</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">ima2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_bgd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">After all: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_bgd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span></div>

<div class="viewcode-block" id="SpectrogramModel.simulate_FFT"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramModel.simulate_FFT">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_FFT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span>
                 <span class="n">shift_x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        A1</span>
<span class="sd">        A2</span>
<span class="sd">        ozone</span>
<span class="sd">        pwv</span>
<span class="sd">        aerosols</span>
<span class="sd">        psf_poly_params</span>
<span class="sd">        D</span>
<span class="sd">        shift_x</span>
<span class="sd">        shift_y</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        # &gt;&gt;&gt; from spectractor.extractor.psf import  ChromaticPSF1D</span>
<span class="sd">        # &gt;&gt;&gt; spectrum, telescope, disperser, target = SimulatorInit(&#39;outputs/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        # &gt;&gt;&gt; airmass = spectrum.header[&#39;AIRMASS&#39;]</span>
<span class="sd">        # &gt;&gt;&gt; pressure = spectrum.header[&#39;OUTPRESS&#39;]</span>
<span class="sd">        # &gt;&gt;&gt; temperature = spectrum.header[&#39;OUTTEMP&#39;]</span>
<span class="sd">        # &gt;&gt;&gt; atmosphere = Atmosphere(airmass, pressure, temperature)</span>
<span class="sd">        # &gt;&gt;&gt; psf_poly_params = spectrum.chromatic_psf.from_table_to_poly_params()</span>
<span class="sd">        # &gt;&gt;&gt; spec = SpectrogramModel(spectrum, atmosphere, telescope, disperser)</span>
<span class="sd">        # &gt;&gt;&gt; lambdas, data, err = spec.simulate_FFT(psf_poly_params=psf_poly_params)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">slitless.fourier.arrays</span> <span class="k">as</span> <span class="nn">FA</span>
        <span class="kn">import</span> <span class="nn">slitless.fourier.fourier</span> <span class="k">as</span> <span class="nn">F</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">=</span> <span class="n">angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulate_psf</span><span class="p">(</span><span class="n">psf_poly_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate PSF: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># print(self.spectrogram_x0, self.spectrogram_Nx, self.spectrogram_y0, self.spectrogram_Ny, self.spectrogram_xmin,self.spectrogram_ymin)</span>
        <span class="c1"># If nofftshift,use this r0:</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_x0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_y0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Else, this one:</span>
        <span class="c1"># r0 = (self.spectrogram_x0 ) + 1j * (self.spectrogram_y0 )</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">,</span> <span class="n">dispersion_law_order2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_dispersion</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">r0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate disp: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="p">,</span> <span class="n">spectrum_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate spec: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">nlbda</span> <span class="o">=</span> <span class="n">lambdas</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># oversampling of the PSF to avoid Gibbs ringings</span>
        <span class="c1"># rescale_factor must be odd</span>
        <span class="n">rescale_factor</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_sim</span><span class="p">:</span>
            <span class="n">rescale_factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nima</span> <span class="o">=</span> <span class="n">rescale_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">FA</span><span class="o">.</span><span class="n">create_coords</span><span class="p">((</span><span class="n">nima</span><span class="p">,</span> <span class="n">nima</span><span class="p">),</span> <span class="n">starts</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">rescale_factor</span><span class="p">)</span>  <span class="c1"># (ny, nx)</span>

        <span class="c1"># PSF cube</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_psf_cube</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">pyfftw</span><span class="o">.</span><span class="n">zeros_aligned</span><span class="p">((</span><span class="n">nlbda</span><span class="p">,</span> <span class="n">nima</span><span class="p">,</span> <span class="n">nima</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="n">shape_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PSF2D</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="mi">3</span><span class="p">:]])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlbda</span><span class="p">):</span>
                <span class="n">ima</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">shape_params</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="o">.</span><span class="n">normalisation</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">shape_params</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">norm</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">ima</span> <span class="o">/=</span> <span class="n">norm</span>  <span class="c1"># Flux normalization: the flux should go in the spectrum</span>
                <span class="n">cube</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ima</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="o">=</span> <span class="n">cube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span>

        <span class="c1"># Extended image (nima × nlbda) has to be perfecty centered</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="n">rescale_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span><span class="p">)</span>  <span class="c1"># Rectangular minimal embedding</span>
        <span class="n">hcube</span> <span class="o">=</span> <span class="n">FA</span><span class="o">.</span><span class="n">embed_array</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="p">(</span><span class="n">nlbda</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after filling the cube: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Generate slitless-spectroscopy image from Fourier analysis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_psf_cube</span><span class="p">:</span>
            <span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="n">fhcube</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">fft_cube</span><span class="p">(</span><span class="n">hcube</span><span class="p">)</span>  <span class="c1"># same shape as hima</span>
            <span class="n">uh</span> <span class="o">*=</span> <span class="n">rescale_factor</span>
            <span class="n">vh</span> <span class="o">*=</span> <span class="n">rescale_factor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uh</span> <span class="o">=</span> <span class="n">uh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vh</span> <span class="o">=</span> <span class="n">vh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span> <span class="o">=</span> <span class="n">fhcube</span>
            <span class="c1"># print(uh.shape, vh.shape, np.min(self.uh), np.max(self.uh), fhcube.shape, dispersion_law.reshape(-1, 1, 1).shape)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uh</span>
            <span class="n">vh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vh</span>
            <span class="n">fhcube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhcube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after fourier cube: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="c1"># r0 = (self.spectrogram_x0 - self.spectrogram_Nx / 2 - shift_x) \</span>
        <span class="c1">#      + 1j * (self.spectrogram_y0 - self.spectrogram_Ny / 2 - shift_y)</span>
        <span class="n">fdima0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">disperse_fcube</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="n">fhcube</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">dispersion_law</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>  <span class="c1"># FT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate after fourier: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Dispersed image (noiseless)</span>
        <span class="n">dima0</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ifft_image</span><span class="p">(</span><span class="n">fdima0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate inverse fourier: {time.time()-start}&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Now add the systematics</span>
        <span class="c1"># if reso &gt; 1:</span>
        <span class="c1">#     self.data = fftconvolve_gaussian(self.data, reso)</span>
        <span class="c1">#     self.err = np.sqrt(np.abs(fftconvolve_gaussian(self.err ** 2, reso)))</span>
        <span class="n">dima0_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dima0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">A2</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">nlbda_order2</span> <span class="o">=</span> <span class="n">dispersion_law_order2</span><span class="o">.</span><span class="n">size</span>
            <span class="n">fdima0_2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">disperse_fcube</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="n">fhcube</span><span class="p">[</span><span class="o">-</span><span class="n">nlbda_order2</span><span class="p">:],</span> <span class="n">spectrum</span><span class="p">[:</span><span class="n">nlbda_order2</span><span class="p">],</span> <span class="n">dispersion_law_order2</span><span class="p">,</span>
                                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;numexpr&quot;</span><span class="p">)</span>  <span class="c1"># FT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate after fourier order 2: {time.time()-start}&#39;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dima0_2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ifft_image</span><span class="p">(</span><span class="n">fdima0_2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Time after simulate inverse fourier order 2: {time.time()-start}&#39;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># sim_conv = interp1d(lambdas, self.data, kind=&quot;linear&quot;, bounds_error=False, fill_value=(0, 0))</span>
            <span class="c1"># err_conv = interp1d(lambdas, self.err, kind=&quot;linear&quot;, bounds_error=False, fill_value=(0, 0))</span>
            <span class="c1"># self.model = lambda x: sim_conv(x) + A2 * sim_conv(x / 2)</span>
            <span class="c1"># self.model_err = lambda x: np.sqrt(np.abs((err_conv(x)) ** 2 + (0.5 * A2 * err_conv(x / 2)) ** 2))</span>
            <span class="c1"># self.data = self.model(lambdas)</span>
            <span class="c1"># self.err = self.model_err(lambdas)</span>
        <span class="c1"># Going to observable spectrum: must convert units (ie multiply by dlambda)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">*</span> <span class="p">(</span><span class="n">dima0</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">dima0_2</span><span class="p">)</span>
        <span class="c1"># print(self.data.shape)</span>
        <span class="c1"># toto = np.copy(self.data)</span>
        <span class="k">if</span> <span class="n">rescale_factor</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">rebin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span><span class="p">))</span>
        <span class="c1"># plt.plot(np.sum(self.data,axis=0))</span>
        <span class="c1"># plt.plot(np.sum(A1*dima0,axis=0))</span>
        <span class="c1"># plt.plot(np.sum(A1*A2*dima0_2,axis=0))</span>
        <span class="c1"># plt.plot(spectrum)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymin</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="c1"># self.data = self.data[middle-width:middle+width+1, :]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="c1"># self.convert_from_flam_to_ADUrate()</span>
        <span class="c1"># print(self.data.shape, (self.spectrogram_Ny,self.spectrogram_Nx))</span>
        <span class="c1"># fig, ax = plt.subplots(2,1)</span>
        <span class="c1"># ax[0].imshow(self.data, origin=&quot;lower&quot;, aspect=&quot;auto&quot;)</span>
        <span class="c1"># ax[1].imshow(toto, origin=&quot;lower&quot;, aspect=&quot;auto&quot;)</span>
        <span class="c1"># plt.show()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_bgd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span></div></div>



<div class="viewcode-block" id="SpectrumSimGrid"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid">[docs]</a><span class="k">class</span> <span class="nc">SpectrumSimGrid</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; SpectrumSim class used to store information and methods</span>
<span class="sd">    relative to spectrum simulation.</span>
<span class="sd">    NEED TO ADAPT THIS CLASS TO THE FULL SIMULATION WITH SYSTEMATICS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">atmgrid</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            filename (:obj:`str`): path to the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">disperser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span> <span class="o">=</span> <span class="n">atmgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">load_spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="SpectrumSimGrid.compute"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">SpectrumSimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="p">)</span>
        <span class="c1"># product of all sed and transmissions except atmosphere</span>
        <span class="n">all_transm</span><span class="p">,</span> <span class="n">all_transm_err</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">simulate_without_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="c1"># copy atmospheric grid parameters into spectra grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">]</span>
        <span class="c1"># Is broadcasting working OK ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">atmgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:]</span> <span class="o">*</span> <span class="n">all_transm</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span></div>

<div class="viewcode-block" id="SpectrumSimGrid.plot_spectra"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.plot_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_count</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Flux [ADU/s]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Spectra for Atmospheric variations&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SpectrumSimGrid.plot_spectra_img"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.plot_spectra_img">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectra_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmgrid</span><span class="o">.</span><span class="n">index_atm_data</span><span class="p">:],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Simulation number&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Spectra for atmospheric variations&quot;</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Flux [ADU/s]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SpectrumSimGrid.save_spectra"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimGrid.save_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">save_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectragrid</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">SPECTRA.save atm-file=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SimulatorInit"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SimulatorInit">[docs]</a><span class="k">def</span> <span class="nf">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorInit</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SIMULATOR initialisation&#39;</span><span class="p">)</span>
    <span class="c1"># Load data spectrum</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># TELESCOPE TRANSMISSION</span>
    <span class="c1"># ------------------------</span>
    <span class="n">telescope</span> <span class="o">=</span> <span class="n">TelescopeTransmission</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Telescope transmission :  ===============&#39;</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">telescope</span><span class="o">.</span><span class="n">plot_transmission</span><span class="p">()</span>

    <span class="c1"># DISPERSER TRANSMISSION</span>
    <span class="c1"># ------------------------</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">disperser</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">disperser</span> <span class="o">=</span> <span class="n">Hologram</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Disperser transmission :  ===============&#39;</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">disperser</span><span class="o">.</span><span class="n">plot_transmission</span><span class="p">()</span>

    <span class="c1"># STAR SPECTRUM</span>
    <span class="c1"># ------------------------</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">target</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">target</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= SED : </span><span class="si">%s</span><span class="s1">  ===============&#39;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">label</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">plot_spectra</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span></div>


<div class="viewcode-block" id="SpectrumSimulatorCore"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulatorCore">[docs]</a><span class="k">def</span> <span class="nf">SpectrumSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">reso</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorCore</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTRUMSIMULATOR core program&#39;</span><span class="p">)</span>
    <span class="c1"># SIMULATE ATMOSPHERE</span>
    <span class="c1"># -------------------</span>
    <span class="n">atmosphere</span> <span class="o">=</span> <span class="n">Atmosphere</span><span class="p">(</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>

    <span class="c1"># SPECTRUM SIMULATION</span>
    <span class="c1"># --------------------</span>
    <span class="n">spectrum_simulation</span> <span class="o">=</span> <span class="n">SpectrumSimulation</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">)</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">reso</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Spectra simulation :  ===============&#39;</span>
        <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">spectrum_simulation</span></div>


<div class="viewcode-block" id="SpectrogramSimulatorCore"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramSimulatorCore">[docs]</a><span class="k">def</span> <span class="nf">SpectrogramSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                             <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                             <span class="n">psf_poly_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fast_sim</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorCore</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTROGRAMSIMULATOR core program&#39;</span><span class="p">)</span>
    <span class="c1"># SIMULATE ATMOSPHERE</span>
    <span class="c1"># -------------------</span>

    <span class="n">atmosphere</span> <span class="o">=</span> <span class="n">Atmosphere</span><span class="p">(</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">=</span> <span class="n">angle</span>

    <span class="c1"># SPECTRUM SIMULATION</span>
    <span class="c1"># --------------------</span>
    <span class="n">spectrogram_simulation</span> <span class="o">=</span> <span class="n">SpectrogramModel</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">atmosphere</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span>
                                              <span class="n">with_background</span><span class="o">=</span><span class="n">with_background</span><span class="p">,</span> <span class="n">fast_sim</span><span class="o">=</span><span class="n">fast_sim</span><span class="p">)</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spectrogram_simulation</span></div>


<div class="viewcode-block" id="SpectrumSimulatorSimGrid"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulatorSimGrid">[docs]</a><span class="k">def</span> <span class="nf">SpectrumSimulatorSimGrid</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outputdir</span><span class="p">,</span> <span class="n">pwv_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">ozone_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
                             <span class="n">aerosol_grid</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; SimulatorSimGrid</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SIMULATORGRID&#39;</span><span class="p">)</span>
    <span class="c1"># Initialisation</span>
    <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># Set output path</span>
    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">outputdir</span><span class="p">)</span>
    <span class="c1"># extract the basename : simimar as os.path.basename(file)</span>
    <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrasim&#39;</span><span class="p">))</span>
    <span class="n">output_atmfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;atmsim&#39;</span><span class="p">))</span>

    <span class="c1"># SIMULATE ATMOSPHERE GRID</span>
    <span class="c1"># ------------------------</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTPRESS&#39;</span><span class="p">]</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTTEMP&#39;</span><span class="p">]</span>
    <span class="n">atm</span> <span class="o">=</span> <span class="n">AtmosphereGrid</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
    <span class="n">atm</span><span class="o">.</span><span class="n">set_grid</span><span class="p">(</span><span class="n">pwv_grid</span><span class="p">,</span> <span class="n">ozone_grid</span><span class="p">,</span> <span class="n">aerosol_grid</span><span class="p">)</span>

    <span class="c1"># test if file already exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">:</span>
        <span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s2">&quot; atmospheric simulation file </span><span class="si">%s</span><span class="s2"> of size </span><span class="si">%d</span><span class="s2"> already exists, thus load_image it ...&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">output_atmfilename</span><span class="p">,</span> <span class="n">filesize</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">output_atmfilename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">File </span><span class="si">{output_atmfilename}</span><span class="s2"> does not exist yet. Compute it...&quot;</span><span class="p">)</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">output_atmfilename</span><span class="p">)</span>
        <span class="c1"># libradtran.clean_simulation_directory()</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Atmospheric simulation :  ===============&#39;</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostring</span><span class="p">)</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">plot_transmission</span><span class="p">()</span>  <span class="c1"># plot all atm transp profiles</span>
        <span class="n">atm</span><span class="o">.</span><span class="n">plot_transmission_image</span><span class="p">()</span>  <span class="c1"># plot 2D image summary of atm simulations</span>

    <span class="c1"># SPECTRA-GRID</span>
    <span class="c1"># -------------</span>
    <span class="c1"># in any case we re-calculate the spectra in case of change of spectrum function</span>
    <span class="n">spectra</span> <span class="o">=</span> <span class="n">SpectrumSimGrid</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">atm</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">spectragrid</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">spectra</span><span class="o">.</span><span class="n">save_spectra</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">infostring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1"> ========= Spectra simulation :  ===============&#39;</span>
        <span class="n">spectra</span><span class="o">.</span><span class="n">plot_spectra</span><span class="p">()</span>
        <span class="n">spectra</span><span class="o">.</span><span class="n">plot_spectra_img</span><span class="p">()</span></div>
    <span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="SpectrumSimulator"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrumSimulator">[docs]</a><span class="k">def</span> <span class="nf">SpectrumSimulator</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                      <span class="n">reso</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simulator</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTRACTORSIM&#39;</span><span class="p">)</span>
    <span class="c1"># Initialisation</span>
    <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># SIMULATE SPECTRUM</span>
    <span class="c1"># -------------------</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTPRESS&#39;</span><span class="p">]</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTTEMP&#39;</span><span class="p">]</span>

    <span class="n">spectrum_simulation</span> <span class="o">=</span> <span class="n">SpectrumSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span>
                                                <span class="n">temperature</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="n">A2</span><span class="p">,</span> <span class="n">reso</span><span class="o">=</span><span class="n">reso</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span>
                                                <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>

    <span class="c1"># Save the spectrum</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OZONE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ozone</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PWV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwv</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;VAOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aerosols</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RESO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reso</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;X0SHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outputdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">))</span>
    <span class="n">spectrum_simulation</span><span class="o">.</span><span class="n">save_spectrum</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spectrum_simulation</span></div>


<div class="viewcode-block" id="SpectrogramSimulator"><a class="viewcode-back" href="../../../source/spectractor.simulation.html#spectractor.simulation.simulator.SpectrogramSimulator">[docs]</a><span class="k">def</span> <span class="nf">SpectrogramSimulator</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ozone</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">aerosols</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">A1</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">A2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                         <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simulator</span>
<span class="sd">    Main function to evaluate several spectra</span>
<span class="sd">    A grid of spectra will be produced for a given target, airmass and pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start SPECTRACTORSIM&#39;</span><span class="p">)</span>
    <span class="c1"># Initialisation</span>
    <span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">SimulatorInit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">psf_poly_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Use PSF parameters from _table.csv file.&#39;</span><span class="p">)</span>
        <span class="n">psf_poly_params</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_table_to_poly_params</span><span class="p">()</span>

    <span class="c1"># SIMULATE SPECTRUM</span>
    <span class="c1"># -------------------</span>
    <span class="n">airmass</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTPRESS&#39;</span><span class="p">]</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTTEMP&#39;</span><span class="p">]</span>

    <span class="n">spectrogram_simulation</span> <span class="o">=</span> <span class="n">SpectrogramSimulatorCore</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">disperser</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span>
                                                      <span class="n">temperature</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span>
                                                      <span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="n">shift_x</span><span class="p">,</span>
                                                      <span class="n">shift_y</span><span class="o">=</span><span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="o">=</span><span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span>
                                                      <span class="n">psf_poly_params</span><span class="o">=</span><span class="n">psf_poly_params</span><span class="p">)</span>

    <span class="c1"># Save the spectrum</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OZONE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ozone</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PWV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwv</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;VAOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aerosols</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;X0SHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_x</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y0SHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_y</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_t</span>
    <span class="n">spectrogram_simulation</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outputdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">))</span>
    <span class="c1"># spectrogram_simulation.save_spectrum(output_filename, overwrite=True)</span>

    <span class="k">return</span> <span class="n">spectrogram_simulation</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jeremy Neveu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>