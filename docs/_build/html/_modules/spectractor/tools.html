

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectractor.tools &mdash; Spectractor 1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Spectractor
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/modules.html">spectractor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spectractor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>spectractor.tools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectractor.tools</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="k">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">MaxNLocator</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">fftconvolve</span><span class="p">,</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">import</span> <span class="n">maximum_filter</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.morphology</span> <span class="k">import</span> <span class="n">generate_binary_structure</span><span class="p">,</span> <span class="n">binary_erosion</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">quad</span>

<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="n">hessian_matrix</span>
<span class="kn">from</span> <span class="nn">spectractor.config</span> <span class="k">import</span> <span class="n">set_logger</span>
<span class="kn">from</span> <span class="nn">spectractor</span> <span class="k">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">floor</span>


<div class="viewcode-block" id="gauss"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.gauss">[docs]</a><span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the Gaussian function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array_like</span>
<span class="sd">        Abscisse array to evaluate the function of size Nx.</span>
<span class="sd">    A: float</span>
<span class="sd">        Amplitude of the Gaussian function.</span>
<span class="sd">    x0: float</span>
<span class="sd">        Mean of the Gaussian function.</span>
<span class="sd">    sigma: float</span>
<span class="sd">        Standard deviation of the Gaussian function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m: array_like</span>
<span class="sd">        The Gaussian function evaluated on the x array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(50)</span>
<span class="sd">    &gt;&gt;&gt; y = gauss(x, 10, 25, 3)</span>
<span class="sd">    &gt;&gt;&gt; print(y.shape)</span>
<span class="sd">    (50,)</span>
<span class="sd">    &gt;&gt;&gt; y[25]</span>
<span class="sd">    10.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">))</span></div>


<div class="viewcode-block" id="gauss_jacobian"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.gauss_jacobian">[docs]</a><span class="k">def</span> <span class="nf">gauss_jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the Jacobian matrix of the Gaussian function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array_like</span>
<span class="sd">        Abscisse array to evaluate the function of size Nx.</span>
<span class="sd">    A: float</span>
<span class="sd">        Amplitude of the Gaussian function.</span>
<span class="sd">    x0: float</span>
<span class="sd">        Mean of the Gaussian function.</span>
<span class="sd">    sigma: float</span>
<span class="sd">        Standard deviation of the Gaussian function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m: array_like</span>
<span class="sd">        The Jacobian matrix of size 3 x Nx.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(50)</span>
<span class="sd">    &gt;&gt;&gt; jac = gauss_jacobian(x, 10, 25, 3)</span>
<span class="sd">    &gt;&gt;&gt; print(jac.shape)</span>
<span class="sd">    (50, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dA</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">/</span> <span class="n">A</span>
    <span class="n">dx0</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">dA</span>
    <span class="n">dsigma</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">dA</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dA</span><span class="p">,</span> <span class="n">dx0</span><span class="p">,</span> <span class="n">dsigma</span><span class="p">])</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="line"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.line">[docs]</a><span class="k">def</span> <span class="nf">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span></div>


<span class="c1"># noinspection PyTypeChecker</span>
<div class="viewcode-block" id="fit_gauss"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_gauss">[docs]</a><span class="k">def</span> <span class="nf">fit_gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a Gaussian profile to data, using curve_fit. The mean guess value of the Gaussian</span>
<span class="sd">    must not be far from the truth values. Boundaries helps a lot also.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: np.array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    guess: list, [amplitude, mean, sigma], optional</span>
<span class="sd">        List of first guessed values for the Gaussian fit (default: [10, 1000, 1]).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        List of boundaries for the parameters [[minima],[maxima]] (default: (-np.inf, np.inf)).</span>
<span class="sd">    sigma: np.array, optional</span>
<span class="sd">        The y data uncertainties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    popt: list</span>
<span class="sd">        Best fitting parameters of curve_fit.</span>
<span class="sd">    pcov: list</span>
<span class="sd">        Best fitting parameters covariance matrix from curve_fit.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; x = np.arange(600.,700.,2)</span>
<span class="sd">    &gt;&gt;&gt; p = [10, 650, 10]</span>
<span class="sd">    &gt;&gt;&gt; y = gauss(x, *p)</span>
<span class="sd">    &gt;&gt;&gt; y_err = np.ones_like(y)</span>
<span class="sd">    &gt;&gt;&gt; print(y[25])</span>
<span class="sd">    10.0</span>
<span class="sd">    &gt;&gt;&gt; guess = (2,630,2)</span>
<span class="sd">    &gt;&gt;&gt; popt, pcov = fit_gauss(x, y, guess=guess, bounds=((1,600,1),(100,700,100)), sigma=y_err)</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p,popt))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>  <span class="n">tr_solver</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">gauss_jacobian</span><span class="p">,</span>
                           <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;dogbox&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<div class="viewcode-block" id="multigauss_and_line"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.multigauss_and_line">[docs]</a><span class="k">def</span> <span class="nf">multigauss_and_line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiple Gaussian profile plus a straight line to data.</span>
<span class="sd">    The order of the parameters is line slope, line intercept,</span>
<span class="sd">    and then block of 3 parameters for the Gaussian profiles like amplitude, mean and standard</span>
<span class="sd">    deviation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    *params: list of float parameters as described above.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y: array</span>
<span class="sd">        The y profile values.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(600.,800.,1)</span>
<span class="sd">    &gt;&gt;&gt; y = multigauss_and_line(x, 1, 10, 20, 650, 3, 40, 750, 10)</span>
<span class="sd">    &gt;&gt;&gt; print(y[0])</span>
<span class="sd">    610.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">k</span><span class="p">:</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># noinspection PyTypeChecker</span>
<div class="viewcode-block" id="fit_multigauss_and_line"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_multigauss_and_line">[docs]</a><span class="k">def</span> <span class="nf">fit_multigauss_and_line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Fit a multiple Gaussian profile plus a straight line to data, using curve_fit.</span>
<span class="sd">    The mean guess value of the Gaussian must not be far from the truth values.</span>
<span class="sd">    Boundaries helps a lot also. The order of the parameters is line slope, line intercept,</span>
<span class="sd">    and then block of 3 parameters for the Gaussian profiles like amplitude, mean and standard</span>
<span class="sd">    deviation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    guess: list, [slope, intercept, amplitude, mean, sigma]</span>
<span class="sd">        List of first guessed values for the Gaussian fit (default: [0, 1, 10, 1000, 1]).</span>
<span class="sd">    bounds: 2D-list</span>
<span class="sd">        List of boundaries for the parameters [[minima],[maxima]] (default: (-np.inf, np.inf)).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    popt: list</span>
<span class="sd">        Best fitting parameters of curve_fit.</span>
<span class="sd">    pcov: 2D-list</span>
<span class="sd">        Best fitting parameters covariance matrix from curve_fit.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(600.,800.,1)</span>
<span class="sd">    &gt;&gt;&gt; y = multigauss_and_line(x, 1, 10, 20, 650, 3, 40, 750, 10)</span>
<span class="sd">    &gt;&gt;&gt; print(y[0])</span>
<span class="sd">    610.0</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((-np.inf,-np.inf,1,600,1,1,600,1),(np.inf,np.inf,100,800,100,100,800,100))</span>
<span class="sd">    &gt;&gt;&gt; popt, pcov = fit_multigauss_and_line(x, y, guess=(0,1,3,630,3,3,770,3), bounds=bounds)</span>
<span class="sd">    &gt;&gt;&gt; print(popt)</span>
<span class="sd">    [  1.  10.  20. 650.   3.  40. 750.  10.]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">multigauss_and_line</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<div class="viewcode-block" id="rescale_x_for_legendre"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.rescale_x_for_legendre">[docs]</a><span class="k">def</span> <span class="nf">rescale_x_for_legendre</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">middle</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">x_norm</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">middle</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_norm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_norm</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_norm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_norm</span></div>


<span class="c1"># noinspection PyTypeChecker</span>
<div class="viewcode-block" id="multigauss_and_bgd"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.multigauss_and_bgd">[docs]</a><span class="k">def</span> <span class="nf">multigauss_and_bgd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiple Gaussian profile plus a polynomial background to data.</span>
<span class="sd">    Polynomial function is based on the orthogonal Legendre polynomial basis.</span>
<span class="sd">    The degree of the polynomial background is fixed by parameters.CALIB_BGD_NPARAMS.</span>
<span class="sd">    The order of the parameters is a first block CALIB_BGD_NPARAMS parameters (from low to high Legendre polynome degree,</span>
<span class="sd">    contrary to np.polyval), and then block of 3 parameters for the Gaussian profiles like amplitude, mean and standard</span>
<span class="sd">    deviation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    *params: list of float parameters as described above.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y: array</span>
<span class="sd">        The y profile values.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; parameters.CALIB_BGD_NPARAMS = 4</span>
<span class="sd">    &gt;&gt;&gt; x = np.arange(600., 800., 1)</span>
<span class="sd">    &gt;&gt;&gt; p = [20, 1, -1, -1, 20, 650, 3, 40, 750, 5]</span>
<span class="sd">    &gt;&gt;&gt; y = multigauss_and_bgd(x, *p)</span>
<span class="sd">    &gt;&gt;&gt; print(f&#39;{y[0]:.2f}&#39;)</span>
<span class="sd">    19.00</span>

<span class="sd">    .. plot::</span>

<span class="sd">        import spectractor.parameters as parameters</span>
<span class="sd">        from spectractor.tools import multigauss_and_bgd</span>
<span class="sd">        parameters.CALIB_BGD_NPARAMS = 4</span>
<span class="sd">        x = np.arange(600., 800., 1)</span>
<span class="sd">        p = [20, 1, -1, -1, 20, 650, 3, 40, 750, 5]</span>
<span class="sd">        y = multigauss_and_bgd(x, *p)</span>
<span class="sd">        plt.plot(x,y,&#39;r-&#39;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bgd_nparams</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_BGD_NPARAMS</span>
    <span class="c1"># out = np.polyval(params[0:bgd_nparams], x)</span>
    <span class="n">x_norm</span> <span class="o">=</span> <span class="n">rescale_x_for_legendre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">bgd_nparams</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">bgd_nparams</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="n">bgd_nparams</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">k</span><span class="p">:</span><span class="n">bgd_nparams</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># noinspection PyTypeChecker</span>
<div class="viewcode-block" id="multigauss_and_bgd_jacobian"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.multigauss_and_bgd_jacobian">[docs]</a><span class="k">def</span> <span class="nf">multigauss_and_bgd_jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Jacobien of the multiple Gaussian profile plus a polynomial background to data.</span>
<span class="sd">    The degree of the polynomial background is fixed by parameters.CALIB_BGD_NPARAMS.</span>
<span class="sd">    The order of the parameters is a first block CALIB_BGD_NPARAMS parameters (from low to high Legendre polynome degree,</span>
<span class="sd">    contrary to np.polyval), and then block of 3 parameters for the Gaussian profiles like amplitude, mean and standard</span>
<span class="sd">    deviation. x values are renormalised on the [-1, 1] interval for the background.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    *params: list of float parameters as described above.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    y: array</span>
<span class="sd">        The jacobian values.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import spectractor.parameters as parameters</span>
<span class="sd">    &gt;&gt;&gt; parameters.CALIB_BGD_NPARAMS = 4</span>
<span class="sd">    &gt;&gt;&gt; x = np.arange(600.,800.,1)</span>
<span class="sd">    &gt;&gt;&gt; p = [20, 1, -1, -1, 20, 650, 3, 40, 750, 5]</span>
<span class="sd">    &gt;&gt;&gt; y = multigauss_and_bgd_jacobian(x, *p)</span>
<span class="sd">    &gt;&gt;&gt; assert(np.all(np.isclose(y.T[0],np.ones_like(x))))</span>
<span class="sd">    &gt;&gt;&gt; print(y.shape)</span>
<span class="sd">    (200, 10)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bgd_nparams</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_BGD_NPARAMS</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_norm</span> <span class="o">=</span> <span class="n">rescale_x_for_legendre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bgd_nparams</span><span class="p">):</span>
        <span class="c1"># out.append(params[k]*(parameters.CALIB_BGD_ORDER-k)*x**(parameters.CALIB_BGD_ORDER-(k+1)))</span>
        <span class="c1"># out.append(x ** (bgd_nparams - 1 - k))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bgd_nparams</span><span class="p">)</span>
        <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">bgd_nparams</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">gauss_jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="n">bgd_nparams</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">k</span><span class="p">:</span><span class="n">bgd_nparams</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jac</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>


<span class="c1"># noinspection PyTypeChecker</span>
<div class="viewcode-block" id="fit_multigauss_and_bgd"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_multigauss_and_bgd">[docs]</a><span class="k">def</span> <span class="nf">fit_multigauss_and_bgd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix_centroids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a multiple Gaussian profile plus a polynomial background to data, using iminuit.</span>
<span class="sd">    The mean guess value of the Gaussian must not be far from the truth values.</span>
<span class="sd">    Boundaries helps a lot also. The degree of the polynomial background is fixed by parameters.CALIB_BGD_NPARAMS.</span>
<span class="sd">    The order of the parameters is a first block CALIB_BGD_NPARAMS parameters (from high to low monomial terms,</span>
<span class="sd">    same as np.polyval), and then block of 3 parameters for the Gaussian profiles like amplitude, mean and standard</span>
<span class="sd">    deviation. x values are renormalised on the [-1, 1] interval for the background.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    guess: list, [CALIB_BGD_ORDER+1 parameters, 3*number of Gaussian parameters]</span>
<span class="sd">        List of first guessed values for the Gaussian fit (default: [0, 1, 10, 1000, 1]).</span>
<span class="sd">    bounds: array</span>
<span class="sd">        List of boundaries for the parameters [[minima],[maxima]] (default: (-np.inf, np.inf)).</span>
<span class="sd">    sigma: array, optional</span>
<span class="sd">        The uncertainties on the y values (default: None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    popt: array</span>
<span class="sd">        Best fitting parameters of curve_fit.</span>
<span class="sd">    pcov: array</span>
<span class="sd">        Best fitting parameters covariance matrix from curve_fit.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(600.,800.,1)</span>
<span class="sd">    &gt;&gt;&gt; p = [20, 1, -1, -1, 20, 650, 3, 40, 750, 5]</span>
<span class="sd">    &gt;&gt;&gt; y = multigauss_and_bgd(x, *p)</span>
<span class="sd">    &gt;&gt;&gt; print(f&#39;{y[0]:.2f}&#39;)</span>
<span class="sd">    19.00</span>
<span class="sd">    &gt;&gt;&gt; err = 0.1 * np.sqrt(y)</span>
<span class="sd">    &gt;&gt;&gt; guess = (15,0,0,0,10,640,2,20,750,7)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((-np.inf,-np.inf,-np.inf,-np.inf,1,600,1,1,600,1),(np.inf,np.inf,np.inf,np.inf,100,800,100,100,800,100))</span>
<span class="sd">    &gt;&gt;&gt; popt, pcov = fit_multigauss_and_bgd(x, y, guess=guess, bounds=bounds, sigma=err)</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p,popt,rtol=1e-4))</span>
<span class="sd">    &gt;&gt;&gt; fit = multigauss_and_bgd(x, *popt)</span>

<span class="sd">    .. plot::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        plt.errorbar(x,y,yerr=err,linestyle=&#39;None&#39;)</span>
<span class="sd">        plt.plot(x,fit,&#39;r-&#39;)</span>
<span class="sd">        plt.plot(x,multigauss_and_bgd(x, *guess),&#39;k--&#39;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">multigauss_and_bgd</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                           <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trf&#39;</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">jac</span><span class="o">=</span><span class="n">multigauss_and_bgd_jacobian</span><span class="p">,</span> <span class="n">x_scale</span><span class="o">=</span><span class="s1">&#39;jac&#39;</span><span class="p">)</span>
    <span class="c1"># error = 0.1 * np.abs(guess) * np.ones_like(guess)</span>
    <span class="c1"># z = np.where(np.isclose(error,0.0,1e-6))</span>
    <span class="c1"># error[z] = 0.01</span>
    <span class="c1"># bounds = np.array(bounds)</span>
    <span class="c1"># if bounds.shape[0] == 2 and bounds.shape[1] &gt; 2:</span>
    <span class="c1">#     bounds = bounds.T</span>
    <span class="c1"># guess = np.array(guess)</span>
    <span class="c1">#</span>
    <span class="c1"># def chisq_multigauss_and_bgd(params):</span>
    <span class="c1">#     if sigma is None:</span>
    <span class="c1">#         return np.nansum((multigauss_and_bgd(x, *params) - y)**2)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         return np.nansum(((multigauss_and_bgd(x, *params) - y)/sigma)**2)</span>
    <span class="c1">#</span>
    <span class="c1"># def chisq_multigauss_and_bgd_jac(params):</span>
    <span class="c1">#     diff = multigauss_and_bgd(x, *params) - y</span>
    <span class="c1">#     jac = multigauss_and_bgd_jacobian(x, *params)</span>
    <span class="c1">#     if sigma is None:</span>
    <span class="c1">#         return np.array([np.nansum(2 * jac[p] * diff) for p in range(len(params))])</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         return np.array([np.nansum(2 * jac[p] * diff / (sigma*sigma)) for p in range(len(params))])</span>
    <span class="c1">#</span>
    <span class="c1"># fix = [False] * error.size</span>
    <span class="c1"># if fix_centroids:</span>
    <span class="c1">#     for k in range(parameters.CALIB_BGD_NPARAMS, len(fix), 3):</span>
    <span class="c1">#        fix[k+1] = True</span>
    <span class="c1"># # noinspection PyArgumentList</span>
    <span class="c1"># m = Minuit.from_array_func(fcn=chisq_multigauss_and_bgd, start=guess, error=error, errordef=1,</span>
    <span class="c1">#                            fix=fix, print_level=0, limit=bounds, grad=chisq_multigauss_and_bgd_jac)</span>
    <span class="c1">#</span>
    <span class="c1"># m.tol = 0.001</span>
    <span class="c1"># m.migrad()</span>
    <span class="c1"># try:</span>
    <span class="c1">#     pcov = m.np_covariance()</span>
    <span class="c1"># except:</span>
    <span class="c1">#     pcov = None</span>
    <span class="c1"># popt = m.np_values()</span>
    <span class="k">return</span> <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span></div>


<span class="c1"># noinspection PyTupleAssignmentBalance</span>
<div class="viewcode-block" id="fit_poly1d"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_poly1d">[docs]</a><span class="k">def</span> <span class="nf">fit_poly1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a 1D polynomial function to data. Use np.polyfit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    order: int</span>
<span class="sd">        The degree of the polynomial function.</span>
<span class="sd">    w: array, optional</span>
<span class="sd">        Weights on the y data (default: None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fit: array</span>
<span class="sd">        The best fitting parameter values.</span>
<span class="sd">    cov: 2D-array</span>
<span class="sd">        The covariance matrix</span>
<span class="sd">    model: array</span>
<span class="sd">        The best fitting profile</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(500., 1000., 1)</span>
<span class="sd">    &gt;&gt;&gt; p = [3, 2, 1, 1]</span>
<span class="sd">    &gt;&gt;&gt; y = np.polyval(p, x)</span>
<span class="sd">    &gt;&gt;&gt; err = np.ones_like(y)</span>
<span class="sd">    &gt;&gt;&gt; fit, cov, model = fit_poly1d(x, y, order=3)</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p, fit, 1e-5))</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(model, y))</span>
<span class="sd">    &gt;&gt;&gt; assert cov.shape == (4, 4)</span>
<span class="sd">    &gt;&gt;&gt; fit, cov2, model2 = fit_poly1d(x, y, order=3, w=err)</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p, fit, 1e-5))</span>
<span class="sd">    &gt;&gt;&gt; fit, cov3, model3 = fit_poly1d([0, 1], [1, 1], order=3, w=err)</span>
<span class="sd">    &gt;&gt;&gt; print(fit)</span>
<span class="sd">    [0 0 0 0]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">order</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">model</span></div>


<span class="c1"># noinspection PyTupleAssignmentBalance</span>
<div class="viewcode-block" id="fit_poly1d_legendre"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_poly1d_legendre">[docs]</a><span class="k">def</span> <span class="nf">fit_poly1d_legendre</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a 1D polynomial function to data using Legendre polynomial orthogonal basis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    order: int</span>
<span class="sd">        The degree of the polynomial function.</span>
<span class="sd">    w: array, optional</span>
<span class="sd">        Weights on the y data (default: None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fit: array</span>
<span class="sd">        The best fitting parameter values.</span>
<span class="sd">    cov: 2D-array</span>
<span class="sd">        The covariance matrix</span>
<span class="sd">    model: array</span>
<span class="sd">        The best fitting profile</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(500., 1000., 1)</span>
<span class="sd">    &gt;&gt;&gt; p = [-1e-6, -1e-4, 1, 1]</span>
<span class="sd">    &gt;&gt;&gt; y = np.polyval(p, x)</span>
<span class="sd">    &gt;&gt;&gt; err = np.ones_like(y)</span>
<span class="sd">    &gt;&gt;&gt; fit, cov, model = fit_poly1d_legendre(x,y,order=3)</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p,fit,3))</span>
<span class="sd">    &gt;&gt;&gt; fit, cov2, model2 = fit_poly1d_legendre(x,y,order=3,w=err)</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p,fit,3))</span>
<span class="sd">    &gt;&gt;&gt; fit, cov3, model3 = fit_poly1d([0, 1], [1, 1], order=3, w=err)</span>
<span class="sd">    &gt;&gt;&gt; print(fit)</span>
<span class="sd">    [0 0 0 0]</span>

<span class="sd">    .. plot::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        plt.errorbar(x,y,yerr=err,fmt=&#39;ro&#39;)</span>
<span class="sd">        plt.plot(x,model2)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">x_norm</span> <span class="o">=</span> <span class="n">rescale_x_for_legendre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">order</span><span class="p">:</span>
        <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legfit</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">fit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">model</span></div>


<span class="c1"># noinspection PyTypeChecker,PyUnresolvedReferences</span>
<div class="viewcode-block" id="fit_poly2d"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_poly2d">[docs]</a><span class="k">def</span> <span class="nf">fit_poly2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a 2D polynomial function to data. Use astropy.modeling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    z: array</span>
<span class="sd">        The z data values.</span>
<span class="sd">    order: int</span>
<span class="sd">        The degree of the polynomial function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: Astropy model</span>
<span class="sd">        The best fitting astropy polynomial model</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x, y = np.mgrid[:50,:50]</span>
<span class="sd">    &gt;&gt;&gt; z = x**2 + y**2 - 2*x*y</span>
<span class="sd">    &gt;&gt;&gt; fit = fit_poly2d(x, y, z, order=2)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c0_0.value, 0)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c1_0.value, 0)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c2_0.value, 1)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c0_1.value, 0)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c0_2.value, 1)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c1_1.value, -2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial2D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">fit_p</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">fit_p</span><span class="p">(</span><span class="n">p_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="fit_poly1d_outlier_removal"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_poly1d_outlier_removal">[docs]</a><span class="k">def</span> <span class="nf">fit_poly1d_outlier_removal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a 1D polynomial function to data. Use astropy.modeling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    order: int</span>
<span class="sd">        The degree of the polynomial function (default: 2).</span>
<span class="sd">    sigma: float</span>
<span class="sd">        Value of the sigma-clipping (default: 3.0).</span>
<span class="sd">    niter: int</span>
<span class="sd">        The number of iterations to converge (default: 3).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: Astropy model</span>
<span class="sd">        The best fitting astropy model.</span>
<span class="sd">    outliers: array_like</span>
<span class="sd">        List of the outlier points.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x = np.arange(500., 1000., 1)</span>
<span class="sd">    &gt;&gt;&gt; p = [3,2,1,0]</span>
<span class="sd">    &gt;&gt;&gt; y = np.polyval(p, x)</span>
<span class="sd">    &gt;&gt;&gt; y[::10] = 0.</span>
<span class="sd">    &gt;&gt;&gt; model, outliers = fit_poly1d_outlier_removal(x,y,order=3,sigma=3)</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;{:.2f}&#39;.format(model.c0.value))</span>
<span class="sd">    0.00</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;{:.2f}&#39;.format(model.c1.value))</span>
<span class="sd">    1.00</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;{:.2f}&#39;.format(model.c2.value))</span>
<span class="sd">    2.00</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;{:.2f}&#39;.format(model.c3.value))</span>
<span class="sd">    3.00</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">gg_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gg_init</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">gg_init</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">gg_init</span><span class="o">.</span><span class="n">c1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">gg_init</span><span class="o">.</span><span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">or_fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">FittingWithOutlierRemoval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># get fitted model and filtered data</span>
        <span class="n">or_fitted_model</span><span class="p">,</span> <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">or_fit</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># not working</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        plt.figure(figsize=(8,5))</span>
<span class="sd">        plt.plot(x, y, &#39;gx&#39;, label=&quot;original data&quot;)</span>
<span class="sd">        plt.plot(x, filtered_data, &#39;r+&#39;, label=&quot;filtered data&quot;)</span>
<span class="sd">        plt.plot(x, or_fitted_model(x), &#39;r--&#39;,</span>
<span class="sd">                 label=&quot;model fitted w/ filtered data&quot;)</span>
<span class="sd">        plt.legend(loc=2, numpoints=1)</span>
<span class="sd">        if parameters.DISPLAY: plt.show()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># my_logger.info(f&#39;\n\t{or_fitted_model}&#39;)</span>
        <span class="c1"># my_logger.debug(f&#39;\n\t{fit.fit_info}&#39;)</span>
        <span class="k">return</span> <span class="n">or_fitted_model</span><span class="p">,</span> <span class="n">outliers</span></div>


<div class="viewcode-block" id="fit_poly2d_outlier_removal"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_poly2d_outlier_removal">[docs]</a><span class="k">def</span> <span class="nf">fit_poly2d_outlier_removal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a 2D polynomial function to data. Use astropy.modeling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array</span>
<span class="sd">        The x data values.</span>
<span class="sd">    y: array</span>
<span class="sd">        The y data values.</span>
<span class="sd">    z: array</span>
<span class="sd">        The z data values.</span>
<span class="sd">    order: int</span>
<span class="sd">        The degree of the polynomial function (default: 2).</span>
<span class="sd">    sigma: float</span>
<span class="sd">        Value of the sigma-clipping (default: 3.0).</span>
<span class="sd">    niter: int</span>
<span class="sd">        The number of iterations to converge (default: 30).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: Astropy model</span>
<span class="sd">        The best fitting astropy model.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x, y = np.mgrid[:50,:50]</span>
<span class="sd">    &gt;&gt;&gt; z = x**2 + y**2 - 2*x*y</span>
<span class="sd">    &gt;&gt;&gt; z[::10,::10] = 0.</span>
<span class="sd">    &gt;&gt;&gt; fit = fit_poly2d_outlier_removal(x,y,z,order=2,sigma=3)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c0_0.value, 0)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c1_0.value, 0)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c2_0.value, 1)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c0_1.value, 0)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c0_2.value, 1)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fit.c1_1.value, -2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">gg_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial2D</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gg_init</span><span class="o">.</span><span class="n">c0_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">gg_init</span><span class="o">.</span><span class="n">c0_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">or_fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">FittingWithOutlierRemoval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># get fitted model and filtered data</span>
        <span class="n">or_fitted_model</span><span class="p">,</span> <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">or_fit</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{or_fitted_model}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># my_logger.debug(f&#39;\n\t{fit.fit_info}&#39;)</span>
        <span class="k">return</span> <span class="n">or_fitted_model</span></div>


<div class="viewcode-block" id="tied_circular_gauss2d"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.tied_circular_gauss2d">[docs]</a><span class="k">def</span> <span class="nf">tied_circular_gauss2d</span><span class="p">(</span><span class="n">g1</span><span class="p">):</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">g1</span><span class="o">.</span><span class="n">x_stddev</span>
    <span class="k">return</span> <span class="n">std</span></div>


<div class="viewcode-block" id="fit_gauss2d_outlier_removal"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_gauss2d_outlier_removal">[docs]</a><span class="k">def</span> <span class="nf">fit_gauss2d_outlier_removal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">circular</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit an astropy Gaussian 2D model with parameters :</span>
<span class="sd">        amplitude, x_mean,y_mean,x_stddev, y_stddev,theta</span>
<span class="sd">    using outlier removal methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        2D array of the x coordinates from meshgrid.</span>
<span class="sd">    y: np.array</span>
<span class="sd">        2D array of the y coordinates from meshgrid.</span>
<span class="sd">    z: np.array</span>
<span class="sd">        the 2D array image.</span>
<span class="sd">    sigma: float</span>
<span class="sd">        value of sigma for the sigma rejection of outliers (default: 3)</span>
<span class="sd">    niter: int</span>
<span class="sd">        maximum number of iterations for the outlier detection (default: 3)</span>
<span class="sd">    guess: list, optional</span>
<span class="sd">        List containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="sd">    circular: bool, optional</span>
<span class="sd">        If True, force the Gaussian shape to be circular (default: False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: Fittable</span>
<span class="sd">        Astropy Gaussian2D model</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; from astropy.modeling import models</span>
<span class="sd">    &gt;&gt;&gt; X, Y = np.mgrid[:50,:50]</span>
<span class="sd">    &gt;&gt;&gt; PSF = models.Gaussian2D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 25, 25, 5, 5, 0)</span>
<span class="sd">    &gt;&gt;&gt; Z = PSF.evaluate(X, Y, *p)</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z, origin=&#39;loxer&#39;) #doctest: +ELLIPSIS</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &gt;&gt;&gt; guess = (45, 20, 20, 7, 7, 0)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((1, 10, 10, 1, 1, -90), (100, 40, 40, 10, 10, 90))</span>
<span class="sd">    &gt;&gt;&gt; fit = fit_gauss2d_outlier_removal(X, Y, Z, guess=guess, bounds=bounds, circular=True)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(fit, p).value for p in fit.param_names]</span>
<span class="sd">    &gt;&gt;&gt; print(res)</span>
<span class="sd">    [50.0, 25.0, 25.0, 5.0, 5.0, 0.0]</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z-fit(X, Y), origin=&#39;loxer&#39;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">gg_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">circular</span><span class="p">:</span>
        <span class="n">gg_init</span><span class="o">.</span><span class="n">y_stddev</span><span class="o">.</span><span class="n">tied</span> <span class="o">=</span> <span class="n">tied_circular_gauss2d</span>
        <span class="n">gg_init</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">or_fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">FittingWithOutlierRemoval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># get fitted model and filtered data</span>
        <span class="n">or_fitted_model</span><span class="p">,</span> <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">or_fit</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{or_fitted_model}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># my_logger.debug(f&#39;\n\t{fit.fit_info}&#39;)</span>
        <span class="k">return</span> <span class="n">or_fitted_model</span></div>


<div class="viewcode-block" id="fit_moffat2d_outlier_removal"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_moffat2d_outlier_removal">[docs]</a><span class="k">def</span> <span class="nf">fit_moffat2d_outlier_removal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit an astropy Moffat 2D model with parameters :</span>
<span class="sd">        amplitude, x_mean, y_mean, gamma, alpha</span>
<span class="sd">    using outlier removal methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        2D array of the x coordinates from meshgrid.</span>
<span class="sd">    y: np.array</span>
<span class="sd">        2D array of the y coordinates from meshgrid.</span>
<span class="sd">    z: np.array</span>
<span class="sd">        the 2D array image.</span>
<span class="sd">    sigma: float</span>
<span class="sd">        value of sigma for the sigma rejection of outliers (default: 3)</span>
<span class="sd">    niter: int</span>
<span class="sd">        maximum number of iterations for the outlier detection (default: 3)</span>
<span class="sd">    guess: list, optional</span>
<span class="sd">        List containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: Fittable</span>
<span class="sd">        Astropy Moffat2D model</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; from astropy.modeling import models</span>
<span class="sd">    &gt;&gt;&gt; X, Y = np.mgrid[:100,:100]</span>
<span class="sd">    &gt;&gt;&gt; PSF = models.Moffat2D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 50, 50, 5, 2)</span>
<span class="sd">    &gt;&gt;&gt; Z = PSF.evaluate(X, Y, *p)</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z, origin=&#39;loxer&#39;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &gt;&gt;&gt; guess = (45, 48, 52, 4, 2)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((1, 10, 10, 1, 1), (100, 90, 90, 10, 10))</span>
<span class="sd">    &gt;&gt;&gt; fit = fit_moffat2d_outlier_removal(X, Y, Z, guess=guess, bounds=bounds, niter=3)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(fit, p).value for p in fit.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert(np.all(np.isclose(p, res, 1e-1)))</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z-fit(X, Y), origin=&#39;loxer&#39;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">gg_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Moffat2D</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">or_fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">FittingWithOutlierRemoval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># get fitted model and filtered data</span>
        <span class="n">or_fitted_model</span><span class="p">,</span> <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">or_fit</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{or_fitted_model}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># my_logger.debug(f&#39;\n\t{fit.fit_info}&#39;)</span>
        <span class="k">return</span> <span class="n">or_fitted_model</span></div>


<div class="viewcode-block" id="fit_moffat1d_outlier_removal"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_moffat1d_outlier_removal">[docs]</a><span class="k">def</span> <span class="nf">fit_moffat1d_outlier_removal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit an astropy Moffat 1D model with parameters :</span>
<span class="sd">        amplitude, x_mean, gamma, alpha</span>
<span class="sd">    using outlier removal methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        1D array of the x coordinates from meshgrid.</span>
<span class="sd">    y: np.array</span>
<span class="sd">        the 1D array amplitudes.</span>
<span class="sd">    sigma: float</span>
<span class="sd">        value of sigma for the sigma rejection of outliers (default: 3)</span>
<span class="sd">    niter: int</span>
<span class="sd">        maximum number of iterations for the outlier detection (default: 3)</span>
<span class="sd">    guess: list, optional</span>
<span class="sd">        List containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: Fittable</span>
<span class="sd">        Astropy Moffat1D model</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; from astropy.modeling import models</span>
<span class="sd">    &gt;&gt;&gt; X = np.arange(100)</span>
<span class="sd">    &gt;&gt;&gt; PSF = models.Moffat1D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 50, 5, 2)</span>
<span class="sd">    &gt;&gt;&gt; Y = PSF.evaluate(X, *p)</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z, origin=&#39;loxer&#39;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &gt;&gt;&gt; guess = (45, 48, 4, 2)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((1, 10, 1, 1), (100, 90, 10, 10))</span>
<span class="sd">    &gt;&gt;&gt; fit = fit_moffat1d_outlier_removal(X, Y, guess=guess, bounds=bounds, niter=3)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(fit, p).value for p in fit.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert(np.all(np.isclose(p, res, 1e-6)))</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z-fit(X, Y), origin=&#39;loxer&#39;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">gg_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Moffat1D</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">or_fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">FittingWithOutlierRemoval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># get fitted model and filtered data</span>
        <span class="n">or_fitted_model</span><span class="p">,</span> <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">or_fit</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{or_fitted_model}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># my_logger.debug(f&#39;\n\t{fit.fit_info}&#39;)</span>
        <span class="k">return</span> <span class="n">or_fitted_model</span></div>


<div class="viewcode-block" id="fit_moffat1d"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fit_moffat1d">[docs]</a><span class="k">def</span> <span class="nf">fit_moffat1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit an astropy Moffat 1D model with parameters :</span>
<span class="sd">        amplitude, x_mean, gamma, alpha</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        1D array of the x coordinates from meshgrid.</span>
<span class="sd">    y: np.array</span>
<span class="sd">        the 1D array amplitudes.</span>
<span class="sd">    guess: list, optional</span>
<span class="sd">        List containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: Fittable</span>
<span class="sd">        Astropy Moffat1D model</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; from astropy.modeling import models</span>
<span class="sd">    &gt;&gt;&gt; X = np.arange(100)</span>
<span class="sd">    &gt;&gt;&gt; PSF = models.Moffat1D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 50, 5, 2)</span>
<span class="sd">    &gt;&gt;&gt; Y = PSF.evaluate(X, *p)</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z, origin=&#39;lower&#39;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &gt;&gt;&gt; guess = (45, 48, 4, 2)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((1, 10, 1, 1), (100, 90, 10, 10))</span>
<span class="sd">    &gt;&gt;&gt; fit = fit_moffat1d(X, Y, guess=guess, bounds=bounds)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(fit, p).value for p in fit.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert(np.all(np.isclose(p, res, 1e-6)))</span>

<span class="sd">    .. plot::</span>

<span class="sd">        plt.imshow(Z-fit(X, Y), origin=&#39;lower&#39;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">gg_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Moffat1D</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gg_init</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Ignore model linearity warning from the fitter</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">fitted_model</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">gg_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{fitted_model}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># my_logger.debug(f&#39;\n\t{fit.fit_info}&#39;)</span>
        <span class="k">return</span> <span class="n">fitted_model</span></div>


<div class="viewcode-block" id="LevMarLSQFitterWithNan"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.LevMarLSQFitterWithNan">[docs]</a><span class="k">class</span> <span class="nc">LevMarLSQFitterWithNan</span><span class="p">(</span><span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">):</span>

<div class="viewcode-block" id="LevMarLSQFitterWithNan.objective_function"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.LevMarLSQFitterWithNan.objective_function">[docs]</a>    <span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to minimize.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fps : list</span>
<span class="sd">            parameters returned by the fitter</span>
<span class="sd">        args : list</span>
<span class="sd">            [model, [weights], [input coordinates]]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fitting</span><span class="o">.</span><span class="n">_fitter_to_model_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>
        <span class="n">meas</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">meas</span><span class="p">)</span>
            <span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">meas</span><span class="p">))</span>
            <span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">a</span></div></div>


<div class="viewcode-block" id="compute_fwhm"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.compute_fwhm">[docs]</a><span class="k">def</span> <span class="nf">compute_fwhm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the full width half maximum of y(x) curve,</span>
<span class="sd">    using an interpolation of the data points and dichotomie method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array_like</span>
<span class="sd">        The abscisse array.</span>
<span class="sd">    y: array_like</span>
<span class="sd">        The function array.</span>
<span class="sd">    minimum: float, optional</span>
<span class="sd">        The minimum reference from which to compyte half the height (default: 0).</span>
<span class="sd">    center: float, optional</span>
<span class="sd">        The center of the curve. If None, the weighted averageof the y(x) distribution is computed (default: None).</span>
<span class="sd">    full_output: bool, optional</span>
<span class="sd">        If True, half maximum, the edges of the curve and the curve center are given in output (default: False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FWHM: float</span>
<span class="sd">        The full width half maximum of the curve.</span>
<span class="sd">    half: float, optional</span>
<span class="sd">        The half maximum value. Only if full_output=True.</span>
<span class="sd">    center: float, optional</span>
<span class="sd">        The y(x) center value. Only if full_output=True.</span>
<span class="sd">    left_edge: float, optional</span>
<span class="sd">        The left_edge value at half maximum. Only if full_output=True.</span>
<span class="sd">    right_edge: float, optional</span>
<span class="sd">        The right_edge value at half maximum. Only if full_output=True.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    # Gaussian example</span>
<span class="sd">    &gt;&gt;&gt; x = np.arange(0, 100, 1)</span>
<span class="sd">    &gt;&gt;&gt; stddev = 4</span>
<span class="sd">    &gt;&gt;&gt; middle = 40</span>
<span class="sd">    &gt;&gt;&gt; psf = gauss(x, 1, middle, stddev)</span>
<span class="sd">    &gt;&gt;&gt; fwhm, half, center, a, b = compute_fwhm(x, psf, full_output=True)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;{fwhm:.4f} {2.355*stddev:.4f} {center:.4f}&quot;)</span>
<span class="sd">    9.4192 9.4200 40.0000</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fwhm, 2.355*stddev, atol=1e-3)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(center, middle, atol=1e-3)</span>

<span class="sd">    .. plot ::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        plt.figure</span>
<span class="sd">        plt.plot(x, psf, label=&quot;function&quot;)</span>
<span class="sd">        plt.axvline(center, color=&quot;gray&quot;, label=&quot;center&quot;)</span>
<span class="sd">        plt.axvline(a, color=&quot;k&quot;, label=&quot;edges at half max&quot;)</span>
<span class="sd">        plt.axvline(b, color=&quot;k&quot;, label=&quot;edges at half max&quot;)</span>
<span class="sd">        plt.axhline(half, color=&quot;r&quot;, label=&quot;half max&quot;)</span>
<span class="sd">        plt.legend()</span>
<span class="sd">        plt.title(f&quot;FWHM={fwhm:.3f}&quot;)</span>
<span class="sd">        plt.xlabel(&quot;x&quot;)</span>
<span class="sd">        plt.ylabel(&quot;y&quot;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    # Defocused PSF example</span>
<span class="sd">    &gt;&gt;&gt; from spectractor.extractor.psf import PSF1D</span>
<span class="sd">    &gt;&gt;&gt; p = [2,40,4,2,-0.4,1,10]</span>
<span class="sd">    &gt;&gt;&gt; psf = PSF1D(p)</span>
<span class="sd">    &gt;&gt;&gt; fwhm, half, center, a, b = compute_fwhm(x, psf.evaluate(x), full_output=True)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(fwhm, 6.96, atol=1e-2)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(center, p[1], atol=1e-2)</span>

<span class="sd">    .. plot ::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        plt.figure</span>
<span class="sd">        plt.plot(x, psf.evaluate(x, p), label=&quot;function&quot;)</span>
<span class="sd">        plt.axvline(center, color=&quot;gray&quot;, label=&quot;center&quot;)</span>
<span class="sd">        plt.axvline(a, color=&quot;k&quot;, label=&quot;edges at half max&quot;)</span>
<span class="sd">        plt.axvline(b, color=&quot;k&quot;, label=&quot;edges at half max&quot;)</span>
<span class="sd">        plt.axhline(half, color=&quot;r&quot;, label=&quot;half max&quot;)</span>
<span class="sd">        plt.legend()</span>
<span class="sd">        plt.title(f&quot;FWHM={fwhm:.3f}&quot;)</span>
<span class="sd">        plt.xlabel(&quot;x&quot;)</span>
<span class="sd">        plt.ylabel(&quot;y&quot;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># TODO: implement fwhm for 2D curves</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
    <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">minimum</span>
    <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">imax</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">imax</span><span class="p">:]</span> <span class="o">-</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">maximum</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">imax</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">imax</span><span class="p">:]</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">maximum</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">interp</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maximum</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dichotomie</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="n">center</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">full_output</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fwhm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fwhm</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">maximum</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">center</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="o">-</span><span class="n">center</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_integral"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.compute_integral">[docs]</a><span class="k">def</span> <span class="nf">compute_integral</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the integral of an y(x) curve. The curve is interpolated and extrapolated with cubic splines.</span>
<span class="sd">    If not provided, bounds are set to the x array edges.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: array_like</span>
<span class="sd">        The abscisse array.</span>
<span class="sd">    y: array_like</span>
<span class="sd">        The function array.</span>
<span class="sd">    bounds: array_like, optional</span>
<span class="sd">        The bounds of the integral. If None, the edges of thex array are taken (default bounds=None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result: float</span>
<span class="sd">        The integral of the PSF model.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Gaussian example</span>
<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; x = np.arange(0, 100, 0.5)</span>
<span class="sd">        &gt;&gt;&gt; stddev = 4</span>
<span class="sd">        &gt;&gt;&gt; middle = 40</span>
<span class="sd">        &gt;&gt;&gt; psf = gauss(x, 1/(stddev*np.sqrt(2*np.pi)), middle, stddev)</span>
<span class="sd">        &gt;&gt;&gt; integral = compute_integral(x, psf)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;{integral:.6f}&quot;)</span>
<span class="sd">        1.000000</span>

<span class="sd">    Defocused PSF example</span>
<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; from spectractor.extractor.psf import PSF1D</span>
<span class="sd">        &gt;&gt;&gt; p = [2,30,4,2,-0.5,1,10]</span>
<span class="sd">        &gt;&gt;&gt; psf = PSF1D(p)</span>
<span class="sd">        &gt;&gt;&gt; integral = compute_integral(x, psf.evaluate(x))</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(integral, p[0], atol=1e-3)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
    <span class="n">integral</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">interp</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">integral</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="find_nearest"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.find_nearest">[docs]</a><span class="k">def</span> <span class="nf">find_nearest</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the nearest index and value in an array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array: array</span>
<span class="sd">        The array to inspect.</span>
<span class="sd">    value: float</span>
<span class="sd">        The value to look for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    index: int</span>
<span class="sd">        The array index of the nearest value close to *value*</span>
<span class="sd">    val: float</span>
<span class="sd">        The value fo the array at index.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; x = np.arange(0.,10.)</span>
<span class="sd">    &gt;&gt;&gt; idx, val = find_nearest(x, 3.3)</span>
<span class="sd">    &gt;&gt;&gt; print(idx, val)</span>
<span class="sd">    3 3.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array</span> <span class="o">-</span> <span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">idx</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="ensure_dir"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.ensure_dir">[docs]</a><span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">directory_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure that *directory_name* directory exists. If not, create it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory_name: str</span>
<span class="sd">        The directory name.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; ensure_dir(&#39;tests&#39;)</span>
<span class="sd">    &gt;&gt;&gt; os.path.exists(&#39;tests&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; ensure_dir(&#39;tests/mytest&#39;)</span>
<span class="sd">    &gt;&gt;&gt; os.path.exists(&#39;tests/mytest&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; os.rmdir(&#39;./tests/mytest&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory_name</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory_name</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="weighted_avg_and_std"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.weighted_avg_and_std">[docs]</a><span class="k">def</span> <span class="nf">weighted_avg_and_std</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the weighted average and standard deviation.</span>

<span class="sd">    values, weights -- Numpy ndarrays with the same shape.</span>
<span class="sd">    </span>
<span class="sd">    For example for the PSF</span>
<span class="sd">    </span>
<span class="sd">    x=pixel number</span>
<span class="sd">    y=Intensity in pixel</span>
<span class="sd">    </span>
<span class="sd">    values-x</span>
<span class="sd">    weights=y=f(x)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">values</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># Fast and numerically precise</span>
    <span class="k">return</span> <span class="n">average</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span></div>


<div class="viewcode-block" id="hessian_and_theta"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.hessian_and_theta">[docs]</a><span class="k">def</span> <span class="nf">hessian_and_theta</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">margin_cut</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># compute hessian matrices on the image</span>
    <span class="n">Hxx</span><span class="p">,</span> <span class="n">Hxy</span><span class="p">,</span> <span class="n">Hyy</span> <span class="o">=</span> <span class="n">hessian_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span>
    <span class="n">lambda_plus</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">Hxx</span> <span class="o">+</span> <span class="n">Hyy</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Hxx</span> <span class="o">-</span> <span class="n">Hyy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">Hxy</span> <span class="o">*</span> <span class="n">Hxy</span><span class="p">))</span>
    <span class="n">lambda_minus</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">Hxx</span> <span class="o">+</span> <span class="n">Hyy</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Hxx</span> <span class="o">-</span> <span class="n">Hyy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">Hxy</span> <span class="o">*</span> <span class="n">Hxy</span><span class="p">))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Hxy</span><span class="p">,</span> <span class="n">Hyy</span> <span class="o">-</span> <span class="n">Hxx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="c1"># remove the margins</span>
    <span class="n">lambda_minus</span> <span class="o">=</span> <span class="n">lambda_minus</span><span class="p">[</span><span class="n">margin_cut</span><span class="p">:</span><span class="o">-</span><span class="n">margin_cut</span><span class="p">,</span> <span class="n">margin_cut</span><span class="p">:</span><span class="o">-</span><span class="n">margin_cut</span><span class="p">]</span>
    <span class="n">lambda_plus</span> <span class="o">=</span> <span class="n">lambda_plus</span><span class="p">[</span><span class="n">margin_cut</span><span class="p">:</span><span class="o">-</span><span class="n">margin_cut</span><span class="p">,</span> <span class="n">margin_cut</span><span class="p">:</span><span class="o">-</span><span class="n">margin_cut</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">margin_cut</span><span class="p">:</span><span class="o">-</span><span class="n">margin_cut</span><span class="p">,</span> <span class="n">margin_cut</span><span class="p">:</span><span class="o">-</span><span class="n">margin_cut</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">lambda_plus</span><span class="p">,</span> <span class="n">lambda_minus</span><span class="p">,</span> <span class="n">theta</span></div>


<div class="viewcode-block" id="filter_stars_from_bgd"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.filter_stars_from_bgd">[docs]</a><span class="k">def</span> <span class="nf">filter_stars_from_bgd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">margin_cut</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">lambda_plus</span><span class="p">,</span> <span class="n">lambda_minus</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">hessian_and_theta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">margin_cut</span><span class="o">=</span><span class="n">margin_cut</span><span class="p">)</span>
    <span class="c1"># thresholds</span>
    <span class="n">lambda_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lambda_minus</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lambda_minus</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lambda_minus</span> <span class="o">&lt;</span> <span class="n">lambda_threshold</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="fftconvolve_gaussian"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.fftconvolve_gaussian">[docs]</a><span class="k">def</span> <span class="nf">fftconvolve_gaussian</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">reso</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convolve an 1D or 2D array with a Gaussian profile of given standard deviation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array: array</span>
<span class="sd">        The array to convolve.</span>
<span class="sd">    reso: float</span>
<span class="sd">        The standard deviation of the Gaussian profile.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    convolved: array</span>
<span class="sd">        The convolved array, same size and shape as input.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; array = np.ones(100)</span>
<span class="sd">    &gt;&gt;&gt; output = fftconvolve_gaussian(array, 3)</span>
<span class="sd">    &gt;&gt;&gt; print(output[:3])</span>
<span class="sd">    [0.5        0.63114657 0.74850168]</span>
<span class="sd">    &gt;&gt;&gt; array = np.ones((100, 100))</span>
<span class="sd">    &gt;&gt;&gt; output = fftconvolve_gaussian(array, 3)</span>
<span class="sd">    &gt;&gt;&gt; print(output[0][:3])</span>
<span class="sd">    [0.5        0.63114657 0.74850168]</span>
<span class="sd">    &gt;&gt;&gt; array = np.ones((100, 100, 100))</span>
<span class="sd">    &gt;&gt;&gt; output = fftconvolve_gaussian(array, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reso</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">reso</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Array dimension must be 1 or 2.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span></div>


<div class="viewcode-block" id="formatting_numbers"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.formatting_numbers">[docs]</a><span class="k">def</span> <span class="nf">formatting_numbers</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">error_high</span><span class="p">,</span> <span class="n">error_low</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format a physical value and its uncertainties. Round the uncertainties</span>
<span class="sd">    to the first significant digit, and do the same for the physical value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value: float</span>
<span class="sd">        The physical value.</span>
<span class="sd">    error_high: float</span>
<span class="sd">        Upper uncertainty.</span>
<span class="sd">    error_low: float</span>
<span class="sd">        Lower uncertainty</span>
<span class="sd">    std: float, optional</span>
<span class="sd">        The RMS of the physical parameter (default: None).</span>
<span class="sd">    label: str, optional</span>
<span class="sd">        The name of the physical parameter to output (default: None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    text: tuple</span>
<span class="sd">        The formatted output strings inside a tuple.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; formatting_numbers(3., 0.789, 0.500, std=0.45, label=&#39;test&#39;)</span>
<span class="sd">    (&#39;test&#39;, &#39;3.0&#39;, &#39;0.8&#39;, &#39;0.5&#39;, &#39;0.5&#39;)</span>
<span class="sd">    &gt;&gt;&gt; formatting_numbers(3., 0.07, 0.008, std=0.03, label=&#39;test&#39;)</span>
<span class="sd">    (&#39;test&#39;, &#39;3.000&#39;, &#39;0.07&#39;, &#39;0.008&#39;, &#39;0.03&#39;)</span>
<span class="sd">    &gt;&gt;&gt; formatting_numbers(3240., 0.2, 0.4, std=0.3)</span>
<span class="sd">    (&#39;3240.0&#39;, &#39;0.2&#39;, &#39;0.4&#39;, &#39;0.3&#39;)</span>
<span class="sd">    &gt;&gt;&gt; formatting_numbers(3240., 230, 420, std=330)</span>
<span class="sd">    (&#39;3240&#39;, &#39;230&#39;, &#39;420&#39;, &#39;330&#39;)</span>
<span class="sd">    &gt;&gt;&gt; formatting_numbers(0, 0.008, 0.04, std=0.03)</span>
<span class="sd">    (&#39;0.000&#39;, &#39;0.008&#39;, &#39;0.040&#39;, &#39;0.030&#39;)</span>
<span class="sd">    &gt;&gt;&gt; formatting_numbers(-55, 0.008, 0.04, std=0.03)</span>
<span class="sd">    (&#39;-55.000&#39;, &#39;0.008&#39;, &#39;0.04&#39;, &#39;0.03&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">str_std</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">power10</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error_high</span><span class="p">)))),</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error_low</span><span class="p">)))))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="n">value</span><span class="p">))):</span>
        <span class="n">str_value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">str_error_high</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="n">error_high</span><span class="p">)</span>
        <span class="n">str_error_low</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="n">error_low</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">str_std</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="n">std</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">power10</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">str_value</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{value:.0f}</span><span class="s2">&quot;</span>
        <span class="n">str_error_high</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_high:.0f}</span><span class="s2">&quot;</span>
        <span class="n">str_error_low</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_low:.0f}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">str_std</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{std:.0f}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error_high</span><span class="p">))))</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error_low</span><span class="p">)))):</span>
            <span class="n">str_value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">str_error_high</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_high:.1g}</span><span class="s2">&quot;</span>
            <span class="n">str_error_low</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_low:.1g}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">str_std</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{std:.1g}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error_high</span><span class="p">))))</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error_low</span><span class="p">)))):</span>
            <span class="n">str_value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">str_error_high</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_high:.2g}</span><span class="s2">&quot;</span>
            <span class="n">str_error_low</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_low:.1g}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">str_std</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{std:.2g}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.*f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">power10</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">str_error_high</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_high:.1g}</span><span class="s2">&quot;</span>
            <span class="n">str_error_low</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{error_low:.2g}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">str_std</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{std:.2g}</span><span class="s2">&quot;</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="n">str_value</span><span class="p">,</span> <span class="n">str_error_high</span><span class="p">]</span>
    <span class="c1">#if not np.isclose(error_high, error_low):</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="n">str_error_low</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="n">str_std</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="pixel_rotation"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.pixel_rotation">[docs]</a><span class="k">def</span> <span class="nf">pixel_rotation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate a 2D vector (x,y) of an angle theta clockwise.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: float</span>
<span class="sd">        x coordinate</span>
<span class="sd">    y: float</span>
<span class="sd">        y coordinate</span>
<span class="sd">    theta: float</span>
<span class="sd">        angle in radians</span>
<span class="sd">    x0: float, optional</span>
<span class="sd">        x position of the center of rotation (default: 0)</span>
<span class="sd">    y0: float, optional</span>
<span class="sd">        y position of the center of rotation (default: 0)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    u: float</span>
<span class="sd">        rotated x coordinate</span>
<span class="sd">    v: float</span>
<span class="sd">        rotated y coordinate</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; pixel_rotation(0, 0, 45)</span>
<span class="sd">    (0.0, 0.0)</span>
<span class="sd">    &gt;&gt;&gt; u, v = pixel_rotation(1, 0, np.pi/4)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(u, 1/np.sqrt(2))</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(v, -1/np.sqrt(2))</span>
<span class="sd">    &gt;&gt;&gt; u, v = pixel_rotation(1, 2, -np.pi/2, x0=1, y0=0)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(u, -2)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(v, 0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span></div>


<div class="viewcode-block" id="detect_peaks"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.detect_peaks">[docs]</a><span class="k">def</span> <span class="nf">detect_peaks</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an image and detect the peaks using the local maximum filter.</span>
<span class="sd">    Returns a boolean mask of the peaks (i.e. 1 when</span>
<span class="sd">    the pixel&#39;s value is the neighborhood maximum, 0 otherwise).</span>
<span class="sd">    Only positive peaks are detected (take absolute value or negative value of the</span>
<span class="sd">    image to detect the negative ones).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: array_like</span>
<span class="sd">        The image 2D array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    detected_peaks: array_like</span>
<span class="sd">        Boolean maskof the peaks.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; im = np.zeros((50,50))</span>
<span class="sd">    &gt;&gt;&gt; im[4,6] = 2</span>
<span class="sd">    &gt;&gt;&gt; im[10,20] = -3</span>
<span class="sd">    &gt;&gt;&gt; im[49,49] = 1</span>
<span class="sd">    &gt;&gt;&gt; detected_peaks = detect_peaks(im)</span>
<span class="sd">    &gt;&gt;&gt; assert detected_peaks[4,6]</span>
<span class="sd">    &gt;&gt;&gt; assert not detected_peaks[10,20]</span>
<span class="sd">    &gt;&gt;&gt; assert detected_peaks[49,49]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># define an 8-connected neighborhood</span>
    <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># apply the local maximum filter; all pixel of maximal value</span>
    <span class="c1"># in their neighborhood are set to 1</span>
    <span class="n">local_max</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">)</span> <span class="o">==</span> <span class="n">image</span>
    <span class="c1"># local_max is a mask that contains the peaks we are</span>
    <span class="c1"># looking for, but also the background.</span>
    <span class="c1"># In order to isolate the peaks we must remove the background from the mask.</span>

    <span class="c1"># we create the mask of the background</span>
    <span class="n">background</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># a little technicality: we must erode the background in order to</span>
    <span class="c1"># successfully subtract it form local_max, otherwise a line will</span>
    <span class="c1"># appear along the background border (artifact of the local maximum filter)</span>
    <span class="n">eroded_background</span> <span class="o">=</span> <span class="n">binary_erosion</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">,</span> <span class="n">border_value</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="c1"># we obtain the final mask, containing only peaks,</span>
    <span class="c1"># by removing the background from the local_max mask (xor operation)</span>
    <span class="n">detected_peaks</span> <span class="o">=</span> <span class="n">local_max</span> <span class="o">^</span> <span class="n">eroded_background</span>

    <span class="k">return</span> <span class="n">detected_peaks</span></div>


<div class="viewcode-block" id="clean_target_spikes"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.clean_target_spikes">[docs]</a><span class="k">def</span> <span class="nf">clean_target_spikes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">saturation</span><span class="p">):</span>
    <span class="n">saturated_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">saturation</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">saturated_pixels</span><span class="p">]</span> <span class="o">=</span> <span class="n">saturation</span>
    <span class="n">NY</span><span class="p">,</span> <span class="n">NX</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">saturated_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">saturated_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">grady</span><span class="p">,</span> <span class="n">gradx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># if grady[iy,ix]  &gt; 0.8*np.max(grady) :</span>
                <span class="c1">#    data[iy,ix] = data[iy-1,ix]</span>
                <span class="c1"># if grady[iy,ix]  &lt; 0.8*np.min(grady) :</span>
                <span class="c1">#    data[iy,ix] = data[iy+1,ix]</span>
                <span class="k">if</span> <span class="n">gradx</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gradx</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">gradx</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">gradx</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">saturated_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">saturation</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">saturated_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="plot_image_simple"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.plot_image_simple">[docs]</a><span class="k">def</span> <span class="nf">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;Image units&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">target_pixcoords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple function to plot a spectrum with error bars and labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax: Axes</span>
<span class="sd">        Axes instance to make the plot</span>
<span class="sd">    data: array_like</span>
<span class="sd">        The image data 2D array.</span>
<span class="sd">    scale: str</span>
<span class="sd">        Scaling of the image (choose between: lin, log or log10) (default: lin)</span>
<span class="sd">    title: str</span>
<span class="sd">        Title of the image (default: &quot;&quot;)</span>
<span class="sd">    units: str</span>
<span class="sd">        Units of the image to be written in the color bar label (default: &quot;Image units&quot;)</span>
<span class="sd">    cmap: colormap</span>
<span class="sd">        Color map label (default: None)</span>
<span class="sd">    target_pixcoords: array_like, optional</span>
<span class="sd">        2D array  giving the (x,y) coordinates of the targets on the image: add a scatter plot (default: None)</span>
<span class="sd">    vmin: float</span>
<span class="sd">        Minimum value of the image (default: None)</span>
<span class="sd">    vmax: float</span>
<span class="sd">        Maximum value of the image (default: None)</span>
<span class="sd">    aspect: str</span>
<span class="sd">        Aspect keyword to be passed to imshow (default: None)</span>
<span class="sd">    cax: Axes, optional</span>
<span class="sd">        Color bar axes if necessary (default: None).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; from spectractor.extractor.images import Image</span>
<span class="sd">    &gt;&gt;&gt; f, ax = plt.subplots(1,1)</span>
<span class="sd">    &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">    &gt;&gt;&gt; plot_image_simple(ax, im.data, scale=&quot;log10&quot;, units=&quot;ADU&quot;, target_pixcoords=(815,580),</span>
<span class="sd">    ...                     title=&quot;tests/data/reduc_20170605_028.fits&quot;)</span>
<span class="sd">    &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span> <span class="ow">or</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;log10&quot;</span><span class="p">:</span>
        <span class="c1"># removes the zeros and negative pixels first</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">min_noz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="n">data</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_noz</span>
        <span class="c1"># apply log</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;silver&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">set_powerlimits</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> scale)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">scale</span><span class="p">))</span>  <span class="c1"># ,fontsize=16)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target_pixcoords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_spectrum_simple"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.plot_spectrum_simple">[docs]</a><span class="k">def</span> <span class="nf">plot_spectrum_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple function to plot a spectrum with error bars and labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax: Axes</span>
<span class="sd">        Axes instance to make the plot</span>
<span class="sd">    xlim: list, optional</span>
<span class="sd">        List of minimum and maximum abscisses</span>
<span class="sd">    color: str</span>
<span class="sd">        String for the color of the spectrum (default: &#39;r&#39;)</span>
<span class="sd">    label: str</span>
<span class="sd">        String label for the plot legend</span>
<span class="sd">    lambdas: array, optional</span>
<span class="sd">        The wavelengths array if it has been given externally (default: None)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; from spectractor.extractor.spectrum import Spectrum</span>
<span class="sd">    &gt;&gt;&gt; f, ax = plt.subplots(1,1)</span>
<span class="sd">    &gt;&gt;&gt; s = Spectrum(file_name=&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">    &gt;&gt;&gt; plot_spectrum_simple(ax, s.lambdas, s.data, data_err=s.err, xlim=[500,700], color=&#39;r&#39;, label=&#39;test&#39;)</span>
<span class="sd">    &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">lambdas</span>
    <span class="k">if</span> <span class="n">xs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{color}</span><span class="s1">o&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{color}</span><span class="s1">-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lambdas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lambdas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\lambda$ [nm]&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">units</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Flux [</span><span class="si">{units}</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Flux&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_fits"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.load_fits">[docs]</a><span class="k">def</span> <span class="nf">load_fits</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">hdu_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">hdu_list</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="n">hdu_index</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">hdu_list</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># need to free allocation for file descripto</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span></div>


<div class="viewcode-block" id="extract_info_from_CTIO_header"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.extract_info_from_CTIO_header">[docs]</a><span class="k">def</span> <span class="nf">extract_info_from_CTIO_header</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">date_obs</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">expo</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTERS&#39;</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER1&#39;</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">disperser_label</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER2&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="save_fits"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.save_fits">[docs]</a><span class="k">def</span> <span class="nf">save_fits</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>


<div class="viewcode-block" id="dichotomie"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.dichotomie">[docs]</a><span class="k">def</span> <span class="nf">dichotomie</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dichotomie method to find a function root.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f: callable</span>
<span class="sd">        The function</span>
<span class="sd">    a: float</span>
<span class="sd">        Left bound to the expected root</span>
<span class="sd">    b: float</span>
<span class="sd">        Right bound to the expected root</span>
<span class="sd">    epsilon: float</span>
<span class="sd">        Precision</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    root: float</span>
<span class="sd">        The root of the function.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Search for the Gaussian FWHM:</span>
<span class="sd">    &gt;&gt;&gt; p = [1,0,1]</span>
<span class="sd">    &gt;&gt;&gt; xx = np.arange(-10,10,0.1)</span>
<span class="sd">    &gt;&gt;&gt; PSF = gauss(xx, *p)</span>
<span class="sd">    &gt;&gt;&gt; def eq(x):</span>
<span class="sd">    ...     return np.interp(x, xx, PSF) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; root = dichotomie(eq, 0, 10, 1e-6)</span>
<span class="sd">    &gt;&gt;&gt; assert np.isclose(2*root, 2.355*p[2], 1e-3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">epsilon</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="wavelength_to_rgb"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.wavelength_to_rgb">[docs]</a><span class="k">def</span> <span class="nf">wavelength_to_rgb</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; taken from http://www.noah.org/wiki/Wavelength_to_RGB_in_Python</span>
<span class="sd">    This converts a given wavelength of light to an</span>
<span class="sd">    approximate RGB color value. The wavelength must be given</span>
<span class="sd">    in nanometers in the range from 380 nm through 750 nm</span>
<span class="sd">    (789 THz through 400 THz).</span>

<span class="sd">    Based on code by Dan Bruton</span>
<span class="sd">    http://www.physics.sfasu.edu/astro/color/spectra.html</span>
<span class="sd">    Additionally alpha value set to 0.5 outside range</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">380</span> <span class="o">&lt;=</span> <span class="n">wavelength</span> <span class="o">&lt;=</span> <span class="mi">750</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">wavelength</span> <span class="o">&lt;</span> <span class="mi">380</span><span class="p">:</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">380.</span>
    <span class="k">if</span> <span class="n">wavelength</span> <span class="o">&gt;</span> <span class="mi">750</span><span class="p">:</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">750.</span>
    <span class="k">if</span> <span class="mi">380</span> <span class="o">&lt;=</span> <span class="n">wavelength</span> <span class="o">&lt;=</span> <span class="mi">440</span><span class="p">:</span>
        <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">-</span> <span class="mi">380</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">440</span> <span class="o">-</span> <span class="mi">380</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="p">(</span><span class="n">wavelength</span> <span class="o">-</span> <span class="mi">440</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">440</span> <span class="o">-</span> <span class="mi">380</span><span class="p">))</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">)</span> <span class="o">**</span> <span class="n">gamma</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">)</span> <span class="o">**</span> <span class="n">gamma</span>
    <span class="k">elif</span> <span class="mi">440</span> <span class="o">&lt;=</span> <span class="n">wavelength</span> <span class="o">&lt;=</span> <span class="mi">490</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">((</span><span class="n">wavelength</span> <span class="o">-</span> <span class="mi">440</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">490</span> <span class="o">-</span> <span class="mi">440</span><span class="p">))</span> <span class="o">**</span> <span class="n">gamma</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="mi">490</span> <span class="o">&lt;=</span> <span class="n">wavelength</span> <span class="o">&lt;=</span> <span class="mi">510</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">wavelength</span> <span class="o">-</span> <span class="mi">510</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">510</span> <span class="o">-</span> <span class="mi">490</span><span class="p">))</span> <span class="o">**</span> <span class="n">gamma</span>
    <span class="k">elif</span> <span class="mi">510</span> <span class="o">&lt;=</span> <span class="n">wavelength</span> <span class="o">&lt;=</span> <span class="mi">580</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">((</span><span class="n">wavelength</span> <span class="o">-</span> <span class="mi">510</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">580</span> <span class="o">-</span> <span class="mi">510</span><span class="p">))</span> <span class="o">**</span> <span class="n">gamma</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="mi">580</span> <span class="o">&lt;=</span> <span class="n">wavelength</span> <span class="o">&lt;=</span> <span class="mi">645</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">wavelength</span> <span class="o">-</span> <span class="mi">645</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">645</span> <span class="o">-</span> <span class="mi">580</span><span class="p">))</span> <span class="o">**</span> <span class="n">gamma</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="mi">645</span> <span class="o">&lt;=</span> <span class="n">wavelength</span> <span class="o">&lt;=</span> <span class="mi">750</span><span class="p">:</span>
        <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">750</span> <span class="o">-</span> <span class="n">wavelength</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">750</span> <span class="o">-</span> <span class="mi">645</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">)</span> <span class="o">**</span> <span class="n">gamma</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span></div>


<div class="viewcode-block" id="from_lambda_to_colormap"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.from_lambda_to_colormap">[docs]</a><span class="k">def</span> <span class="nf">from_lambda_to_colormap</span><span class="p">(</span><span class="n">lambdas</span><span class="p">):</span>
    <span class="n">colorlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wavelength_to_rgb</span><span class="p">(</span><span class="n">lbda</span><span class="p">)</span> <span class="k">for</span> <span class="n">lbda</span> <span class="ow">in</span> <span class="n">lambdas</span><span class="p">]</span>
    <span class="n">spectralmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;spectrum&quot;</span><span class="p">,</span> <span class="n">colorlist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spectralmap</span></div>


<div class="viewcode-block" id="rebin"><a class="viewcode-back" href="../../source/spectractor.html#spectractor.tools.rebin">[docs]</a><span class="k">def</span> <span class="nf">rebin</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="c1"># if np.__version__ &gt;= &quot;1.14.0&quot;:</span>
    <span class="c1">#    np.set_printoptions(legacy=&quot;1.13&quot;)</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jeremy Neveu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>