

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectractor.fit.fitter &mdash; Spectractor 1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'1.1',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Spectractor
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spectractor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>spectractor.fit.fitter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectractor.fit.fitter</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="k">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span> <span class="nn">spectractor.simulation.simulator</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">spectractor.fit.statistics</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">spectractor.parameters</span> <span class="k">import</span> <span class="n">FIT_WORKSPACE</span> <span class="k">as</span> <span class="n">fit_workspace</span>

<span class="kn">from</span> <span class="nn">iminuit</span> <span class="k">import</span> <span class="n">Minuit</span>

<span class="kn">import</span> <span class="nn">emcee</span>
<span class="kn">from</span> <span class="nn">emcee.utils</span> <span class="k">import</span> <span class="n">MPIPool</span>

<span class="kn">import</span> <span class="nn">time</span>


<div class="viewcode-block" id="FitWorkspace"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace">[docs]</a><span class="k">class</span> <span class="nc">FitWorkspace</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">atmgrid_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">live_fit</span> <span class="o">=</span> <span class="n">live_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_noconv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">((),</span> <span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="n">nsteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span> <span class="o">=</span> <span class="n">burnin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">SimulatorInit</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AIRMASS&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTPRESS&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OUTTEMP&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_grid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">atmgrid_file_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">Atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_grid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span> <span class="o">=</span> <span class="n">AtmosphereGrid</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">atmgrid_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Use atmospheric grid models from file </span><span class="si">{atmgrid_filename}</span><span class="s1">. &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">atmo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">atmo</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pwv=</span><span class="si">%d</span><span class="s1">mm&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$\lambda$ [nm]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Atmospheric transmission&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<div class="viewcode-block" id="FitWorkspace.set_start"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.set_start">[docs]</a>    <span class="k">def</span> <span class="nf">set_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span></div>

<div class="viewcode-block" id="FitWorkspace.build_flat_chains"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.build_flat_chains">[docs]</a>    <span class="k">def</span> <span class="nf">build_flat_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_chains</span></div>

<div class="viewcode-block" id="FitWorkspace.analyze_chains"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.analyze_chains">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_chain_validity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_tests</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_flat_chains</span><span class="p">()</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain2likelihood</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">likelihood</span><span class="o">.</span><span class="n">mean_vec</span>
        <span class="n">simulate</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SpectrumFitWorkspace</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SpectrogramFitWorkspace</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span>
        <span class="n">figure_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_triangle.pdf&#39;</span><span class="p">)</span>
        <span class="n">likelihood</span><span class="o">.</span><span class="n">triangle_plots</span><span class="p">(</span><span class="n">output_filename</span><span class="o">=</span><span class="n">figure_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="FitWorkspace.save_bestfit_parameters"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.save_bestfit_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">save_bestfit_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="FitWorkspace.chain2likelihood"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.chain2likelihood">[docs]</a>    <span class="k">def</span> <span class="nf">chain2likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdfonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">walker_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">walker_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">walker_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_chains</span>
        <span class="n">rangedim</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">chains</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rangedim</span><span class="p">:</span>
            <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">chains</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">chains</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">Likelihood</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_labels</span><span class="p">,</span> <span class="n">axis_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_names</span><span class="p">,</span> <span class="n">truth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">truth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">walker_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rangedim</span><span class="p">:</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_histogram</span><span class="p">(</span><span class="n">chains</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pdfonly</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">rangedim</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                            <span class="n">likelihood</span><span class="o">.</span><span class="n">contours</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">fill_histogram</span><span class="p">(</span><span class="n">chains</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">chains</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_bestfit.txt&#39;</span><span class="p">)</span>
            <span class="n">likelihood</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">likelihood</span></div>

<div class="viewcode-block" id="FitWorkspace.compute_local_acceptance_rate"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.compute_local_acceptance_rate">[docs]</a>    <span class="k">def</span> <span class="nf">compute_local_acceptance_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">last_index</span><span class="p">,</span> <span class="n">walker_index</span><span class="p">):</span>
        <span class="n">frequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">test</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span><span class="p">[</span><span class="n">walker_index</span><span class="p">,</span> <span class="n">start_index</span><span class="p">]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_index</span><span class="p">):</span>
            <span class="n">chi2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span><span class="p">[</span><span class="n">walker_index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
                <span class="n">counts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">counts</span><span class="p">))</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">chi2</span>
        <span class="n">frequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frequences</span><span class="p">)</span></div>

<div class="viewcode-block" id="FitWorkspace.set_chain_validity"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.set_chain_validity">[docs]</a>    <span class="k">def</span> <span class="nf">set_chain_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nchains</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)]</span>
        <span class="n">chisq_averages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chisq_std</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nchains</span><span class="p">:</span>
            <span class="n">chisqs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chisqs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e5</span><span class="p">:</span>
                <span class="n">chisq_averages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chisqs</span><span class="p">))</span>
                <span class="n">chisq_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">chisqs</span><span class="p">))</span>
        <span class="n">global_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chisq_averages</span><span class="p">)</span>
        <span class="n">global_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chisq_std</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nchains</span><span class="p">:</span>
            <span class="n">chisqs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:]</span>
            <span class="n">chisq_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chisqs</span><span class="p">)</span>
            <span class="n">chisq_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">chisqs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chisq_average</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">global_std</span> <span class="o">+</span> <span class="n">global_average</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">chisq_std</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">global_std</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span></div>

<div class="viewcode-block" id="FitWorkspace.convergence_tests"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.convergence_tests">[docs]</a>    <span class="k">def</span> <span class="nf">convergence_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># .reshape((-1, self.ndim))</span>
        <span class="n">nchains</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">)</span>
        <span class="c1"># Chi2 vs Index</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Chisq statistics:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nchains</span><span class="p">:</span>
            <span class="n">chisqs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Walker </span><span class="si">{k:d}</span><span class="s2">: {float(np.mean(chisqs)):.3f} +/- {float(np.std(chisqs)):.3f}&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; -&gt; excluded&quot;</span>
                <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">chisqs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">chisqs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">global_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:])</span>
        <span class="n">global_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnprobs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:])</span>
        <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">global_average</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">global_std</span><span class="p">,</span> <span class="n">global_average</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">global_std</span><span class="p">])</span>
        <span class="c1"># Parameter vs Index</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Parameter vs Index plots...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nchains</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">chains</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">chains</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\chi^2$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Steps&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># Acceptance rate vs Index</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing acceptance rate...&quot;</span><span class="p">)</span>
        <span class="n">min_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
        <span class="n">window</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">min_len</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nchains</span><span class="p">:</span>
                <span class="n">ARs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">burnin</span> <span class="o">+</span> <span class="n">window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
                    <span class="n">ARs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_local_acceptance_rate</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">window</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">ARs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;Walker </span><span class="si">{k:d}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">ARs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;Walker </span><span class="si">{k:d}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Steps&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Aceptance rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="c1"># ax[self.dim + 1, 2].legend(loc=&#39;upper left&#39;, ncol=2, fontsize=10)</span>
        <span class="c1"># Parameter PDFs by chain</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing chain by chain PDFs...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nchains</span><span class="p">:</span>
            <span class="n">likelihood</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain2likelihood</span><span class="p">(</span><span class="n">pdfonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">walker_index</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="n">likelihood</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">pdfonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Gelman-Rubin test</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nchains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">)</span> <span class="o">//</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">gelman_rubins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Gelman-Rubin tests (burnin=</span><span class="si">{self.burnin:d}</span><span class="s1">, step=</span><span class="si">{step:d}</span><span class="s1">, nsteps=</span><span class="si">{self.nsteps:d}</span><span class="s1">):&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">Rs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">lens</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">burnin</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                    <span class="n">chain_averages</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">chain_variances</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">global_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nchains</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_chains</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                            <span class="k">continue</span>
                        <span class="n">chain_averages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
                        <span class="n">chain_variances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnin</span><span class="p">:</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chain_variances</span><span class="p">)</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain_averages</span><span class="p">)):</span>
                        <span class="n">B</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chain_averages</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">global_average</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="n">B</span> <span class="o">*=</span> <span class="p">((</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain_averages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">*</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">/</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain_averages</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain_averages</span><span class="p">))</span> <span class="o">/</span> <span class="n">W</span>
                    <span class="n">Rs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">lens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">gelman_rubins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{self.input_labels[i]}</span><span class="s1">: R-1 = </span><span class="si">{Rs[-1]:.3f}</span><span class="s1"> (l = {lens[-1] - 1:d})&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lens</span><span class="p">,</span> <span class="n">Rs</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Walker length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$R-1$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
                <span class="c1"># ax[self.dim, 3].legend(loc=&#39;best&#39;, ncol=2, fontsize=10)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span> <span class="ow">and</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">figure_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_convergence.pdf&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Save figure: </span><span class="si">{figure_name}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figure_name</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_convergence.txt&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Save: </span><span class="si">{output_file}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.input_labels[i]}</span><span class="s1"> </span><span class="si">{gelman_rubins[i]}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="FitWorkspace.print_settings"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.FitWorkspace.print_settings">[docs]</a>    <span class="k">def</span> <span class="nf">print_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;************************************&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Input file: </span><span class="si">{self.file_name}</span><span class="se">\n</span><span class="s2">Walkers: </span><span class="si">{self.nwalkers}</span><span class="se">\t</span><span class="s2"> Steps: </span><span class="si">{self.nsteps}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;************************************&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SpectrumFitWorkspace"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrumFitWorkspace">[docs]</a><span class="k">class</span> <span class="nc">SpectrumFitWorkspace</span><span class="p">(</span><span class="n">FitWorkspace</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">atmgrid_filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">FitWorkspace</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">atmgrid_filename</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burnin</span><span class="p">,</span> <span class="n">nbins</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span>
                              <span class="n">live_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A1</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A2</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ozone</span> <span class="o">=</span> <span class="mf">300.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwv</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aerosols</span> <span class="o">=</span> <span class="mf">0.03</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reso</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXSHIFT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">A1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ozone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aerosols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A1&quot;</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">,</span> <span class="s2">&quot;ozone&quot;</span><span class="p">,</span> <span class="s2">&quot;PWV&quot;</span><span class="p">,</span> <span class="s2">&quot;VAOD&quot;</span><span class="p">,</span> <span class="s2">&quot;reso [pix]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;D_CCD [mm]&quot;</span><span class="p">,</span>
                             <span class="sa">r</span><span class="s2">&quot;alpha_pix [pix]&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$A_1$&quot;</span><span class="p">,</span> <span class="s2">&quot;$A_2$&quot;</span><span class="p">,</span> <span class="s2">&quot;ozone&quot;</span><span class="p">,</span> <span class="s2">&quot;PWV&quot;</span><span class="p">,</span> <span class="s2">&quot;VAOD&quot;</span><span class="p">,</span> <span class="s2">&quot;reso [pix]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$D_</span><span class="si">{CCD}</span><span class="s2">$ [mm]&quot;</span><span class="p">,</span>
                           <span class="sa">r</span><span class="s2">&quot;$\alpha_{\mathrm</span><span class="si">{pix}</span><span class="s2">}$ [pix]&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">SpectrumSimulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_truth</span><span class="p">()</span>

<div class="viewcode-block" id="SpectrumFitWorkspace.get_truth"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrumFitWorkspace.get_truth">[docs]</a>    <span class="k">def</span> <span class="nf">get_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;A1&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">A1_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span>
            <span class="n">A2_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span>
            <span class="n">ozone_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OZONE&#39;</span><span class="p">]</span>
            <span class="n">pwv_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PWV&#39;</span><span class="p">]</span>
            <span class="n">aerosols_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;VAOD&#39;</span><span class="p">]</span>
            <span class="n">reso_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RESO&#39;</span><span class="p">]</span>
            <span class="n">D_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span>
            <span class="n">shift_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;X0SHIFT&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="o">=</span> <span class="p">(</span><span class="n">A1_truth</span><span class="p">,</span> <span class="n">A2_truth</span><span class="p">,</span> <span class="n">ozone_truth</span><span class="p">,</span> <span class="n">pwv_truth</span><span class="p">,</span> <span class="n">aerosols_truth</span><span class="p">,</span>
                          <span class="n">reso_truth</span><span class="p">,</span> <span class="n">D_truth</span><span class="p">,</span> <span class="n">shift_truth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SpectrumFitWorkspace.plot_spectrum_comparison_simple"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrumFitWorkspace.plot_spectrum_comparison_simple">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrum_comparison_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lambdas</span> <span class="o">&gt;</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lambdas</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lambdas</span> <span class="o">&gt;</span> <span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lambdas</span> <span class="o">&lt;</span> <span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">plot_spectrum_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">lambdas</span><span class="o">=</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
        <span class="c1"># ax.plot(self.lambdas, self.model_noconv, label=&#39;before conv&#39;)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">residuals_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">residuals_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">residuals_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_err</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="o">-</span><span class="n">residuals_model</span><span class="p">,</span> <span class="n">residuals_model</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="n">sub</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">std</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">())</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;(data-fit)/fit&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sub</span><span class="p">]),</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sub</span><span class="p">])))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectrumFitWorkspace.plot_fit"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrumFitWorkspace.plot_fit">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
        <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">reso</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;A1=</span><span class="si">{A1:.3f}</span><span class="s1">, A2=</span><span class="si">{A2:.3f}</span><span class="s1">, PWV=</span><span class="si">{pwv:.3f}</span><span class="s1">, OZ=</span><span class="si">{ozone:.3g}</span><span class="s1">, VAOD=</span><span class="si">{aerosols:.3f}</span><span class="s1">,</span><span class="se">\n</span><span class="s1"> &#39;</span> \
                     <span class="n">f</span><span class="s1">&#39;reso=</span><span class="si">{reso:.2f}</span><span class="s1">pix, D=</span><span class="si">{D:.2f}</span><span class="s1">mm, shift=</span><span class="si">{shift:.2f}</span><span class="s1">pix &#39;</span>
        <span class="c1"># main plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrum_comparison_simple</span><span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="c1"># zoom O2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrum_comparison_simple</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">730</span><span class="p">,</span> <span class="mi">800</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Zoom $O_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="c1"># zoom H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrum_comparison_simple</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">870</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Zoom $H_2 O$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_fit</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span> <span class="ow">and</span> <span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">figname</span> <span class="o">=</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_bestfit.pdf&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Save figure: </span><span class="si">{figname}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SpectrogramFitWorkspace"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrogramFitWorkspace">[docs]</a><span class="k">class</span> <span class="nc">SpectrogramFitWorkspace</span><span class="p">(</span><span class="n">FitWorkspace</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">atmgrid_filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">FitWorkspace</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">atmgrid_filename</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burnin</span><span class="p">,</span> <span class="n">nbins</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span>
                              <span class="n">live_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A1</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A2</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ozone</span> <span class="o">=</span> <span class="mf">300.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwv</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aerosols</span> <span class="o">=</span> <span class="mf">0.03</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_table_to_poly_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_Nx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;a</span><span class="si">{k}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;$a_</span><span class="si">{k}</span><span class="s2">$&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">set_bounds</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXSHIFT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_y</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_t</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">rotation_angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">A1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ozone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aerosols</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A1&quot;</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">,</span> <span class="s2">&quot;ozone&quot;</span><span class="p">,</span> <span class="s2">&quot;PWV&quot;</span><span class="p">,</span> <span class="s2">&quot;VAOD&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;D_CCD [mm]&quot;</span><span class="p">,</span>
                             <span class="sa">r</span><span class="s2">&quot;shift_x [pix]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;shift_y [pix]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;shift_T [nm]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$A_1$&quot;</span><span class="p">,</span> <span class="s2">&quot;$A_2$&quot;</span><span class="p">,</span> <span class="s2">&quot;ozone&quot;</span><span class="p">,</span> <span class="s2">&quot;PWV&quot;</span><span class="p">,</span> <span class="s2">&quot;VAOD&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$D_</span><span class="si">{CCD}</span><span class="s2">$ [mm]&quot;</span><span class="p">,</span>
                           <span class="sa">r</span><span class="s2">&quot;$\Delta_{\mathrm</span><span class="si">{x}</span><span class="s2">}$ [pix]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\Delta_{\mathrm</span><span class="si">{y}</span><span class="s2">}$ [pix]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\Delta_{\mathrm</span><span class="si">{T}</span><span class="s2">}$ [nm]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\theta&quot;</span><span class="p">]</span> <span class="o">+</span> \
                          <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_poly_params_bounds</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">SpectrogramModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrogram_truth</span><span class="p">()</span>

<div class="viewcode-block" id="SpectrogramFitWorkspace.get_spectrogram_truth"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrogramFitWorkspace.get_spectrogram_truth">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrogram_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;A1&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">A1_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span>
            <span class="n">A2_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span>
            <span class="n">ozone_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OZONE&#39;</span><span class="p">]</span>
            <span class="n">pwv_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PWV&#39;</span><span class="p">]</span>
            <span class="n">aerosols_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;VAOD&#39;</span><span class="p">]</span>
            <span class="n">D_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span>
            <span class="c1"># shift_x_truth = self.spectrum.header[&#39;X0SHIFT&#39;]</span>
            <span class="c1"># shift_y_truth = self.spectrum.header[&#39;Y0SHIFT&#39;]</span>
            <span class="n">angle_truth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="o">=</span> <span class="p">(</span><span class="n">A1_truth</span><span class="p">,</span> <span class="n">A2_truth</span><span class="p">,</span> <span class="n">ozone_truth</span><span class="p">,</span> <span class="n">pwv_truth</span><span class="p">,</span> <span class="n">aerosols_truth</span><span class="p">,</span>
                          <span class="n">D_truth</span><span class="p">,</span> <span class="n">angle_truth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">truth</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SpectrogramFitWorkspace.plot_spectrogram_comparison_simple"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrogramFitWorkspace.plot_spectrogram_comparison_simple">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrogram_comparison_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dispersion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lambdas</span> <span class="o">&gt;</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lambdas</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lambdas</span> <span class="o">&gt;</span> <span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lambdas</span> <span class="o">&lt;</span> <span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">[:,</span> <span class="n">sub</span><span class="p">])</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[:,</span> <span class="n">sub</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">units</span><span class="o">=</span><span class="s1">&#39;1/max(data)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dispersion</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">][</span><span class="n">sub</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_y0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">][</span><span class="n">sub</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_x0</span> <span class="o">-</span> <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">from_lambda_to_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]]),</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                             <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]],</span>
                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># p0 = ax.plot(lambdas, self.model(lambdas), label=&#39;model&#39;)</span>
        <span class="c1"># # ax.plot(self.lambdas, self.model_noconv, label=&#39;before conv&#39;)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">residuals_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals</span><span class="p">[:,</span> <span class="n">sub</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">residuals</span><span class="p">[:,</span> <span class="n">sub</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">5</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Data-Model&#39;</span><span class="p">,</span>
                          <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;1/max(data)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data-Model&#39;</span><span class="p">,</span>  <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># ax[0, 0].get_yaxis().set_label_coords(-0.15, 0.6)</span>
        <span class="c1"># ax[2, 0].get_yaxis().set_label_coords(-0.15, 0.5)</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">[:,</span> <span class="n">sub</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                          <span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;1/max(data)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span>  <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="c1"># remove the underlying axes</span>
        <span class="c1">#for ax in ax[3, 1]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">sub</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="n">sub</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">sub</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cross spectrum&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\lambda$ [nm]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectrogramFitWorkspace.plot_fit"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.SpectrogramFitWorkspace.plot_fit">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; file_name = &#39;outputs/reduc_20170530_130_spectrum.fits&#39;</span>
<span class="sd">        &gt;&gt;&gt; atmgrid_filename = file_name.replace(&#39;sim&#39;, &#39;reduc&#39;).replace(&#39;spectrum&#39;, &#39;atmsim&#39;)</span>
<span class="sd">        &gt;&gt;&gt; fit_workspace = SpectrogramFitWorkspace(file_name, atmgrid_filename=atmgrid_filename, nwalkers=28, nsteps=20000, burnin=10000,</span>
<span class="sd">        ... nbins=10, verbose=1, plot=True, live_fit=False)</span>
<span class="sd">        &gt;&gt;&gt; A1, A2, ozone, pwv, aerosols, D, shift_x, shift_y, shift_t, angle, *psf = fit_workspace.p</span>
<span class="sd">        &gt;&gt;&gt; lambdas, model, model_err = fit_workspace.simulation.simulate(A1, A2, ozone, pwv, aerosols, D, shift_x, shift_y, shift_t, angle, psf)</span>
<span class="sd">        &gt;&gt;&gt; fit_workspace.lambdas = lambdas</span>
<span class="sd">        &gt;&gt;&gt; fit_workspace.model = model</span>
<span class="sd">        &gt;&gt;&gt; fit_workspace.model_err = model_err</span>
<span class="sd">        &gt;&gt;&gt; fit_workspace.plot_fit()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gs_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">],</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">gs_kw</span><span class="p">)</span>

        <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="o">*</span><span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;A1=</span><span class="si">{A1:.3f}</span><span class="s1">, A2=</span><span class="si">{A2:.3f}</span><span class="s1">, PWV=</span><span class="si">{pwv:.3f}</span><span class="s1">, OZ=</span><span class="si">{ozone:.3g}</span><span class="s1">, VAOD=</span><span class="si">{aerosols:.3f}</span><span class="s1">, &#39;</span>
                     <span class="n">f</span><span class="s1">&#39;D=</span><span class="si">{D:.2f}</span><span class="s1">mm, shift_x=</span><span class="si">{shift_x:.2f}</span><span class="s1">pix, shift_y=</span><span class="si">{shift_y:.2f}</span><span class="s1">pix, shift_t=</span><span class="si">{shift_t:.2f}</span><span class="s1">nm, angle=</span><span class="si">{angle:.2f}</span><span class="s1"> &#39;</span><span class="p">)</span>
        <span class="c1"># main plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrogram_comparison_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spectrogram model&#39;</span><span class="p">,</span> <span class="n">dispersion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># zoom O2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrogram_comparison_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">730</span><span class="p">,</span> <span class="mi">800</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Zoom $O_2$&#39;</span><span class="p">,</span> <span class="n">dispersion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># zoom H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrogram_comparison_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">870</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Zoom $H_2 O$&#39;</span><span class="p">,</span> <span class="n">dispersion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># fig.tight_layout()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_fit</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_bestfit.pdf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Save figure: </span><span class="si">{figname}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="simulate"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.simulate">[docs]</a><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="o">*</span><span class="n">psf_poly_params</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tttt&#39;</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">fix_psf_cube</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">psf_poly_params</span><span class="p">,</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)):</span>
        <span class="n">fit_workspace</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">fix_psf_cube</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">lambdas</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_err</span> <span class="o">=</span> \
        <span class="n">fit_workspace</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">psf_poly_params</span><span class="p">)</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_t</span><span class="p">,</span> <span class="n">angle</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">psf_poly_params</span><span class="p">)</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">model_err</span> <span class="o">=</span> <span class="n">model_err</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;oooo after computation&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">live_fit</span><span class="p">:</span>
        <span class="c1">#fit_workspace.plot_fit()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;oooo after plot&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_err</span></div>


<div class="viewcode-block" id="weighted_residuals"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.weighted_residuals">[docs]</a><span class="k">def</span> <span class="nf">weighted_residuals</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">lambdas</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_err</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">((</span><span class="n">model</span> <span class="o">-</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">)</span>  <span class="o">/</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_err</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cc&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="chisq_spectrogram"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.chisq_spectrogram">[docs]</a><span class="k">def</span> <span class="nf">chisq_spectrogram</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">weighted_residuals</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cc&#39;</span><span class="p">,</span> <span class="n">chisq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span></div>


<div class="viewcode-block" id="lnlike_spectrogram"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.lnlike_spectrogram">[docs]</a><span class="k">def</span> <span class="nf">lnlike_spectrogram</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">chisq_spectrogram</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="lnprob_spectrogram"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.lnprob_spectrogram">[docs]</a><span class="k">def</span> <span class="nf">lnprob_spectrogram</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">lnprior</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lp</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1e20</span>
    <span class="k">return</span> <span class="n">lp</span> <span class="o">+</span> <span class="n">lnlike_spectrogram</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="simulate"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.simulate">[docs]</a><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">reso</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="n">lambdas</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_err</span> <span class="o">=</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">ozone</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">aerosols</span><span class="p">,</span> <span class="n">reso</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="c1"># if fit_workspace.live_fit:</span>
    <span class="c1">#    fit_workspace.plot_fit()</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">model_err</span> <span class="o">=</span> <span class="n">model_err</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">(</span><span class="n">fit_workspace</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span><span class="p">),</span> <span class="n">model_err</span><span class="p">(</span><span class="n">fit_workspace</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span></div>


<div class="viewcode-block" id="chisq"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.chisq">[docs]</a><span class="k">def</span> <span class="nf">chisq</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="n">chisquare</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">model</span> <span class="o">-</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">err</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">err</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1"># chisq /= self.spectrum.data.size</span>
    <span class="c1"># print &#39;\tReduced chisq =&#39;,chisq/self.spectrum.data.size</span>
    <span class="k">return</span> <span class="n">chisquare</span></div>


<div class="viewcode-block" id="lnprior"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.lnprior">[docs]</a><span class="k">def</span> <span class="nf">lnprior</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
    <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">npar</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">par</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">npar</span><span class="p">]</span> <span class="ow">or</span> <span class="n">par</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">npar</span><span class="p">]:</span>
            <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">in_bounds</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span></div>


<div class="viewcode-block" id="lnlike"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.lnlike">[docs]</a><span class="k">def</span> <span class="nf">lnlike</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">chisq</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="lnprob"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.lnprob">[docs]</a><span class="k">def</span> <span class="nf">lnprob</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">lnprior</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lp</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1e20</span>
    <span class="k">return</span> <span class="n">lp</span> <span class="o">+</span> <span class="n">lnlike</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="sort_on_runtime"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.sort_on_runtime">[docs]</a><span class="k">def</span> <span class="nf">sort_on_runtime</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">depth_index</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="n">depth_index</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">idx</span></div>


<div class="viewcode-block" id="run_minimisation"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.run_minimisation">[docs]</a><span class="k">def</span> <span class="nf">run_minimisation</span><span class="p">():</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">bounds</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_workspace</span><span class="p">,</span> <span class="n">SpectrumFitWorkspace</span><span class="p">):</span>
        <span class="n">nll</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">lnlike</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_workspace</span><span class="p">,</span> <span class="n">SpectrogramFitWorkspace</span><span class="p">):</span>
        <span class="n">nll</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">lnlike_spectrogram</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Unknown fit_workspace class type {type(fit_workspace)}.</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="n">f</span><span class="s1">&#39;Choose either &quot;SpectrumFitWorkspace&quot; of &quot;SpectrogramFitWorkspace&quot;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c1"># result = minimize(nll, fit_workspace.p, method=&#39;L-BFGS-B&#39;,</span>
    <span class="c1">#                   options={&#39;ftol&#39;: 1e-20, &#39;xtol&#39;: 1e-20, &#39;gtol&#39;: 1e-20, &#39;disp&#39;: True, &#39;maxiter&#39;: 100000,</span>
    <span class="c1">#                            &#39;maxls&#39;: 50, &#39;maxcor&#39;: 30},</span>
    <span class="c1">#                   bounds=bounds)</span>
    <span class="c1"># fit_workspace.p = result[&#39;x&#39;]</span>
    <span class="c1"># reduc_134</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.1999374575144732</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">55.082071522198056</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6305218866359683</span><span class="p">,</span> <span class="mf">1.0395299151149904</span><span class="p">,</span> <span class="mf">0.1275725960085727</span><span class="p">,</span> <span class="mf">0.5280831133684005</span><span class="p">,</span> <span class="mf">6.235160344247447</span><span class="p">,</span> <span class="mf">6.784917251773036</span><span class="p">,</span> <span class="mf">4.2369845643653115</span><span class="p">,</span> <span class="mf">3.448993463233748</span><span class="p">,</span> <span class="mf">1.6421707683237179</span><span class="p">,</span> <span class="mf">1.9074156099667425</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.09281914503246441</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.27894475572169325</span><span class="p">,</span> <span class="mf">0.12240788960743397</span><span class="p">,</span> <span class="mf">3.9261326346235434</span><span class="p">,</span> <span class="mf">2.7938537263795604</span><span class="p">,</span> <span class="mf">0.43486802733644325</span><span class="p">,</span> <span class="mf">999.9999999999964</span><span class="p">])</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.2045483348683912</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">55.07937441283125</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6305218866359683</span><span class="p">,</span> <span class="mf">1.042808541712434</span><span class="p">,</span> <span class="mf">0.13530636527489748</span><span class="p">,</span> <span class="mf">0.5503986690804731</span><span class="p">,</span> <span class="mf">5.33368295428954</span><span class="p">,</span> <span class="mf">5.0841705471792755</span><span class="p">,</span> <span class="mf">3.7713637509390625</span><span class="p">,</span> <span class="mf">3.063271361527012</span><span class="p">,</span> <span class="mf">0.8486787059487655</span><span class="p">,</span> <span class="mf">1.9719045741976886</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05858775474963545</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16956856815728952</span><span class="p">,</span> <span class="mf">0.06644620580104998</span><span class="p">,</span> <span class="mf">4.319269043951657</span><span class="p">,</span> <span class="mf">2.866341144875256</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08709501136597646</span><span class="p">,</span> <span class="mf">520.5744613957937</span><span class="p">])</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.2045483348683912</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">55.07937441283125</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6305218866359683</span><span class="p">,</span> <span class="mf">1.042808541712434</span><span class="p">,</span> <span class="mf">0.13530636527489748</span><span class="p">,</span> <span class="mf">0.5503986690804731</span><span class="p">,</span> <span class="mf">5.33368295428954</span><span class="p">,</span> <span class="mf">5.0841705471792755</span><span class="p">,</span> <span class="mf">3.7713637509390625</span><span class="p">,</span> <span class="mf">3.063271361527012</span><span class="p">,</span> <span class="mf">0.8486787059487655</span><span class="p">,</span> <span class="mf">1.9719045741976886</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05858775474963545</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16956856815728952</span><span class="p">,</span> <span class="mf">0.06644620580104998</span><span class="p">,</span> <span class="mf">4.319269043951657</span><span class="p">,</span> <span class="mf">2.866341144875256</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08709501136597646</span><span class="p">,</span> <span class="mf">520.5744613957937</span><span class="p">])</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.1783004945625857</span><span class="p">,</span> <span class="mf">0.028771175829755774</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">,</span> <span class="mf">3.5788603010605713</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">56.31035877782502</span><span class="p">,</span> <span class="mf">0.001324080414817609</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">27.69406155413207</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.542396612306326</span><span class="p">,</span> <span class="mf">0.11298966008548948</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.396825836448203</span><span class="p">,</span> <span class="mf">0.2060387678061209</span><span class="p">,</span> <span class="mf">2.0649268678546955</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3753936625491252</span><span class="p">,</span> <span class="mf">0.9242067418613167</span><span class="p">,</span> <span class="mf">1.6950153822467129</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6942452135351901</span><span class="p">,</span> <span class="mf">0.3644178350759512</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0028059253333737044</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.003111527339787137</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00347648933169673</span><span class="p">,</span> <span class="mf">528.3594585697788</span><span class="p">,</span> <span class="mf">628.4966480821147</span><span class="p">,</span> <span class="mf">12.438043546369354</span><span class="p">,</span> <span class="mf">499.99999999999835</span><span class="p">])</span>
    <span class="c1"># for _130.fits</span>
    <span class="c1"># guess = np.array(</span>
    <span class="c1">#     [1.0221355184586634, 0.05, 300.0, 3.0, 0.03, 55.45, 0.0, 0.0, -13.9, -0.6305218866359683, 0.9697783937167165,</span>
    <span class="c1">#      -0.23418568011585317, 0.33884422382705437, 6.491300580087118, 7.23813399139167, 3.4442522038396097,</span>
    <span class="c1">#      3.2040421136282338, 2.3246058070491347, 0.8560985887811235, -0.24436185918630957, -0.24696445586018434,</span>
    <span class="c1">#      -0.0028070102515497844, 3.028241966129593, 2.8582943432553085, -0.3948830196355327, 999.9999999999964])</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="mf">1.0739594429903858</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">300.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">55.45</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">13.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6305218866359683</span><span class="p">,</span> <span class="mf">0.9697783937167165</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">0.23418568011585317</span><span class="p">,</span> <span class="mf">0.33884422382705437</span><span class="p">,</span> <span class="mf">6.446415469477438</span><span class="p">,</span>
                             <span class="mf">7.729767353344003</span><span class="p">,</span> <span class="mf">3.398518168281213</span><span class="p">,</span> <span class="mf">3.246584721057184</span><span class="p">,</span> <span class="mf">2.1288614628936395</span><span class="p">,</span>
                             <span class="mf">0.878365118777165</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.22805156531233226</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26791683345602524</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.03629293223130861</span><span class="p">,</span>
                             <span class="mf">3.570264949549503</span><span class="p">,</span> <span class="mf">2.498371135708351</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.29661704517488957</span><span class="p">,</span> <span class="mf">999.9999999999964</span><span class="p">])</span>
    <span class="c1"># sim_134</span>
    <span class="c1"># guess = np.array([1.0200367670106933, 0.0363572740671097, 237.88100163825928, 9.99985583070645, 0.04881224044620258, 55.19390495103511, -1.18481117217888, -0.15902033562208118, 1.720820828790302, -1.681859821533847, 1.4118025344599496, 0.5302750543501547, 0.05486954668604792, 3.72604016525854, -1.296968852142376, 1.0703672456033204, 3.0205592886126813, -0.06300056342451373, 0.9697073189216313, -0.37263561988400884, -0.1330268748184035, -0.05678495440244433, 2.1345811085002606, -0.9857266387263521, -0.07773569454909918, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.0177449875857436, 0.03273899280095122, 244.28900108972238, 9.99985328071115, 0.05574572930987309, 55.2113222597155, -1.9999934481655455, -0.16588415261849976, 1.3518973026372976, -1.681859821533847, 1.418683896878165, 0.5533962728465286, 0.06744270896451146, 3.7242663590096523, -1.2946316193457752, 1.0714560991986213, 3.027495524307809, -0.07472328983133317, 0.9555378331632957, -0.3653217756888738, -0.1428741221990274, -0.06995171218400704, 2.1270602543705697, -0.9765558807737923, -0.05544098513783982, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.008504591340807, 0.01608223007207482, 360.55203093205034, 9.999396124992284, 0.07408687185771112, 55.278549773179, -1.9999880367300542, -0.19831397139122675 ,1.731835570968407, -1.681859821533847, 1.4512075119943928, 0.6298897489162698, 0.1715121918150413, 3.6949934638991815, -1.2787266139872775, 1.1050818585131204, 3.0678599353279385, -0.141000223367532, 0.8878220330543275, -0.34365173970314067, -0.17666624793314062, -0.0778543688708959, 2.0961259559036165, -0.912009316148657, 0.058847183286068916, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.021105038594662, 0.004522557159414742, 399.1804795838472, 7.151266092418873, 0.06532628682748798, 55.28129937643125, -1.5796083498014732, -0.214022484422576, 1.5532729238980494, -1.681859821533847, 1.4669017969146076, 0.6167895273613202, 0.2240612421558033, 3.636185977901238, -1.252269816889516, 1.2319551727230675, 3.1212613617244513, -0.15132200936139598, 0.8692478333014879, -0.34168336262027477, -0.21066308766825492, 0.08067864362906049, 1.9588266937720888, -0.7975072607096434, 0.32389616177447655, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.0366998266719039, 0.004507639176858286, 399.4198145877904, 7.215159083565414, 0.08266331155696338, 55.280677934039204, -1.5564540460823222, -0.21652809896889513, 1.250962900742465, -1.681859821533847, 1.470425366924636, 0.6161148577211758, 0.2421533852584033, 3.561778492416353, -1.059725547707348, 1.4931481207457546, 3.1170667497250073, -0.05919930769817048, 1.1566057476874898, -0.3515353556779109, -0.2075394603290166, 0.009817803444294074, 1.8852361491878789, -0.6617678455884933, 0.3016531226564242, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.0366998266719039, 0.004507639176858286, 399.4198145877904, 7.215159083565414, 0.08266331155696338, 55.280677934039204, 0, 0, 0, -1.681859821533847, 1.470425366924636, 0.6161148577211758, 0.2421533852584033, 3.561778492416353, -1.059725547707348, 1.4931481207457546, 3.1170667497250073, -0.05919930769817048, 1.1566057476874898, -0.3515353556779109, -0.2075394603290166, 0.009817803444294074, 1.8852361491878789, -0.6617678455884933, 0.3016531226564242, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.038693017194872, 0.014983232888026998, 359.2518435660411, 6.6262238673287, 0.08480281237510423, 55.47387105727235, 0.0, 0.0, 0.0, -1.681859821533847, 1.730748597544949, 0.612373940323533, 0.24547646456941183, 3.564350412174735, -1.0642369170107189, 1.4935151575387235, 3.1141507499206753, -0.05129722758108418, 1.1577838137704235, -0.34873907926191927, -0.21087528505338857, 0.011817195823953307, 1.8888212027868385, -0.6645364716921955, 0.2974984385969018, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.0394618294886782, 0.01004317609147179, 364.0477305040566, 6.59911786795859, 0.09779530546529702, 55.47729830849739, 0.0, 0.0, 0.0, -1.681859821533847, 1.7273809469430867, 0.6268937806919278, 0.24119541144075615, 3.5687624173038226, -1.0642904069090242, 1.4986372379043165, 3.1034564816834247, -0.039422282485462944, 1.1652241960873397, -0.35544149646334117, -0.20554803472490044, 0.009000631817785203, 1.8938325433914882, -0.6647492390942517, 0.2886232193756685, 499.99999999999835])</span>
    <span class="c1"># guess = np.array([1.0036791021833857, 0.018833770558709745, 338.0547800297367, 5.124495024795957, 0.06127554029880766, 55.47083973084643, 0.28104903491901023, -0.006396963559360369, 0.0, -1.54, 0.12601115569947202, -0.44177500169633965, 0.22784612458938883, 2.068571403099914, -1.336193340868478, 0.907309563186542, 1.704138680609022, -0.6802496108217749, 0.3669189518488262, -0.002886197372409439, -0.003236137155513198, -0.003474702040937771, 541.412075889249, 612.2819103192218, 39.695980305924444, 499.99999999999835])</span>
    <span class="c1"># truth sim_134</span>
    <span class="c1"># guess = np.array([1., 0.01, 300, 5, 0.03, 55.45, 0.0, 0.0, 0.0, -1.54, 0.11298966008548948, -0.396825836448203, 0.2060387678061209, 2.0649268678546955, -1.3753936625491252, 0.9242067418613167, 1.6950153822467129, -0.6942452135351901, 0.3644178350759512, -0.0028059253333737044, -0.003111527339787137, -0.00347648933169673, 528.3594585697788, 628.4966480821147, 12.438043546369354, 499.99999999999835])</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">p</span>
    <span class="n">fix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">guess</span><span class="o">.</span><span class="n">size</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># A1</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># A2</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span> <span class="c1"># LIBRADTRAN</span>
    <span class="c1"># fix[3] = False</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#DCCD</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span> <span class="c1">#DCCD</span>
    <span class="c1"># fix[10:13] = [False, False, False] # centers</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">guess</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># shift_t</span>
    <span class="n">fix</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># angle</span>
    <span class="n">fix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">fix_psf_cube</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">error</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1e-6</span><span class="p">))</span>
    <span class="n">error</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">guess</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">guess</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">error</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># noinspection PyArgumentList</span>
    <span class="c1"># m = Minuit.from_array_func(fcn=nll, start=guess, error=error, errordef=1,</span>
    <span class="c1">#                            fix=fix, print_level=2, limit=bounds)</span>
    <span class="c1"># m.tol = 10</span>
    <span class="c1"># m.migrad()</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">weighted_residuals</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="c1"># m.np_values()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fit_workspace</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_workspace</span><span class="p">,</span> <span class="n">SpectrumFitWorkspace</span><span class="p">):</span>
        <span class="n">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">fit_workspace</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_workspace</span><span class="p">,</span> <span class="n">SpectrogramFitWorkspace</span><span class="p">):</span>
        <span class="n">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">fit_workspace</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">live_fit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span></div>


<div class="viewcode-block" id="run_emcee"><a class="viewcode-back" href="../../../source/spectractor.fit.html#spectractor.fit.fitter.run_emcee">[docs]</a><span class="k">def</span> <span class="nf">run_emcee</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">fit_workspace</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">fit_workspace</span> <span class="o">=</span> <span class="n">w</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">print_settings</span><span class="p">()</span>
    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">nsteps</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">set_start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">MPIPool</span><span class="p">(</span><span class="n">loadbalance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">is_master</span><span class="p">():</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">fit_workspace</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span>
                                        <span class="n">runtime_sortingfn</span><span class="o">=</span><span class="n">sort_on_runtime</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span> <span class="n">storechain</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">pool</span><span class="o">.</span><span class="n">is_master</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:5.1%}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">nsamples</span><span class="p">))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">fit_workspace</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">fit_workspace</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">threads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                        <span class="n">runtime_sortingfn</span><span class="o">=</span><span class="n">sort_on_runtime</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">),</span> <span class="n">storechain</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:5.1%}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">nsamples</span><span class="p">))</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span>
    <span class="n">fit_workspace</span><span class="o">.</span><span class="n">lnprobs</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">lnprobability</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="k">import</span> <span class="n">OptionParser</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--debug&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter debug mode (more verbose and plots).&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter verbose (print more stuff).&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output_directory&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output_directory&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./outputs/&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Write results in given output directory (default: ./outputs/).&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;outputs/reduc_20170530_130_spectrum.fits&#39;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;outputs/sim_20170530_134_spectrum.fits&#39;</span>
    <span class="n">atmgrid_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sim&#39;</span><span class="p">,</span> <span class="s1">&#39;reduc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;atmsim&#39;</span><span class="p">)</span>

    <span class="n">fit_workspace</span> <span class="o">=</span> <span class="n">SpectrogramFitWorkspace</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atmgrid_filename</span><span class="o">=</span><span class="n">atmgrid_filename</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
                                            <span class="n">burnin</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                                            <span class="n">nbins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">run_minimisation</span><span class="p">()</span>
    <span class="c1"># run_emcee()</span>
    <span class="c1"># fit_workspace.analyze_chains()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jeremy Neveu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>