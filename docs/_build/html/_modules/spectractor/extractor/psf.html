

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectractor.extractor.psf &mdash; Spectractor 1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'1.1',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Spectractor
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spectractor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>spectractor.extractor.psf</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectractor.extractor.psf</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">basinhopping</span><span class="p">,</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">interp2d</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">quad</span>
<span class="kn">from</span> <span class="nn">iminuit</span> <span class="k">import</span> <span class="n">Minuit</span>

<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="k">import</span> <span class="n">fitting</span><span class="p">,</span> <span class="n">Fittable1DModel</span><span class="p">,</span> <span class="n">Fittable2DModel</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.models</span> <span class="k">import</span> <span class="n">Moffat1D</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">Table</span>

<span class="kn">from</span> <span class="nn">spectractor.tools</span> <span class="k">import</span> <span class="n">LevMarLSQFitterWithNan</span><span class="p">,</span> <span class="n">dichotomie</span><span class="p">,</span> <span class="n">fit_poly1d_outlier_removal</span><span class="p">,</span> \
    <span class="n">fit_poly1d</span><span class="p">,</span> <span class="n">fit_moffat1d_outlier_removal</span>
<span class="kn">from</span> <span class="nn">spectractor</span> <span class="k">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">spectractor.config</span> <span class="k">import</span> <span class="n">set_logger</span>


<div class="viewcode-block" id="PSF1D"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D">[docs]</a><span class="k">class</span> <span class="nc">PSF1D</span><span class="p">(</span><span class="n">Fittable1DModel</span><span class="p">):</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,)</span>

    <span class="n">amplitude_moffat</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;amplitude_moffat&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">x_mean</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;x_mean&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">eta_gauss</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;eta_gauss&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">stddev</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;stddev&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">saturation</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;saturation&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="PSF1D.fwhm"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D.fwhm">[docs]</a>    <span class="k">def</span> <span class="nf">fwhm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the full width half maximum of the PSF1D model with a dichotomie method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_array: array_like, optional</span>
<span class="sd">            An abscisse array is one wants to find FWHM on the interpolated PSF1D model</span>
<span class="sd">            (to smooth the spikes from spurious parameter sets).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FWHM: float</span>
<span class="sd">            The full width half maximum of the PSF1D model.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; x = np.arange(0, 60, 1)</span>
<span class="sd">        &gt;&gt;&gt; p = [2,30,4,2,-0.4,1,10]</span>
<span class="sd">        &gt;&gt;&gt; PSF = PSF1D(*p)</span>
<span class="sd">        &gt;&gt;&gt; a, b =  p[1], p[1]+3*max(p[-2], p[2])</span>
<span class="sd">        &gt;&gt;&gt; fwhm = PSF.fwhm(x_array=None)</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(fwhm, 7.25390625)</span>
<span class="sd">        &gt;&gt;&gt; fwhm = PSF.fwhm(x_array=x)</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(fwhm, 7.083984375)</span>
<span class="sd">        &gt;&gt;&gt; print(fwhm)</span>
<span class="sd">        7.083984375</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; x = np.arange(0, 60, 0.01)</span>
<span class="sd">        &gt;&gt;&gt; plt.plot(x, PSF.evaluate(x, *p)) #doctest: +ELLIPSIS</span>
<span class="sd">        [&lt;matplotlib.lines.Line2D object at 0x...&gt;]</span>
<span class="sd">        &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">x_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">(</span><span class="n">x_array</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">imax</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">imax</span><span class="p">:]</span> <span class="o">-</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">maximum</span><span class="p">))</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">imax</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">imax</span><span class="p">:]</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">maximum</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maximum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_moffat</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_gauss</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mean</span><span class="o">.</span><span class="n">value</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mean</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maximum</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dichotomie</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
        <span class="c1"># res = newton()</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mean</span><span class="o">.</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="PSF1D.evaluate"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D.evaluate">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude_moffat</span><span class="p">,</span> <span class="n">x_mean</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">eta_gauss</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">saturation</span><span class="p">):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span>
        <span class="n">rr_gg</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="c1"># use **(-alpha) instead of **(alpha) to avoid overflow power errors due to high alpha exponents</span>
        <span class="c1"># import warnings</span>
        <span class="c1"># warnings.filterwarnings(&#39;error&#39;)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">))))</span>
        <span class="k">except</span> <span class="ne">RuntimeWarning</span><span class="p">:</span>
            <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{[amplitude_moffat, x_mean, gamma, alpha, eta_gauss, stddev, saturation]}&quot;</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">saturation</span><span class="p">)</span></div>

<div class="viewcode-block" id="PSF1D.fit_deriv"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D.fit_deriv">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fit_deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude_moffat</span><span class="p">,</span> <span class="n">x_mean</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">eta_gauss</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">saturation</span><span class="p">):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span>
        <span class="n">rr_gg</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">gauss_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)))</span>
        <span class="n">d_eta_gauss</span> <span class="o">=</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="n">gauss_norm</span>
        <span class="n">moffat_norm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">d_amplitude_moffat</span> <span class="o">=</span> <span class="n">moffat_norm</span> <span class="o">+</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="n">gauss_norm</span>
        <span class="n">d_x_mean</span> <span class="o">=</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta_gauss</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)</span> <span class="o">*</span> <span class="n">gauss_norm</span>
                                       <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">moffat_norm</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                                               <span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)))</span>
        <span class="n">d_stddev</span> <span class="o">=</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="n">stddev</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">gauss_norm</span>
        <span class="n">d_alpha</span> <span class="o">=</span> <span class="o">-</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="n">moffat_norm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)</span>
        <span class="n">d_gamma</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">moffat_norm</span> <span class="o">*</span> <span class="p">(</span><span class="n">rr_gg</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)))</span>
        <span class="n">d_saturation</span> <span class="o">=</span> <span class="n">saturation</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d_amplitude_moffat</span><span class="p">,</span> <span class="n">d_x_mean</span><span class="p">,</span> <span class="n">d_gamma</span><span class="p">,</span> <span class="n">d_alpha</span><span class="p">,</span> <span class="n">d_eta_gauss</span><span class="p">,</span> <span class="n">d_stddev</span><span class="p">,</span> <span class="n">d_saturation</span><span class="p">])</span></div>

<div class="viewcode-block" id="PSF1D.deriv"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D.deriv">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude_moffat</span><span class="p">,</span> <span class="n">x_mean</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">eta_gauss</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">saturation</span><span class="p">):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span>
        <span class="n">rr_gg</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">d_eta_gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)))</span>
        <span class="n">d_gauss</span> <span class="o">=</span> <span class="o">-</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_eta_gauss</span>
        <span class="n">d_moffat</span> <span class="o">=</span> <span class="o">-</span>  <span class="n">alpha</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">amplitude_moffat</span> <span class="o">*</span> <span class="p">(</span><span class="n">d_gauss</span> <span class="o">+</span> <span class="n">d_moffat</span><span class="p">)</span></div>

<div class="viewcode-block" id="PSF1D.interpolation"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D.interpolation">[docs]</a>    <span class="k">def</span> <span class="nf">interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_array: array_like</span>
<span class="sd">            The abscisse array to interpolate the model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        interp: callable</span>
<span class="sd">            Function corresponding to the interpolated model on the x_array array.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; x = np.arange(0, 60, 1)</span>
<span class="sd">        &gt;&gt;&gt; p = [2,0,2,2,1,2,10]</span>
<span class="sd">        &gt;&gt;&gt; PSF = PSF1D(*p)</span>
<span class="sd">        &gt;&gt;&gt; interp = PSF.interpolation(x)</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(interp(p[1]), PSF.evaluate(p[1], *p))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="PSF1D.integrate"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D.integrate">[docs]</a>    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">x_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral of the PSF1D model. Bounds are -np.inf, np.inf by default, or provided</span>
<span class="sd">        if no x_array is provided. Otherwise the bounds comes from x_array edges.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_array: array_like, optional</span>
<span class="sd">            If not None, the interpoalted PSF1D modelis used for integration (default: None).</span>
<span class="sd">        bounds: array_like, optional</span>
<span class="sd">            The bounds of the integral (default bounds=(-np.inf, np.inf)).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result: float</span>
<span class="sd">            The integral of the PSF1D model.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; x = np.arange(0, 60, 1)</span>
<span class="sd">        &gt;&gt;&gt; p = [2,30,4,2,-0.5,1,10]</span>
<span class="sd">        &gt;&gt;&gt; PSF = PSF1D(*p)</span>
<span class="sd">        &gt;&gt;&gt; i = PSF.integrate()</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(i, 10.059742339728174)</span>
<span class="sd">        &gt;&gt;&gt; i = PSF.integrate(bounds=(0,60), x_array=x)</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(i, 10.046698028728645)</span>

<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; xx = np.arange(0, 60, 0.01)</span>
<span class="sd">        &gt;&gt;&gt; plt.plot(xx, PSF.evaluate(xx, *p)) #doctest: +ELLIPSIS</span>
<span class="sd">        [&lt;matplotlib.lines.Line2D object at 0x...&gt;]</span>
<span class="sd">        &gt;&gt;&gt; plt.plot(x, PSF.evaluate(x, *p)) #doctest: +ELLIPSIS</span>
<span class="sd">        [&lt;matplotlib.lines.Line2D object at 0x...&gt;]</span>
<span class="sd">        &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="n">x_array</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PSF2D"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF2D">[docs]</a><span class="k">class</span> <span class="nc">PSF2D</span><span class="p">(</span><span class="n">Fittable2DModel</span><span class="p">):</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,)</span>

    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x_mean</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;x_mean&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y_mean</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;y_mean&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">eta_gauss</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;eta_gauss&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">stddev</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;stddev&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">saturation</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;saturation&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="PSF2D.evaluate"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF2D.evaluate">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">eta_gauss</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">saturation</span><span class="p">):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">rr_gg</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">saturation</span><span class="p">)</span></div>

<div class="viewcode-block" id="PSF2D.fit_deriv"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF2D.fit_deriv">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fit_deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">eta_gauss</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">saturation</span><span class="p">):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">rr_gg</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">gauss_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)))</span>
        <span class="n">d_eta_gauss</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">gauss_norm</span>
        <span class="n">moffat_norm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">d_amplitude</span> <span class="o">=</span> <span class="n">moffat_norm</span> <span class="o">+</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="n">gauss_norm</span>
        <span class="n">d_x_mean</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)</span> <span class="o">*</span> <span class="n">gauss_norm</span> \
                   <span class="o">-</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">moffat_norm</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">))</span>
        <span class="n">d_y_mean</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">stddev</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)</span> <span class="o">*</span> <span class="n">gauss_norm</span> \
                   <span class="o">-</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">moffat_norm</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">))</span>
        <span class="n">d_stddev</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">eta_gauss</span> <span class="o">*</span> <span class="n">rr</span> <span class="o">/</span> <span class="p">(</span><span class="n">stddev</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">gauss_norm</span>
        <span class="n">d_alpha</span> <span class="o">=</span> <span class="o">-</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">moffat_norm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)</span>
        <span class="n">d_gamma</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">moffat_norm</span> <span class="o">*</span> <span class="p">(</span><span class="n">rr_gg</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rr_gg</span><span class="p">)))</span>
        <span class="n">d_saturation</span> <span class="o">=</span> <span class="n">saturation</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d_amplitude</span><span class="p">,</span> <span class="n">d_x_mean</span><span class="p">,</span> <span class="n">d_y_mean</span><span class="p">,</span> <span class="n">d_gamma</span><span class="p">,</span> <span class="n">d_alpha</span><span class="p">,</span> <span class="n">d_eta_gauss</span><span class="p">,</span> <span class="n">d_stddev</span><span class="p">,</span> <span class="n">d_saturation</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="ChromaticPSF1D"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D">[docs]</a><span class="k">class</span> <span class="nc">ChromaticPSF1D</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># file_name=&quot;&quot;, image=None, order=1, target=None):</span>
        <span class="c1"># Spectrum.__init__(self, file_name=file_name, image=image, order=order, target=target)</span>
        <span class="c1"># self.profile_params = profile_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deg</span> <span class="o">=</span> <span class="n">deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">deg</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="s1">&#39;saturation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">=</span> <span class="n">Nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">=</span> <span class="n">Ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># self.flux_sum = np.zeros(Nx)</span>
        <span class="c1"># self.flux_integral = np.zeros(Nx)</span>
        <span class="c1"># self.flux_err = np.zeros(Nx)</span>
        <span class="c1"># self.fwhms = np.zeros(Nx)</span>
        <span class="c1"># self.pixels_fwhm_sup = np.zeros(Nx)</span>
        <span class="c1"># self.pixels_fwhm_inf = np.zeros(Nx)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_poly_params</span> <span class="o">=</span> <span class="n">Nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">11</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lambdas&#39;</span><span class="p">,</span> <span class="s1">&#39;Dx&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_integral&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;flux_err&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy_fwhm_sup&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy_fwhm_inf&#39;</span><span class="p">,</span> <span class="s1">&#39;Dx_rot&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">saturation</span>
        <span class="k">if</span> <span class="n">saturation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span> <span class="o">=</span> <span class="mf">1e20</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Saturation level should be given to instanciate the ChromaticPSF1D &quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;object. self.saturation is set arbitrarily to 1e20. Good luck.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_poly_params</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_poly_params</span><span class="p">)</span>

<div class="viewcode-block" id="ChromaticPSF1D.fill_table_with_profile_params"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.fill_table_with_profile_params">[docs]</a>    <span class="k">def</span> <span class="nf">fill_table_with_profile_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill the table with the profile parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profile_params: array</span>
<span class="sd">           a Nx * len(self.PSF1D.param_names) numpy array containing the PSF1D parameters as a function of pixels.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = ChromaticPSF1D(Nx=100, Ny=100, deg=4, saturation=8000)</span>
<span class="sd">        &gt;&gt;&gt; poly_params_test = s.generate_test_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.from_poly_params_to_profile_params(poly_params_test)</span>
<span class="sd">        &gt;&gt;&gt; s.fill_table_with_profile_params(profile_params)</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(s.table[&#39;stddev&#39;], 2*np.ones(100))))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.rotate_table"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.rotate_table">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle_degree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In self.table, rotate the columns Dx, Dy, Dy_fwhm_inf and Dy_fwhm_sup by an angle</span>
<span class="sd">        given in degree. The results overwrite the previous columns in self.table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angle_degree: float</span>
<span class="sd">            Rotation angle in degree</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = ChromaticPSF1D(Nx=100, Ny=100, deg=4, saturation=8000)</span>
<span class="sd">        &gt;&gt;&gt; s.table[&#39;Dx_rot&#39;] = np.arange(100)</span>
<span class="sd">        &gt;&gt;&gt; s.rotate_table(45)</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(s.table[&#39;Dy&#39;], -np.arange(100)/np.sqrt(2))))</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(s.table[&#39;Dx&#39;], np.arange(100)/np.sqrt(2))))</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(s.table[&#39;Dy_fwhm_inf&#39;], -np.arange(100)/np.sqrt(2))))</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(s.table[&#39;Dy_fwhm_sup&#39;], -np.arange(100)/np.sqrt(2))))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">angle_degree</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]])</span>
        <span class="c1"># finish with Dy_mean to get correct Dx</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy_fwhm_inf&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy_fwhm_sup&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy_mean&#39;</span><span class="p">]:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx_rot&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">rot_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot_vec</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot_vec</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.from_profile_params_to_poly_params"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.from_profile_params_to_poly_params">[docs]</a>    <span class="k">def</span> <span class="nf">from_profile_params_to_poly_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the profile_params array from fit_transverse_PSF1D into a set of parameters</span>
<span class="sd">        for the chromatic PSF parameterisation.</span>
<span class="sd">        Fit polynomial functions across the pixels for each PSF1D</span>
<span class="sd">        parameters. The order of the function is given by self.degrees.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profile_params: array</span>
<span class="sd">            a Nx * len(self.PSF1D.param_names) numpy array containing the PSF1D parameters as a function of pixels.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        profile_params: array_like</span>
<span class="sd">            A set of parameters that can be evaluated by the chromatic PSF class evaluate function.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        # Build a mock spectrogram with random Poisson noise:</span>
<span class="sd">        &gt;&gt;&gt; s = ChromaticPSF1D(Nx=100, Ny=100, deg=4, saturation=8000)</span>
<span class="sd">        &gt;&gt;&gt; poly_params_test = s.generate_test_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; data = s.evaluate(poly_params_test)</span>
<span class="sd">        &gt;&gt;&gt; data = np.random.poisson(data)</span>
<span class="sd">        &gt;&gt;&gt; data_errors = np.sqrt(data+1)</span>

<span class="sd">        # From the polynomial parameters to the profile parameters:</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.from_poly_params_to_profile_params(poly_params_test)</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(profile_params[0], [0, 50, 5, 2, 0, 2, 8e3])))</span>

<span class="sd">        # From the profile parameters to the polynomial parameters:</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.from_profile_params_to_poly_params(profile_params)</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(profile_params, poly_params_test)))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span>
        <span class="n">poly_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="s1">&#39;amplitude_moffat&#39;</span><span class="p">:</span>
                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
                <span class="n">poly_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">poly_params</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># fit, cov, model = fit_poly1d(pixels, profile_params[:, k], order=self.degrees[name])</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legfit</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="n">poly_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">poly_params</span><span class="p">,</span> <span class="n">fit</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">poly_params</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.from_table_to_profile_params"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.from_table_to_profile_params">[docs]</a>    <span class="k">def</span> <span class="nf">from_table_to_profile_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the profile parameters from self.table and fill an array of profile parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        profile_params: array</span>
<span class="sd">            Nx * len(self.PSF1D.param_names) numpy array containing the PSF1D parameters as a function of pixels.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from spectractor.extractor.spectrum import Spectrum</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(&#39;./tests/data/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.chromatic_psf.from_table_to_profile_params()</span>
<span class="sd">        &gt;&gt;&gt; assert(profile_params.shape == (s.chromatic_psf.Nx, len(s.chromatic_psf.PSF1D.param_names)))</span>
<span class="sd">        &gt;&gt;&gt; assert not np.all(np.isclose(profile_params, np.zeros_like(profile_params)))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">profile_params</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.from_table_to_poly_params"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.from_table_to_poly_params">[docs]</a>    <span class="k">def</span> <span class="nf">from_table_to_poly_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the polynomial parameters from self.table and fill an array with polynomial parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        poly_params: array_like</span>
<span class="sd">            A set of polynomial parameters that can be evaluated by the chromatic PSF class evaluate function.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from spectractor.extractor.spectrum import Spectrum</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(&#39;./tests/data/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; poly_params = s.chromatic_psf.from_table_to_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; assert(poly_params.size &gt; s.chromatic_psf.Nx)</span>
<span class="sd">        &gt;&gt;&gt; assert(len(poly_params.shape)==1)</span>
<span class="sd">        &gt;&gt;&gt; assert not np.all(np.isclose(poly_params, np.zeros_like(poly_params)))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_table_to_profile_params</span><span class="p">()</span>
        <span class="n">poly_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_profile_params_to_poly_params</span><span class="p">(</span><span class="n">profile_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">poly_params</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.from_poly_params_to_profile_params"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.from_poly_params_to_profile_params">[docs]</a>    <span class="k">def</span> <span class="nf">from_poly_params_to_profile_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly_params</span><span class="p">,</span> <span class="n">force_positive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the PSF1D profile parameters from the polynomial coefficients. If poly_params length is smaller</span>
<span class="sd">        than self.Nx, it is assumed that the amplitude_moffat parameters are not included and set to arbitrarily to 1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        poly_params: array_like</span>
<span class="sd">            Parameter array of the model, in the form:</span>
<span class="sd">                * Nx first parameters are amplitudes for the Moffat transverse profiles</span>
<span class="sd">                * next parameters are polynomial coefficients for all the PSF1D parameters</span>
<span class="sd">        in the same order as in PSF1D definition, except amplitude_moffat</span>
<span class="sd">        force_positive: bool, optional</span>
<span class="sd">            Force some profile parameters to be positive despite the polynomial coefficients (default: False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        profile_params: array</span>
<span class="sd">            Nx * len(self.PSF1D.param_names) numpy array containing the PSF1D parameters as a function of pixels.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        # Build a mock spectrogram with random Poisson noise:</span>
<span class="sd">        &gt;&gt;&gt; s = ChromaticPSF1D(Nx=100, Ny=100, deg=1, saturation=8000)</span>
<span class="sd">        &gt;&gt;&gt; poly_params_test = s.generate_test_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; data = s.evaluate(poly_params_test)</span>
<span class="sd">        &gt;&gt;&gt; data = np.random.poisson(data)</span>
<span class="sd">        &gt;&gt;&gt; data_errors = np.sqrt(data+1)</span>

<span class="sd">        # From the polynomial parameters to the profile parameters:</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.from_poly_params_to_profile_params(poly_params_test)</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(profile_params[0], [0, 50, 5, 2, 0, 2, 8e3])))</span>

<span class="sd">        # From the profile parameters to the polynomial parameters:</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.from_profile_params_to_poly_params(profile_params)</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(profile_params, poly_params_test)))</span>

<span class="sd">        # From the polynomial parameters to the profile parameters without Moffat amplitudes:</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.from_poly_params_to_profile_params(poly_params_test[100:])</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(profile_params[0], [1, 50, 5, 2, 0, 2, 8e3])))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">)))</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;amplitude_moffat&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">:</span>
                    <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">poly_params</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">:</span>
                    <span class="c1"># profile_params[:, k] = np.polyval(poly_params[Nx + shift:Nx + shift + self.degrees[name] + 1],</span>
                    <span class="c1">#                                  pixels)</span>
                    <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span>
                                                      <span class="n">poly_params</span><span class="p">[</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">+</span> <span class="n">shift</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">+</span> <span class="n">shift</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">poly_params</span><span class="p">[</span><span class="n">shift</span><span class="p">:</span><span class="n">shift</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">force_positive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;x_mean&quot;</span><span class="p">:</span>
                    <span class="n">profile_params</span><span class="p">[</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-1</span>
                    <span class="n">profile_params</span><span class="p">[</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span>
                    <span class="n">profile_params</span><span class="p">[</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-1</span>
                    <span class="c1"># profile_params[profile_params[:, k] &gt;= 6, k] = 6</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
                    <span class="n">profile_params</span><span class="p">[</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-1</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;stddev&quot;</span><span class="p">:</span>
                    <span class="n">profile_params</span><span class="p">[</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-1</span>
        <span class="k">return</span> <span class="n">profile_params</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.from_profile_params_to_shape_params"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.from_profile_params_to_shape_params">[docs]</a>    <span class="k">def</span> <span class="nf">from_profile_params_to_shape_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the PSF1D integrals and FWHMS given the profile_params array and fill the table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profile_params: array</span>
<span class="sd">         a Nx * len(self.PSF1D.param_names) numpy array containing the PSF1D parameters as a function of pixels.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = ChromaticPSF1D(Nx=100, Ny=100, deg=4, saturation=8000)</span>
<span class="sd">        &gt;&gt;&gt; poly_params_test = s.generate_test_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; profile_params = s.from_poly_params_to_profile_params(poly_params_test)</span>
<span class="sd">        &gt;&gt;&gt; s.from_profile_params_to_shape_params(profile_params)</span>
<span class="sd">        &gt;&gt;&gt; assert(np.isclose(s.table[&#39;fwhm&#39;][-1], 12.7851))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_table_with_profile_params</span><span class="p">(</span><span class="n">profile_params</span><span class="p">)</span>
        <span class="n">pixel_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">pixel_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pixel_x</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">profile_params</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">fwhm</span><span class="p">(</span><span class="n">x_array</span><span class="o">=</span><span class="n">pixel_y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_integral&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">fwhm</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">fwhm</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                           <span class="n">x_array</span><span class="o">=</span><span class="n">pixel_y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.set_bounds"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.set_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">set_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function returns an array of bounds for iminuit. It is very touchy, change the values with caution !</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: array_like, optional</span>
<span class="sd">            The data array, to set the bounds for the amplitude using its maximum.</span>
<span class="sd">            If None is provided, no bounds are provided for the amplitude parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bounds: array_like</span>
<span class="sd">            2D array containing the pair of bounds for each polynomial parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nx</span><span class="p">)],</span> <span class="p">[</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nx</span><span class="p">)]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">tmp_bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">])]</span>
            <span class="c1"># if name is &quot;x_mean&quot;:</span>
            <span class="c1">#      tmp_bounds[0].append(0)</span>
            <span class="c1">#      tmp_bounds[1].append(Ny)</span>
            <span class="c1"># elif name is &quot;gamma&quot;:</span>
            <span class="c1">#      tmp_bounds[0].append(0)</span>
            <span class="c1">#      tmp_bounds[1].append(None) # Ny/2</span>
            <span class="c1"># elif name is &quot;alpha&quot;:</span>
            <span class="c1">#      tmp_bounds[0].append(1)</span>
            <span class="c1">#      tmp_bounds[1].append(None) # 10</span>
            <span class="c1"># elif name is &quot;eta_gauss&quot;:</span>
            <span class="c1">#     tmp_bounds[0].append(-1)</span>
            <span class="c1">#     tmp_bounds[1].append(0)</span>
            <span class="c1"># elif name is &quot;stddev&quot;:</span>
            <span class="c1">#     tmp_bounds[0].append(0.1)</span>
            <span class="c1">#     tmp_bounds[1].append(Ny / 2)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="s2">&quot;saturation&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tmp_bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)],</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">is</span> <span class="s2">&quot;amplitude_moffat&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># else:</span>
            <span class="c1">#     self.my_logger.error(f&#39;Unknown parameter name {name} in set_bounds.&#39;)</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.check_bounds"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.check_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">check_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly_params</span><span class="p">,</span> <span class="n">noise_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the PSF1D profile parameters from the polynomial coefficients and check if they are within priors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        poly_params: array_like</span>
<span class="sd">            Parameter array of the model, in the form:</span>
<span class="sd">                * Nx first parameters are amplitudes for the Moffat transverse profiles</span>
<span class="sd">                * next parameters are polynomial coefficients for all the PSF1D parameters</span>
<span class="sd">        in the same order as in PSF1D definition, except amplitude_moffat</span>

<span class="sd">        noise_level: float, optional</span>
<span class="sd">            Noise level to set minimal boundary for amplitudes (negatively).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        in_bounds: bool</span>
<span class="sd">            Return True if all parameters respect the model parameter priors.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">outbound_parameter_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_poly_params_to_profile_params</span><span class="p">(</span><span class="n">poly_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">profile_params</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;amplitude_moffat&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">noise_level</span><span class="p">):</span>
                    <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_params</span><span class="p">[</span><span class="n">p</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">noise_level</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">outbound_parameter_name</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">is</span> <span class="s2">&quot;x_mean&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_params</span><span class="p">[</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">outbound_parameter_name</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">):</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_params</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">)</span>
                    <span class="n">penalty</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">outbound_parameter_name</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="c1"># elif name is &quot;gamma&quot;:</span>
            <span class="c1">#     if np.any(p &lt; 0) or np.any(p &gt; self.Ny):</span>
            <span class="c1">#         in_bounds = False</span>
            <span class="c1">#         penalty = 1</span>
            <span class="c1">#         break</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">is</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_params</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="n">penalty</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">outbound_parameter_name</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="c1"># if np.any(p &lt; 0.1):</span>
                <span class="c1">#     penalty += np.sum(0.1 - profile_params[p &lt; 0.1, k])</span>
                <span class="c1">#     penalty /= np.abs(np.mean(p))</span>
                <span class="c1">#     in_bounds = False</span>
                <span class="c1">#     outbound_parameter_name += name + &#39; &#39;</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">is</span> <span class="s2">&quot;eta_gauss&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_params</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
                    <span class="c1"># penalty /= np.abs(np.mean(p))</span>
                    <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">outbound_parameter_name</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">profile_params</span><span class="p">[</span><span class="n">p</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
                    <span class="n">penalty</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">in_bounds</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">outbound_parameter_name</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="c1"># elif name is &quot;stddev&quot;:</span>
            <span class="c1">#     if np.any(p &lt; 0) or np.any(p &gt; self.Ny):</span>
            <span class="c1">#         in_bounds = False</span>
            <span class="c1">#         penalty = 1</span>
            <span class="c1">#         break</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">is</span> <span class="s2">&quot;saturation&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># else:</span>
            <span class="c1">#    self.my_logger.error(f&#39;Unknown parameter name {name} in set_bounds.&#39;)</span>
        <span class="n">penalty</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span>
        <span class="k">return</span> <span class="n">in_bounds</span><span class="p">,</span> <span class="n">penalty</span><span class="p">,</span> <span class="n">outbound_parameter_name</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.evaluate"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate a 2D spectrogram of size Nx times Ny.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        poly_params: array_like</span>
<span class="sd">            Parameter array of the model, in the form:</span>
<span class="sd">                * Nx first parameters are amplitudes for the Moffat transverse profiles</span>
<span class="sd">                * next parameters are polynomial coefficients for all the PSF1D parameters</span>
<span class="sd">        in the same order as in PSF1D definition, except amplitude_moffat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        output: array</span>
<span class="sd">            A 2D array with the model</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = ChromaticPSF1D(Nx=100, Ny=20, deg=4, saturation=8000)</span>
<span class="sd">        &gt;&gt;&gt; poly_params = s.generate_test_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; output = s.evaluate(poly_params)</span>

<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; im = plt.imshow(output, origin=&#39;lower&#39;)  #doctest: +ELLIPSIS</span>
<span class="sd">        &gt;&gt;&gt; plt.colorbar(im)  #doctest: +ELLIPSIS</span>
<span class="sd">        &lt;matplotlib.colorbar.Colorbar object at 0x...&gt;</span>
<span class="sd">        &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_poly_params_to_profile_params</span><span class="p">(</span><span class="n">poly_params</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">):</span>
            <span class="c1"># self.my_logger.warning(f&quot;{k} {profile_params[k]}&quot;)</span>
            <span class="n">output</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">profile_params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.get_distance_along_dispersion_axis"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.get_distance_along_dispersion_axis">[docs]</a>    <span class="k">def</span> <span class="nf">get_distance_along_dispersion_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.generate_test_poly_params"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.generate_test_poly_params">[docs]</a>    <span class="k">def</span> <span class="nf">generate_test_poly_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A set of parameters to define a test spectrogram</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        profile_params: array</span>
<span class="sd">            The list of the test parameters</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = ChromaticPSF1D(Nx=5, Ny=4, deg=1, saturation=8000)</span>
<span class="sd">        &gt;&gt;&gt; params = s.generate_test_poly_params()</span>
<span class="sd">        &gt;&gt;&gt; assert(np.all(np.isclose(params, [ 0, 50, 100, 150, 200, 2, 0, 5, 0, 2, 0, -0.4, -0.4, 2, 0, 8000])))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)]</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># y mean</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># gamma</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># alpha</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="s1">&#39;eta_gauss&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">]</span>  <span class="c1"># eta_gauss</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># stddev</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">8000.</span><span class="p">]</span>  <span class="c1"># saturation</span>
        <span class="n">poly_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">poly_params</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span> <span class="o">=</span> <span class="mf">8000.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;amplitude_moffat&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">poly2leg</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">shift</span><span class="p">:</span><span class="n">index</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
                <span class="n">coeffs</span><span class="p">[:</span><span class="n">c</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">poly_params</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="n">shift</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffs</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="k">return</span> <span class="n">poly_params</span></div>

<div class="viewcode-block" id="ChromaticPSF1D.plot_summary"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.ChromaticPSF1D.plot_summary">[docs]</a>    <span class="k">def</span> <span class="nf">plot_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">truth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">()</span>
        <span class="n">PSF_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">PSF_truth</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">PSF_truth</span> <span class="o">=</span> <span class="n">truth</span><span class="o">.</span><span class="n">from_poly_params_to_profile_params</span><span class="p">(</span><span class="n">truth</span><span class="o">.</span><span class="n">poly_params</span><span class="p">)</span>
        <span class="n">all_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">fit_poly1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degrees</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">PSF_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">all_pixels</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_pixels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_pixels</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                       <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_pixels</span><span class="p">,</span> <span class="n">PSF_models</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_pixels</span><span class="p">,</span> <span class="n">PSF_truth</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixels</span><span class="p">[::</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">//</span> <span class="mi">10</span><span class="p">]:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">PSF_models</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">))]</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">psf</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">+=</span> <span class="n">psf</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PSF1D parameters&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;symlog&#39;</span><span class="p">,</span> <span class="n">linthreshy</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;PSF(x)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="c1"># fig.subplots_adjust(hspace=0)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="extract_background"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.extract_background">[docs]</a><span class="k">def</span> <span class="nf">extract_background</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">pixel_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a polynomial background slice per slice along the x axis,</span>
<span class="sd">    with outlier removal, on lateral bands defined by the ws parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: array</span>
<span class="sd">        The 2D array image. The transverse profile is fitted on the y direction for all pixels along the x direction.</span>
<span class="sd">    err: array</span>
<span class="sd">        The uncertainties related to the data array.</span>
<span class="sd">    deg: int</span>
<span class="sd">        Degree of the polynomial model for the background (default: 1).</span>
<span class="sd">    ws: list</span>
<span class="sd">        up/down region extension where the sky background is estimated with format [int, int] (default: [20,30])</span>
<span class="sd">    pixel_step: int, optional</span>
<span class="sd">        The step in pixels between the slices to be fitted (default: 1).</span>
<span class="sd">        The values for the skipped pixels are interpolated with splines from the fitted parameters.</span>
<span class="sd">    live_fit: bool, optional</span>
<span class="sd">        If True, the transverse profile fit is plotted in live across the loop (default: False).</span>
<span class="sd">    sigma: int</span>
<span class="sd">        Sigma for outlier rejection (default: 5).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bgd_model_func: callable</span>
<span class="sd">        A 2D function to model the extracted background</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    # Build a mock spectrogram with random Poisson noise:</span>
<span class="sd">    &gt;&gt;&gt; s0 = ChromaticPSF1D(Nx=100, Ny=100, saturation=1000)</span>
<span class="sd">    &gt;&gt;&gt; params = s0.generate_test_poly_params()</span>
<span class="sd">    &gt;&gt;&gt; saturation = params[-1]</span>
<span class="sd">    &gt;&gt;&gt; data = s0.evaluate(params)</span>
<span class="sd">    &gt;&gt;&gt; bgd = 10*np.ones_like(data)</span>
<span class="sd">    &gt;&gt;&gt; data += bgd</span>
<span class="sd">    &gt;&gt;&gt; data = np.random.poisson(data)</span>
<span class="sd">    &gt;&gt;&gt; data_errors = np.sqrt(data+1)</span>

<span class="sd">    # Fit the transverse profile:</span>
<span class="sd">    &gt;&gt;&gt; bgd_model = extract_background(data, data_errors, deg=1, ws=[30,50], live_fit=True, sigma=5, pixel_step=50)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">middle</span> <span class="o">=</span> <span class="n">Ny</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ny</span><span class="p">)</span>
    <span class="c1"># Prepare the fit</span>
    <span class="n">bgd_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">middle</span> <span class="o">-</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">middle</span> <span class="o">+</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ny</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">pixel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">pixel_step</span><span class="p">)</span>
    <span class="n">bgd_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pixel_range</span><span class="p">:</span>
        <span class="c1"># fit the background with a polynomial function</span>
        <span class="n">bgd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">bgd_fit</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">fit_poly1d_outlier_removal</span><span class="p">(</span><span class="n">bgd_index</span><span class="p">,</span> <span class="n">bgd</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">bgd_model</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">live_fit</span><span class="p">:</span>
            <span class="n">plot_transverse_PSF1D_profile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bgd_index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">bgd_fit</span><span class="o">=</span><span class="n">bgd_fit</span><span class="p">,</span>
                                          <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="n">live_fit</span><span class="p">)</span>
    <span class="c1"># prepare the background model</span>
    <span class="c1"># interpolate the grid</span>
    <span class="n">bgd_fit</span> <span class="o">=</span> <span class="n">bgd_model</span><span class="p">[:,</span> <span class="n">pixel_range</span><span class="p">]</span>
    <span class="n">bgd_model_func</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">pixel_range</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bgd_fit</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="c1"># fig, ax = plt.subplots(1,3, figsize=(12,4))</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">bgd_model_func</span><span class="p">(</span><span class="n">pixel_range</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fitted background&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">bgd_model_func</span></div>


<div class="viewcode-block" id="fit_transverse_PSF1D_profile"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_transverse_PSF1D_profile">[docs]</a><span class="k">def</span> <span class="nf">fit_transverse_PSF1D_profile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">pixel_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the transverse profile of a 2D data image with a PSF1D profile.</span>
<span class="sd">    Loop is done on the x-axis direction.</span>
<span class="sd">    An order 1 polynomial function is fitted to subtract the background for each pixel</span>
<span class="sd">    with a 3*sigma outlier removal procedure to remove background stars.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: array</span>
<span class="sd">        The 2D array image. The transverse profile is fitted on the y direction</span>
<span class="sd">        for all pixels along the x direction.</span>
<span class="sd">    err: array </span>
<span class="sd">        The uncertainties related to the data array.</span>
<span class="sd">    w: int</span>
<span class="sd">        Half width of central region where the spectrum is extracted and summed (default: 10)</span>
<span class="sd">    ws: list</span>
<span class="sd">        up/down region extension where the sky background is estimated with format [int, int] (default: [20,30])</span>
<span class="sd">    pixel_step: int, optional</span>
<span class="sd">        The step in pixels between the slices to be fitted (default: 1).</span>
<span class="sd">        The values for the skipped pixels are interpolated with splines from the fitted parameters.</span>
<span class="sd">    saturation: float, optional</span>
<span class="sd">        The saturation level of the image. Default is set to twice the maximum of the data array and has no effect.</span>
<span class="sd">    live_fit: bool, optional</span>
<span class="sd">        If True, the transverse profile fit is plotted in live accross the loop (default: False).</span>
<span class="sd">    sigma: int</span>
<span class="sd">        Sigma for outlier rejection (default: 5).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s: ChromaticPSF1D</span>
<span class="sd">        The chromatic PSF containing all the information on the wavelength dependeces of the parameters adn the flux_sum.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    # Build a mock spectrogram with random Poisson noise:</span>
<span class="sd">    &gt;&gt;&gt; s0 = ChromaticPSF1D(Nx=100, Ny=100, saturation=1000)</span>
<span class="sd">    &gt;&gt;&gt; params = s0.generate_test_poly_params()</span>
<span class="sd">    &gt;&gt;&gt; saturation = params[-1]</span>
<span class="sd">    &gt;&gt;&gt; data = s0.evaluate(params)</span>
<span class="sd">    &gt;&gt;&gt; bgd = 10*np.ones_like(data)</span>
<span class="sd">    &gt;&gt;&gt; data += bgd</span>
<span class="sd">    &gt;&gt;&gt; data = np.random.poisson(data)</span>
<span class="sd">    &gt;&gt;&gt; data_errors = np.sqrt(data+1)</span>

<span class="sd">    # Fit the transverse profile:</span>
<span class="sd">    &gt;&gt;&gt; s, bgd_model = fit_transverse_PSF1D_profile(data, data_errors, w=20, ws=[30,50], pixel_step=10,</span>
<span class="sd">    ... saturation=saturation, live_fit=False, sigma=5)</span>
<span class="sd">    &gt;&gt;&gt; assert(np.all(np.isclose(s.pixels[:5], np.arange(s.Nx)[:5], rtol=1e-3)))</span>
<span class="sd">    &gt;&gt;&gt; assert(not np.any(np.isclose(s.table[&#39;flux_sum&#39;][3:6], np.zeros(s.Nx)[3:6], rtol=1e-3)))</span>
<span class="sd">    &gt;&gt;&gt; assert(np.all(np.isclose(s.table[&#39;Dy&#39;][-10:-1], np.zeros(s.Nx)[-10:-1], rtol=1e-2)))</span>
<span class="sd">    &gt;&gt;&gt; s.plot_summary(truth=s0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">saturation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">saturation</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">middle</span> <span class="o">=</span> <span class="n">Ny</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ny</span><span class="p">)</span>
    <span class="c1"># Prepare the outputs</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">ChromaticPSF1D</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="n">saturation</span><span class="p">)</span>
    <span class="c1"># Prepare the fit: start with the maximum of the spectrum</span>
    <span class="n">ymax_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bgd_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">middle</span> <span class="o">-</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">middle</span> <span class="o">+</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ny</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">ymax_index</span><span class="p">]</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">middle</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">saturation</span><span class="p">]</span>
    <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">maxi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">maxi</span><span class="p">),</span> <span class="p">(</span><span class="n">middle</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">middle</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">Ny</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">Ny</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
              <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">saturation</span><span class="p">)]</span>
    <span class="c1"># first fit with moffat only to initialize the guess</span>
    <span class="c1"># hypothesis that max of spectrum if well describe by a focused PSF</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">,</span> <span class="n">ymax_index</span><span class="p">]</span>
    <span class="n">bgd_fit</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">fit_poly1d_outlier_removal</span><span class="p">(</span><span class="n">bgd_index</span><span class="p">,</span> <span class="n">bgd</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">fit_moffat1d_outlier_removal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">moffat_guess</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fit</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
    <span class="n">guess</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">moffat_guess</span>
    <span class="n">init_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="c1"># Go from max to right, then from max to left</span>
    <span class="c1"># includes the boundaries to avoid Runge phenomenum in chromatic_fit</span>
    <span class="n">pixel_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymax_index</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">pixel_step</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pixel_range</span><span class="p">:</span>
        <span class="n">pixel_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pixel_range</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymax_index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">pixel_step</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pixel_range</span><span class="p">:</span>
        <span class="n">pixel_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pixel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pixel_range</span><span class="p">)</span>
    <span class="n">bgd_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pixel_range</span><span class="p">:</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">ymax_index</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">init_guess</span><span class="p">)</span>
        <span class="c1"># fit the background with a polynomial function</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">bgd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">bgd_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">bgd_fit</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">fit_poly1d_outlier_removal</span><span class="p">(</span><span class="n">bgd_index</span><span class="p">,</span> <span class="n">bgd</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">BGD_ORDER</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">bgd_model</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># in case guess amplitude is too low</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="n">signal_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">signal_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pdf</span> <span class="o">/=</span> <span class="n">signal_sum</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">pdf</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">pdf</span> <span class="o">*</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bgd</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="c1"># if guess[4] &gt; -1:</span>
        <span class="c1">#    guess[0] = np.max(signal) / (1 + guess[4])</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">guess</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bgd</span><span class="p">):</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">maxi</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">saturation</span><span class="p">]</span>
        <span class="c1"># if guess[0] * (1 + guess[4]) &gt; 1.2 * maxi:</span>
        <span class="c1">#     guess = [0.9 * maxi, mean, std, 2, 0, std, saturation]</span>
        <span class="n">PSF_guess</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">(</span><span class="o">*</span><span class="n">guess</span><span class="p">)</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># fit with outlier removal to clean background stars</span>
        <span class="c1"># first a simple moffat to get the general shape</span>
        <span class="c1"># moffat1d = fit_moffat1d_outlier_removal(index, signal, sigma=5, niter=2,</span>
        <span class="c1">#                                        guess=guess[:4], bounds=np.array(bounds[:4]).T)</span>
        <span class="c1"># guess[:4] = [getattr(moffat1d, p).value for p in moffat1d.param_names]</span>
        <span class="c1"># then PSF1D model using the result from the Moffat1D fit</span>
        <span class="c1"># fit, outliers = fit_PSF1D_outlier_removal(index, signal, sub_errors=err[:, x], method=&#39;basinhopping&#39;,</span>
        <span class="c1">#                                            guess=guess, bounds=bounds, sigma=5, niter=2,</span>
        <span class="c1">#                                            niter_basinhopping=5, T_basinhopping=1)</span>
        <span class="c1"># fit = fit_PSF1D_minuit(index[good_indices], signal[good_indices], guess=guess, bounds=bounds,</span>
        <span class="c1">#                       data_errors=err[good_indices, x])</span>
        <span class="n">fit</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">fit_PSF1D_minuit_outlier_removal</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                                         <span class="n">data_errors</span><span class="o">=</span><span class="n">err</span><span class="p">[:,</span> <span class="n">x</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">consecutive</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="c1"># good_indices = [i for i in index if i not in outliers]</span>
        <span class="c1"># outliers = [i for i in index if np.abs((signal[i] - fit(i)) / err[i, x]) &gt; sigma]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This part is relevant if outliers rejection above is activated</span>
<span class="sd">        # test if 3 consecutive pixels are in the outlier list</span>
<span class="sd">        test = 0</span>
<span class="sd">        consecutive_outliers = False</span>
<span class="sd">        for o in range(1, len(outliers)):</span>
<span class="sd">            t = outliers[o] - outliers[o - 1]</span>
<span class="sd">            if t == 1:</span>
<span class="sd">                test += t</span>
<span class="sd">            else:</span>
<span class="sd">                test = 0</span>
<span class="sd">            if test &gt; 1:</span>
<span class="sd">                consecutive_outliers = True</span>
<span class="sd">                break</span>
<span class="sd">        # test if the fit has badly fitted the two highest data points or the middle points</span>
<span class="sd">        test = np.copy(signal)</span>
<span class="sd">        max_badfit = False</span>
<span class="sd">        max_index = signal.argmax()</span>
<span class="sd">        if max_index in outliers:</span>
<span class="sd">            test[max_index] = 0</span>
<span class="sd">            if test.argmax() in outliers:</span>
<span class="sd">                max_badfit = True</span>
<span class="sd">        # if there are consecutive outliers or max is badly fitted, re-estimate the guess and refi</span>
<span class="sd">        if consecutive_outliers:  # or max_badfit:</span>
<span class="sd">            my_logger.warning(f&#39;\n\tRefit because of max_badfit={max_badfit} or &#39;</span>
<span class="sd">                              f&#39;consecutive_outliers={consecutive_outliers}&#39;)</span>
<span class="sd">            guess = [1.3 * maxi, middle, guess[2], guess[3], -0.3, std / 2, saturation]</span>
<span class="sd">            fit, outliers = fit_PSF1D_outlier_removal(index, signal, sub_errors=err[:, x], method=&#39;basinhopping&#39;,</span>
<span class="sd">                                                      guess=guess, bounds=bounds, sigma=5, niter=2,</span>
<span class="sd">                                                      niter_basinhopping=20, T_basinhopping=1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># compute the flux_sum</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fit</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">profile_params</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">err</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_sum&#39;</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">live_fit</span><span class="p">:</span>
            <span class="n">plot_transverse_PSF1D_profile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bgd_index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">bgd_fit</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span>
                                          <span class="n">PSF_guess</span><span class="p">,</span>  <span class="n">outliers</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">live_fit</span><span class="p">)</span>
    <span class="c1"># interpolate the skipped pixels with splines</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">)</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pixel_range</span><span class="p">))))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">fitted_pixels</span> <span class="o">=</span> <span class="n">xp</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">param_names</span><span class="p">)):</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">profile_params</span><span class="p">[</span><span class="n">xp</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">profile_params</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_sum&#39;</span><span class="p">][</span><span class="n">xp</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">][</span><span class="n">xp</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">poly_params</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">from_profile_params_to_poly_params</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">profile_params</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">from_profile_params_to_shape_params</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">profile_params</span><span class="p">)</span>
    <span class="c1"># prepare the background model</span>
    <span class="c1"># interpolate the grid</span>
    <span class="n">bgd_fit</span> <span class="o">=</span> <span class="n">bgd_model</span><span class="p">[:,</span> <span class="n">xp</span><span class="p">]</span>
    <span class="n">bgd_model_func</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bgd_fit</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="c1"># fig, ax = plt.subplots(1,3, figsize=(12,4))</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">bgd_model_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fitted background&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">bgd_model_func</span></div>


<div class="viewcode-block" id="plot_transverse_PSF1D_profile"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.plot_transverse_PSF1D_profile">[docs]</a><span class="k">def</span> <span class="nf">plot_transverse_PSF1D_profile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">bgd_indices</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bgd_fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PSF_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outliers</span><span class="o">=</span><span class="p">[],</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the transverse profile of  the spectrogram.</span>

<span class="sd">    This plot function is called in transverse_PSF1D_profile if live_fit option is True.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: int</span>
<span class="sd">        Pixel index along the dispersion axis.</span>
<span class="sd">    indices: array_like</span>
<span class="sd">        Pixel indices across the dispersion axis.</span>
<span class="sd">    bgd_indices: array_like</span>
<span class="sd">        Pixel indices across the dispersion axis for the background estimate.</span>
<span class="sd">    data: array_like</span>
<span class="sd">        The 2D spectrogram data array.</span>
<span class="sd">    err: array_like</span>
<span class="sd">        The 2D spectrogram uncertainty data array.</span>
<span class="sd">    fit: Fittable1DModel, optional</span>
<span class="sd">        Best fitting model function for the profile (default: None).</span>
<span class="sd">    bgd_fit: callable, optional</span>
<span class="sd">        Best fitting model function for the background of the profile (default: None).</span>
<span class="sd">    params: array_like, optional</span>
<span class="sd">        Best fitting model parameter array (default: None).</span>
<span class="sd">    PSF_guess: callable, optional</span>
<span class="sd">        Guessed fitting model function for the profile before the fit (default: None).</span>
<span class="sd">    outliers: array_like, optional</span>
<span class="sd">        Pixel indices of the outliers across the dispersion axis (default: None).</span>
<span class="sd">    sigma: int, optional</span>
<span class="sd">        Value of the sigma-clipping rejection (default: 3).</span>
<span class="sd">        Necessary only if an outlier array is given with the outliers keyword.</span>
<span class="sd">    live_fit: bool</span>
<span class="sd">        If True, plot is shown  in live during the fitting procedure (default: False).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    # Build a mock spectrogram with random Poisson noise:</span>
<span class="sd">    &gt;&gt;&gt; s0 = ChromaticPSF1D(Nx=100, Ny=100, saturation=1000)</span>
<span class="sd">    &gt;&gt;&gt; params = s0.generate_test_poly_params()</span>
<span class="sd">    &gt;&gt;&gt; saturation = params[-1]</span>
<span class="sd">    &gt;&gt;&gt; data = s0.evaluate(params)</span>
<span class="sd">    &gt;&gt;&gt; bgd = 10*np.ones_like(data)</span>
<span class="sd">    &gt;&gt;&gt; data += bgd</span>
<span class="sd">    &gt;&gt;&gt; data = np.random.poisson(data)</span>
<span class="sd">    &gt;&gt;&gt; data_errors = np.sqrt(data+1)</span>

<span class="sd">    # Fit the transverse profile:</span>
<span class="sd">    &gt;&gt;&gt; s, bgd_model = fit_transverse_PSF1D_profile(data, data_errors, w=20, ws=[30,50], pixel_step=50,</span>
<span class="sd">    ... saturation=saturation, live_fit=True, sigma=5)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Ny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bgd_indices</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">bgd_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">bgd_indices</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ny</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err</span><span class="p">[:,</span> <span class="n">x</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;original data&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bgd_indices</span><span class="p">,</span> <span class="n">bgd</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">bgd_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;bgd data&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">outliers</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">outliers</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err</span><span class="p">[</span><span class="n">outliers</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;go&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;outliers (</span><span class="si">{sigma}</span><span class="s2">$\sigma$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bgd_indices</span><span class="p">,</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">bgd_indices</span><span class="p">),</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitted bgd&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PSF_guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">PSF_guess</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;guessed profile&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bgd_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitted profile&quot;</span><span class="p">)</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">PSF_moffat</span> <span class="o">=</span> <span class="n">Moffat1D</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">PSF_moffat</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="s1">&#39;b+&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitted moffat&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transverse profile&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{p}</span><span class="s1">: {getattr(fit, p).value:.4g}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;x=</span><span class="si">{x}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">model_outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">+=</span> <span class="n">fit</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">model_outliers</span> <span class="o">+=</span> <span class="n">fit</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bgd_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">+=</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">model_outliers</span> <span class="o">+=</span> <span class="n">bgd_fit</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bgd_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="n">err</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span>  <span class="c1"># / model</span>
        <span class="n">residuals_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="o">/</span> <span class="n">err</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span>  <span class="c1"># / model</span>
        <span class="n">residuals_outliers</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">outliers</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="n">model_outliers</span><span class="p">)</span> <span class="o">/</span> <span class="n">err</span><span class="p">[</span><span class="n">outliers</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>  <span class="c1"># / model_outliers</span>
        <span class="n">residuals_outliers_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">outliers</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">/</span> <span class="n">err</span><span class="p">[</span><span class="n">outliers</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>  <span class="c1"># / model_outliers</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">residuals_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">outliers</span><span class="p">,</span> <span class="n">residuals_outliers</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">residuals_outliers_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;go&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">std</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">())</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;(data-fit)/err&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">live_fit</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="fit_chromatic_PSF1D"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_chromatic_PSF1D">[docs]</a><span class="k">def</span> <span class="nf">fit_chromatic_PSF1D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chromatic_psf</span><span class="p">,</span> <span class="n">bgd_model_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a chromatic PSF1D model on 2D data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: array_like</span>
<span class="sd">        2D array containing the image data.</span>
<span class="sd">    chromatic_psf: ChromaticPSF1D</span>
<span class="sd">        First guess for the chromatic PSF, filled with a first guess of the polynomial shape parameters, mandatory.</span>
<span class="sd">    bgd_model_func: callable, optional</span>
<span class="sd">        A 2D function to model the extracted background (default: None -&gt; null background)</span>
<span class="sd">    data_errors: np.array</span>
<span class="sd">        the 2D array uncertainties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s: ChromaticPSF1D</span>
<span class="sd">        The chromatic PSF containing all the information on the wavelength dependences of the parameters adn the flux_sum.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    # Build a mock spectrogram with random Poisson noise:</span>
<span class="sd">    &gt;&gt;&gt; s0 = ChromaticPSF1D(Nx=100, Ny=100, deg=4, saturation=1000)</span>
<span class="sd">    &gt;&gt;&gt; params = s0.generate_test_poly_params()</span>
<span class="sd">    &gt;&gt;&gt; s0.poly_params = params</span>
<span class="sd">    &gt;&gt;&gt; saturation = params[-1]</span>
<span class="sd">    &gt;&gt;&gt; data = s0.evaluate(params)</span>
<span class="sd">    &gt;&gt;&gt; bgd = 10*np.ones_like(data)</span>
<span class="sd">    &gt;&gt;&gt; data += bgd</span>
<span class="sd">    &gt;&gt;&gt; data = np.random.poisson(data)</span>
<span class="sd">    &gt;&gt;&gt; data_errors = np.sqrt(data+1)</span>

<span class="sd">    # Estimate the first guess values</span>
<span class="sd">    &gt;&gt;&gt; s, bgd_model_func = fit_transverse_PSF1D_profile(data, data_errors, w=20, ws=[30,50],</span>
<span class="sd">    ... pixel_step=1, saturation=saturation, live_fit=False, deg=4)</span>
<span class="sd">    &gt;&gt;&gt; s.plot_summary(truth=s0)</span>

<span class="sd">    # Fit the data:</span>
<span class="sd">    &gt;&gt;&gt; s = fit_chromatic_PSF1D(data, s, bgd_model_func=bgd_model_func, data_errors=data_errors)</span>
<span class="sd">    &gt;&gt;&gt; s.plot_summary(truth=s0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">Ny</span> <span class="o">!=</span> <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">Ny</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Data y shape </span><span class="si">{Ny}</span><span class="s2"> different from ChromaticPSF1D input self.Ny </span><span class="si">{chromatic_psf.Ny}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Nx</span> <span class="o">!=</span> <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">Nx</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Data x shape </span><span class="si">{Nx}</span><span class="s2"> different from ChromaticPSF1D input self.Nx </span><span class="si">{chromatic_psf.Nx}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">poly_params</span><span class="p">)</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ny</span><span class="p">)</span>

    <span class="n">W</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">data_errors</span> <span class="o">*</span> <span class="n">data_errors</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nx</span><span class="p">)]</span>
    <span class="n">poly_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bgd_model_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bgd</span> <span class="o">=</span> <span class="n">bgd_model_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">),</span> <span class="n">pixels</span><span class="p">)</span>

    <span class="n">data_subtracted</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">bgd</span>
    <span class="n">bgd_std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">bgd</span><span class="p">)))</span>

    <span class="c1"># import warnings</span>
    <span class="c1"># warnings.filterwarnings(&#39;error&#39;)</span>

    <span class="k">def</span> <span class="nf">spectrogram_chisq</span><span class="p">(</span><span class="n">shape_params</span><span class="p">):</span>
        <span class="c1"># linear regression for the amplitude parameters</span>
        <span class="n">poly_params</span><span class="p">[</span><span class="n">Nx</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">shape_params</span><span class="p">)</span>
        <span class="n">profile_params</span> <span class="o">=</span> <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_poly_params_to_profile_params</span><span class="p">(</span><span class="n">poly_params</span><span class="p">,</span> <span class="n">force_positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">profile_params</span><span class="p">[:</span><span class="n">Nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># try:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">PSF1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="o">*</span><span class="n">profile_params</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nx</span><span class="p">)])</span>
        <span class="c1"># except:</span>
        <span class="c1">#     for x in range(Nx):</span>
        <span class="c1">#         my_logger.warning(f&quot;{x} {profile_params[x, :]}&quot;)</span>
        <span class="n">J_dot_W_dot_J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">J</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nx</span><span class="p">)])</span>
        <span class="c1"># my_logger.warning(f&quot;{shape_params}&quot;)</span>
        <span class="c1"># if np.any(np.isclose(J_dot_W_dot_J, 0, rtol=1e-6)):</span>
        <span class="c1">#     pass</span>
        <span class="c1"># my_logger.warning(f&quot;crasssshhhhh {shape_params}&quot;)</span>
        <span class="c1"># profile_params = chromatic_psf.from_poly_params_to_profile_params(poly_params, force_positive=True, verbose=True)</span>
        <span class="c1"># for x in range(Nx):</span>
        <span class="c1">#   my_logger.warning(f&quot;{x} {profile_params[x, :]}&quot;)</span>
        <span class="c1">#   my_logger.warning(f&quot;{x} {J[x]}&quot;)</span>
        <span class="c1"># J_dot_W_dot_J[np.isclose(J_dot_W_dot_J, 0, rtol=1e-3) ] = 1e-3</span>
        <span class="c1"># try:</span>
        <span class="n">amplitude_params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">J</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data_subtracted</span><span class="p">[:,</span> <span class="n">x</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">J_dot_W_dot_J</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">if</span> <span class="n">J_dot_W_dot_J</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">bgd_std</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
            <span class="nb">range</span><span class="p">(</span><span class="n">Nx</span><span class="p">)]</span>
        <span class="c1"># amplitude_params = [</span>
        <span class="c1">#    J[x].T.dot(W[x]).dot(data_subtracted[:, x]) / (J_dot_W_dot_J[x]) for x in</span>
        <span class="c1">#    range(Nx)]</span>

        <span class="c1"># except RuntimeWarning:</span>
        <span class="c1">#    my_logger.warning(f&quot;{J_dot_W_dot_J} {profile_params} {W} {J}&quot;)</span>

        <span class="n">poly_params</span><span class="p">[:</span><span class="n">Nx</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude_params</span>
        <span class="n">in_bounds</span><span class="p">,</span> <span class="n">penalty</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">check_bounds</span><span class="p">(</span><span class="n">poly_params</span><span class="p">,</span> <span class="n">noise_level</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">bgd_std</span><span class="p">)</span>
        <span class="c1"># my_logger.warning(f&quot;amplitude {amplitude_params}&quot;)</span>
        <span class="c1"># if in_bounds is False:</span>
        <span class="c1">#     for k, n in enumerate(chromatic_psf.PSF1D.param_names):</span>
        <span class="c1">#         if n in name:</span>
        <span class="c1">#             my_logger.warning(f&quot;{name} {profile_params[:, k]}  {shape_params} {penalty} {bgd_std} {name}&quot;)</span>
        <span class="c1"># if False:</span>
        <span class="c1">#     my_logger.warning(f&quot;crasssshhhhh {shape_params}&quot;)</span>
        <span class="c1">#     # profile_params = chromatic_psf.from_poly_params_to_profile_params(poly_params, force_positive=True, verbose=True)</span>
        <span class="c1">#     for x in range(Nx):</span>
        <span class="c1">#         my_logger.warning(f&quot;\n{x} {profile_params[x, :]} {J[x]} {J_dot_W_dot_J[x]}&quot;)</span>
        <span class="c1">#     my_logger.warning(f&quot;\n{J_dot_W_dot_J}&quot;)</span>
        <span class="c1">#     sys.exit()</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">poly_params</span><span class="p">)</span>
        <span class="c1"># if bgd_model_func is not None:</span>
        <span class="c1">#     mod += bgd</span>
        <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">poly_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">poly_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">mod</span> <span class="o">-</span> <span class="n">data_subtracted</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">penalty</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(((</span><span class="n">mod</span> <span class="o">-</span> <span class="n">data_subtracted</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_errors</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">penalty</span>

    <span class="c1"># def spectrogram_chisq_jacobian(shape_params):</span>
    <span class="c1">#     poly_params[Nx:] = shape_params</span>
    <span class="c1">#     profile_params = s.from_poly_params_to_profile_params(poly_params)</span>
    <span class="c1">#     J = np.array([s.PSF1D.evaluate(pixels, *profile_params[x, :]) for x in range(Nx)])</span>
    <span class="c1">#     grad_J = np.array([s.PSF1D.fit_deriv(pixels, *profile_params[x, :]).T for x in range(Nx)])</span>
    <span class="c1">#     amplitude_params = np.array([J[x].T.dot(W[x]).dot(data[:, x]) / (J[x].T.dot(W[x]).dot(J[x]))</span>
    <span class="c1">#  for x in range(Nx)])</span>
    <span class="c1">#     diff = np.array([J[x].dot(amplitude_params[x]) - data[:, x] for x in range(Nx)])</span>
    <span class="c1">#     grad_chi2_over_p = []</span>
    <span class="c1">#     my_logger.warning(f&quot;{shape_params[:-1]} {grad_J.shape}&quot;)</span>
    <span class="c1">#     for p, name in enumerate(shape_params[:-1]):</span>
    <span class="c1">#         my_logger.warning(f&quot;{p} {name} {2*grad_J[10, :, p]}&quot;)</span>
    <span class="c1">#         my_logger.warning(f&quot;{p} {name} {2*grad_J[10, :, p].T.dot(np.outer(W[10].</span>
    <span class="c1"># dot(diff[10]),amplitude_params[10].T))}&quot;)</span>
    <span class="c1">#         grad_chi2_over_p.append([2*grad_J[x, :, p].T.dot(np.outer(W[x].dot(diff[x]),amplitude_params.T))</span>
    <span class="c1">#  for x in range(Nx)])</span>
    <span class="c1">#     return grad_chi2_over_p</span>
    <span class="c1"># grad = spectrogram_chisq_jacobian(guess[Nx:])</span>
    <span class="c1"># my_logger.warning(f&quot;{grad.shape} {grad}&quot;)</span>

    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start chisq: {spectrogram_chisq(guess[Nx:])} with </span><span class="si">{guess[Nx:]}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">fix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">n_poly_params</span> <span class="o">-</span> <span class="n">Nx</span><span class="p">)</span>
    <span class="n">fix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">set_bounds</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># fix[:Nx] = [True] * Nx</span>
    <span class="c1"># noinspection PyArgumentList</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Minuit</span><span class="o">.</span><span class="n">from_array_func</span><span class="p">(</span><span class="n">fcn</span><span class="o">=</span><span class="n">spectrogram_chisq</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">guess</span><span class="p">[</span><span class="n">Nx</span><span class="p">:],</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">[</span><span class="n">Nx</span><span class="p">:],</span> <span class="n">errordef</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">fix</span><span class="o">=</span><span class="n">fix</span><span class="p">,</span> <span class="n">print_level</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="n">Nx</span><span class="p">:])</span>
    <span class="n">m</span><span class="o">.</span><span class="n">migrad</span><span class="p">()</span>
    <span class="c1"># m.hesse()</span>
    <span class="c1"># print(m.np_matrix())</span>
    <span class="c1"># print(m.np_matrix(correlation=True))</span>
    <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">poly_params</span><span class="p">[</span><span class="n">Nx</span><span class="p">:]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">np_values</span><span class="p">()</span>
    <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">profile_params</span> <span class="o">=</span> <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_poly_params_to_profile_params</span><span class="p">(</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">poly_params</span><span class="p">,</span>
                                                                                    <span class="n">force_positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">fill_table_with_profile_params</span><span class="p">(</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">profile_params</span><span class="p">)</span>
    <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">from_profile_params_to_shape_params</span><span class="p">(</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">profile_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="c1"># Plot data, best fit model and residuals:</span>
        <span class="n">chromatic_psf</span><span class="o">.</span><span class="n">plot_summary</span><span class="p">()</span>
        <span class="n">plot_chromatic_PSF1D_residuals</span><span class="p">(</span><span class="n">chromatic_psf</span><span class="p">,</span> <span class="n">bgd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Best fit&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chromatic_psf</span></div>


<div class="viewcode-block" id="plot_chromatic_PSF1D_residuals"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.plot_chromatic_PSF1D_residuals">[docs]</a><span class="k">def</span> <span class="nf">plot_chromatic_PSF1D_residuals</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bgd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the residuals after fit_chromatic_PSF1D function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s: ChromaticPSF1D</span>
<span class="sd">        The chromatic PSF1D function that has been fitted to data.</span>
<span class="sd">    bgd: array_like</span>
<span class="sd">        The 2D background array.</span>
<span class="sd">    data: array_like</span>
<span class="sd">        The 2D data array.</span>
<span class="sd">    data_errors: array_like</span>
<span class="sd">        The 2D data uncertainty array.</span>
<span class="sd">    guess: array_like, optional</span>
<span class="sd">        The guessed profile before the fit (default: None).</span>
<span class="sd">    live_fit: bool</span>
<span class="sd">        If True, the plot is shown during the fitting procedure (default: False).</span>
<span class="sd">    title: str, optional</span>
<span class="sd">        Title of the plot (default: &quot;&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">im0</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">im_guess</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">+</span> <span class="n">bgd</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_guess</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">poly_params</span><span class="p">)</span> <span class="o">+</span> <span class="n">bgd</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Guess&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">im2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">im_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_errors</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;(Data-Guess)/Data_errors&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">im3</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">im4</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">fit</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_errors</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;(Data-Fit)/Data_errors&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im4</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">live_fit</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="PSF2D_chisq"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF2D_chisq">[docs]</a><span class="k">def</span> <span class="nf">PSF2D_chisq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">zz_err</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zz_err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">mod</span> <span class="o">-</span> <span class="n">zz</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(((</span><span class="n">mod</span> <span class="o">-</span> <span class="n">zz</span><span class="p">)</span> <span class="o">/</span> <span class="n">zz_err</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="PSF2D_chisq_jac"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF2D_chisq_jac">[docs]</a><span class="k">def</span> <span class="nf">PSF2D_chisq_jac</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">zz_err</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">zz</span>
    <span class="n">jac</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_deriv</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zz_err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zz_err2</span> <span class="o">=</span> <span class="n">zz_err</span> <span class="o">*</span> <span class="n">zz_err</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">zz_err2</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span></div>

<span class="c1"># DO NOT WORK</span>
<span class="c1"># def fit_PSF2D_outlier_removal(x, y, data, sigma=3.0, niter=3, guess=None, bounds=None):</span>
<span class="c1">#     &quot;&quot;&quot;Fit a PSF 2D model with parameters:</span>
<span class="c1">#         amplitude_gauss, x_mean, stddev, amplitude_moffat, alpha, gamma, saturation</span>
<span class="c1">#     using scipy. Find outliers data point above sigma*data_errors from the fit over niter iterations.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     x: np.array</span>
<span class="c1">#         2D array of the x coordinates.</span>
<span class="c1">#     y: np.array</span>
<span class="c1">#         2D array of the y coordinates.</span>
<span class="c1">#     data: np.array</span>
<span class="c1">#         the 1D array profile.</span>
<span class="c1">#     guess: array_like, optional</span>
<span class="c1">#         list containing a first guess for the PSF parameters (default: None).</span>
<span class="c1">#     bounds: list, optional</span>
<span class="c1">#         2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="c1">#     sigma: int</span>
<span class="c1">#         the sigma limit to exclude data points (default: 3).</span>
<span class="c1">#     niter: int</span>
<span class="c1">#         the number of loop iterations to exclude  outliers and refit the model (default: 2).</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     fitted_model: PSF2D</span>
<span class="c1">#         the PSF2D fitted model.</span>
<span class="c1">#</span>
<span class="c1">#     Examples</span>
<span class="c1">#     --------</span>
<span class="c1">#</span>
<span class="c1">#     Create the model:</span>
<span class="c1">#     &gt;&gt;&gt; X, Y = np.mgrid[:50,:50]</span>
<span class="c1">#     &gt;&gt;&gt; PSF = PSF2D()</span>
<span class="c1">#     &gt;&gt;&gt; p = (1000, 25, 25, 5, 1, -0.2, 1, 6000)</span>
<span class="c1">#     &gt;&gt;&gt; Z = PSF.evaluate(X, Y, *p)</span>
<span class="c1">#     &gt;&gt;&gt; Z += 100*np.exp(-((X-10)**2+(Y-10)**2)/4)</span>
<span class="c1">#     &gt;&gt;&gt; Z_err = np.sqrt(1+Z)</span>
<span class="c1">#</span>
<span class="c1">#     Prepare the fit:</span>
<span class="c1">#     &gt;&gt;&gt; guess = (1000, 27, 23, 3.2, 1.2, -0.1, 2,  6000)</span>
<span class="c1">#     &gt;&gt;&gt; bounds = np.array(((0, 6000), (10, 40), (10, 40), (0.5, 10), (0.5, 5), (-1, 0), (0.01, 10), (0, 8000)))</span>
<span class="c1">#     &gt;&gt;&gt; bounds = bounds.T</span>
<span class="c1">#</span>
<span class="c1">#     Fit without bars:</span>
<span class="c1">#     &gt;&gt;&gt; model = fit_PSF2D_outlier_removal(X, Y, Z, guess=guess, bounds=bounds, sigma=7, niter=5)</span>
<span class="c1">#     &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="c1">#     &gt;&gt;&gt; print(res, p)</span>
<span class="c1">#     &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-1))</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     gg_init = PSF2D()</span>
<span class="c1">#     if guess is not None:</span>
<span class="c1">#         for ip, p in enumerate(gg_init.param_names):</span>
<span class="c1">#             getattr(gg_init, p).value = guess[ip]</span>
<span class="c1">#     if bounds is not None:</span>
<span class="c1">#         for ip, p in enumerate(gg_init.param_names):</span>
<span class="c1">#             getattr(gg_init, p).min = bounds[0][ip]</span>
<span class="c1">#             getattr(gg_init, p).max = bounds[1][ip]</span>
<span class="c1">#     gg_init.saturation.fixed = True</span>
<span class="c1">#     with warnings.catch_warnings():</span>
<span class="c1">#         # Ignore model linearity warning from the fitter</span>
<span class="c1">#         warnings.simplefilter(&#39;ignore&#39;)</span>
<span class="c1">#         fit = LevMarLSQFitterWithNan()</span>
<span class="c1">#         or_fit = fitting.FittingWithOutlierRemoval(fit, sigma_clip, niter=niter, sigma=sigma)</span>
<span class="c1">#         # get fitted model and filtered data</span>
<span class="c1">#         or_fitted_model, filtered_data = or_fit(gg_init, x, y, data)</span>
<span class="c1">#         if parameters.VERBOSE:</span>
<span class="c1">#             print(or_fitted_model)</span>
<span class="c1">#         if parameters.DEBUG:</span>
<span class="c1">#             print(fit.fit_info)</span>
<span class="c1">#         print(fit.fit_info)</span>
<span class="c1">#         return or_fitted_model</span>


<div class="viewcode-block" id="fit_PSF2D"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_PSF2D">[docs]</a><span class="k">def</span> <span class="nf">fit_PSF2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;minimize&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a PSF 2D model with parameters :</span>
<span class="sd">        amplitude, x_mean, y_mean, stddev, eta, alpha, gamma, saturation</span>

<span class="sd">    using basin hopping global minimization method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        2D array of the x coordinates from meshgrid.</span>
<span class="sd">    y: np.array</span>
<span class="sd">        2D array of the y coordinates from meshgrid.</span>
<span class="sd">    data: np.array</span>
<span class="sd">        the 2D array image.</span>
<span class="sd">    guess: array_like, optional</span>
<span class="sd">        List containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="sd">    data_errors: np.array</span>
<span class="sd">        the 2D array uncertainties.</span>
<span class="sd">    method: str, optional</span>
<span class="sd">        the minimisation method: &#39;minimize&#39; or &#39;basinhopping&#39; (default: &#39;minimize&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: PSF2D</span>
<span class="sd">        the PSF2D fitted model.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Create the model:</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; X, Y = np.mgrid[:50,:50]</span>
<span class="sd">    &gt;&gt;&gt; PSF = PSF2D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 25, 25, 5, 1, -0.4, 1, 60)</span>
<span class="sd">    &gt;&gt;&gt; Z = PSF.evaluate(X, Y, *p)</span>
<span class="sd">    &gt;&gt;&gt; Z_err = np.sqrt(Z)/10.</span>

<span class="sd">    Prepare the fit:</span>
<span class="sd">    &gt;&gt;&gt; guess = (52, 22, 22, 3.2, 1.2, -0.1, 2, 60)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((1, 200), (10, 40), (10, 40), (0.5, 10), (0.5, 5), (-100, 200), (0.01, 10), (0, 400))</span>

<span class="sd">    Fit with error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF2D(X, Y, Z, guess=guess, bounds=bounds, data_errors=Z_err)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    Fit without error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF2D(X, Y, Z, guess=guess, bounds=bounds, data_errors=None)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    Fit with error bars and basin hopping method:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF2D(X, Y, Z, guess=guess, bounds=bounds, data_errors=Z_err, method=&#39;basinhopping&#39;)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="p">()</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;minimize&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">PSF2D_chisq</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="n">PSF2D_chisq_jac</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;basinhopping&#39;</span><span class="p">:</span>
        <span class="n">minimizer_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">PSF2D_chisq_jac</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">basinhopping</span><span class="p">(</span><span class="n">PSF2D_chisq</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">minimizer_kwargs</span><span class="o">=</span><span class="n">minimizer_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Unknown method </span><span class="si">{method}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{res}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">PSF best fitting parameters:</span><span class="se">\n</span><span class="si">{PSF}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PSF</span></div>


<div class="viewcode-block" id="fit_PSF2D_minuit"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_PSF2D_minuit">[docs]</a><span class="k">def</span> <span class="nf">fit_PSF2D_minuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a PSF 2D model with parameters :</span>
<span class="sd">        amplitude, x_mean, y_mean, stddev, eta, alpha, gamma, saturation</span>

<span class="sd">    using basin hopping global minimization method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        2D array of the x coordinates from meshgrid.</span>
<span class="sd">    y: np.array</span>
<span class="sd">        2D array of the y coordinates from meshgrid.</span>
<span class="sd">    data: np.array</span>
<span class="sd">        the 2D array image.</span>
<span class="sd">    guess: array_like, optional</span>
<span class="sd">        List containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="sd">    data_errors: np.array</span>
<span class="sd">        the 2D array uncertainties.</span>
<span class="sd">    method: str, optional</span>
<span class="sd">        the minimisation method: &#39;minimize&#39; or &#39;basinhopping&#39; (default: &#39;minimize&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: PSF2D</span>
<span class="sd">        the PSF2D fitted model.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Create the model:</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; X, Y = np.mgrid[:50,:50]</span>
<span class="sd">    &gt;&gt;&gt; PSF = PSF2D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 25, 25, 5, 1, -0.4, 1, 60)</span>
<span class="sd">    &gt;&gt;&gt; Z = PSF.evaluate(X, Y, *p)</span>
<span class="sd">    &gt;&gt;&gt; Z_err = np.sqrt(Z)/10.</span>

<span class="sd">    Prepare the fit:</span>
<span class="sd">    &gt;&gt;&gt; guess = (52, 22, 22, 3.2, 1.2, -0.1, 2, 60)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((1, 200), (10, 40), (10, 40), (0.5, 10), (0.5, 5), (-100, 200), (0.01, 10), (0, 400))</span>

<span class="sd">    Fit with error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF2D_minuit(X, Y, Z, guess=guess, bounds=bounds, data_errors=Z_err)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    Fit without error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF2D_minuit(X, Y, Z, guess=guess, bounds=bounds, data_errors=None)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="p">()</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">error</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">))</span>
    <span class="n">error</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">T</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chisq_PSF2D</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PSF2D_chisq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chisq_PSF2D_jac</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PSF2D_chisq_jac</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">)</span>

    <span class="n">fix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">error</span><span class="o">.</span><span class="n">size</span>
    <span class="n">fix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># noinspection PyArgumentList</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Minuit</span><span class="o">.</span><span class="n">from_array_func</span><span class="p">(</span><span class="n">fcn</span><span class="o">=</span><span class="n">chisq_PSF2D</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">errordef</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">fix</span><span class="o">=</span><span class="n">fix</span><span class="p">,</span> <span class="n">print_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="n">chisq_PSF2D_jac</span><span class="p">)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">m</span><span class="o">.</span><span class="n">migrad</span><span class="p">()</span>
    <span class="n">popt</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">np_values</span><span class="p">()</span>

    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{popt}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF2D</span><span class="p">(</span><span class="o">*</span><span class="n">popt</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">PSF best fitting parameters:</span><span class="se">\n</span><span class="si">{PSF}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PSF</span></div>


<div class="viewcode-block" id="PSF1D_chisq"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D_chisq">[docs]</a><span class="k">def</span> <span class="nf">PSF1D_chisq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">yy_err</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1e20</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yy</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1e20</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">yy</span>
    <span class="k">if</span> <span class="n">yy_err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">diff</span> <span class="o">/</span> <span class="n">yy_err</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="PSF1D_chisq_jac"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.PSF1D_chisq_jac">[docs]</a><span class="k">def</span> <span class="nf">PSF1D_chisq_jac</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">yy_err</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">yy</span>
    <span class="n">jac</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_deriv</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yy_err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yy_err2</span> <span class="o">=</span> <span class="n">yy_err</span> <span class="o">*</span> <span class="n">yy_err</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">yy_err2</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span></div>


<div class="viewcode-block" id="fit_PSF1D"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_PSF1D">[docs]</a><span class="k">def</span> <span class="nf">fit_PSF1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;minimize&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a PSF 1D model with parameters :</span>
<span class="sd">        amplitude_gauss, x_mean, stddev, amplitude_moffat, alpha, gamma, saturation</span>

<span class="sd">    using basin hopping global minimization method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        1D array of the x coordinates.</span>
<span class="sd">    data: np.array</span>
<span class="sd">        the 1D array profile.</span>
<span class="sd">    guess: array_like, optional</span>
<span class="sd">        list containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="sd">    data_errors: np.array</span>
<span class="sd">        the 1D array uncertainties.</span>
<span class="sd">    method: str, optional</span>
<span class="sd">        method to use for the minimisation: choose between minimize and basinhopping.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: PSF1D</span>
<span class="sd">        the PSF1D fitted model.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Create the model:</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; X = np.arange(0, 50)</span>
<span class="sd">    &gt;&gt;&gt; PSF = PSF1D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 25, 5, 1, -0.2, 1, 60)</span>
<span class="sd">    &gt;&gt;&gt; Y = PSF.evaluate(X, *p)</span>
<span class="sd">    &gt;&gt;&gt; Y_err = np.sqrt(Y)/10.</span>

<span class="sd">    Prepare the fit:</span>
<span class="sd">    &gt;&gt;&gt; guess = (60, 20, 3.2, 1.2, -0.1, 2,  60)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((0, 200), (10, 40), (0.5, 10), (0.5, 5), (-10, 200), (0.01, 10), (0, 400))</span>

<span class="sd">    Fit with error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF1D(X, Y, guess=guess, bounds=bounds, data_errors=Y_err)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    Fit without error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF1D(X, Y, guess=guess, bounds=bounds, data_errors=None)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    Fit with error bars and basin hopping method:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF1D(X, Y, guess=guess, bounds=bounds, data_errors=Y_err, method=&#39;basinhopping&#39;)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-3))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;minimize&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">PSF1D_chisq</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="n">PSF1D_chisq_jac</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;basinhopping&#39;</span><span class="p">:</span>
        <span class="n">minimizer_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="n">PSF1D_chisq_jac</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">basinhopping</span><span class="p">(</span><span class="n">PSF1D_chisq</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">minimizer_kwargs</span><span class="o">=</span><span class="n">minimizer_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Unknown method </span><span class="si">{method}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{res}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">PSF best fitting parameters:</span><span class="se">\n</span><span class="si">{PSF}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PSF</span></div>


<div class="viewcode-block" id="fit_PSF1D_outlier_removal"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_PSF1D_outlier_removal">[docs]</a><span class="k">def</span> <span class="nf">fit_PSF1D_outlier_removal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;minimize&#39;</span><span class="p">,</span>
                              <span class="n">niter_basinhopping</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">T_basinhopping</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a PSF 1D model with parameters:</span>
<span class="sd">        amplitude_gauss, x_mean, stddev, amplitude_moffat, alpha, gamma, saturation</span>

<span class="sd">    using scipy. Find outliers data point above sigma*data_errors from the fit over niter iterations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        1D array of the x coordinates.</span>
<span class="sd">    data: np.array</span>
<span class="sd">        the 1D array profile.</span>
<span class="sd">    data_errors: np.array</span>
<span class="sd">        the 1D array uncertainties.</span>
<span class="sd">    guess: array_like, optional</span>
<span class="sd">        list containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="sd">    sigma: int</span>
<span class="sd">        the sigma limit to exclude data points (default: 3).</span>
<span class="sd">    niter: int</span>
<span class="sd">        the number of loop iterations to exclude  outliers and refit the model (default: 2).</span>
<span class="sd">    method: str</span>
<span class="sd">        Can be &#39;minimize&#39; or &#39;basinhopping&#39; (default: &#39;minimize&#39;).</span>
<span class="sd">    niter_basinhopping: int, optional</span>
<span class="sd">        The number of basin hops (default: 5)</span>
<span class="sd">    T_basinhopping: float, optional</span>
<span class="sd">        The temperature for the basin hops (default: 0.2)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: PSF1D</span>
<span class="sd">        the PSF1D fitted model.</span>
<span class="sd">    outliers: list</span>
<span class="sd">        the list of the outlier indices.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Create the model:</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; X = np.arange(0, 50)</span>
<span class="sd">    &gt;&gt;&gt; PSF = PSF1D()</span>
<span class="sd">    &gt;&gt;&gt; p = (1000, 25, 5, 1, -0.2, 1, 6000)</span>
<span class="sd">    &gt;&gt;&gt; Y = PSF.evaluate(X, *p)</span>
<span class="sd">    &gt;&gt;&gt; Y += 100*np.exp(-((X-10)/2)**2)</span>
<span class="sd">    &gt;&gt;&gt; Y_err = np.sqrt(1+Y)</span>

<span class="sd">    Prepare the fit:</span>
<span class="sd">    &gt;&gt;&gt; guess = (600, 27, 3.2, 1.2, -0.1, 2,  6000)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((0, 6000), (10, 40), (0.5, 10), (0.5, 5), (-1, 0), (0.01, 10), (0, 8000))</span>

<span class="sd">    Fit without bars:</span>
<span class="sd">    &gt;&gt;&gt; model, outliers = fit_PSF1D_outlier_removal(X, Y, guess=guess, bounds=bounds,</span>
<span class="sd">    ... sigma=3, niter=5, method=&quot;minimize&quot;)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-1))</span>

<span class="sd">    Fit with error bars:</span>
<span class="sd">    &gt;&gt;&gt; model, outliers = fit_PSF1D_outlier_removal(X, Y, guess=guess, bounds=bounds, data_errors=Y_err,</span>
<span class="sd">    ... sigma=3, niter=2, method=&quot;minimize&quot;)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-1))</span>

<span class="sd">    Fit with error bars and basinhopping:</span>
<span class="sd">    &gt;&gt;&gt; model, outliers = fit_PSF1D_outlier_removal(X, Y, guess=guess, bounds=bounds, data_errors=Y_err,</span>
<span class="sd">    ... sigma=3, niter=5, method=&quot;basinhopping&quot;, niter_basinhopping=20)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
        <span class="c1"># first fit</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">data_errors</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;minimize&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">PSF1D_chisq</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">PSF1D_chisq_jac</span><span class="p">,</span>
                           <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;basinhopping&#39;</span><span class="p">:</span>
            <span class="n">minimizer_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">PSF1D_chisq_jac</span><span class="p">,</span>
                                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">err</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">basinhopping</span><span class="p">(</span><span class="n">PSF1D_chisq</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T_basinhopping</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="n">niter_basinhopping</span><span class="p">,</span>
                               <span class="n">minimizer_kwargs</span><span class="o">=</span><span class="n">minimizer_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Unknown method </span><span class="si">{method}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">niter=</span><span class="si">{step}</span><span class="se">\n</span><span class="si">{res}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># update the model and the guess</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="c1"># remove outliers</span>
        <span class="n">indices_no_nan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">indices_no_nan</span><span class="p">])</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">indices_no_nan</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_errors</span><span class="p">[</span><span class="n">indices_no_nan</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outliers</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">PSF best fitting parameters:</span><span class="se">\n</span><span class="si">{model}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">outliers</span></div>


<div class="viewcode-block" id="fit_PSF1D_minuit"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_PSF1D_minuit">[docs]</a><span class="k">def</span> <span class="nf">fit_PSF1D_minuit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a PSF 1D model with parameters:</span>
<span class="sd">        amplitude_gauss, x_mean, stddev, amplitude_moffat, alpha, gamma, saturation</span>

<span class="sd">    using Minuit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        1D array of the x coordinates.</span>
<span class="sd">    data: np.array</span>
<span class="sd">        the 1D array profile.</span>
<span class="sd">    guess: array_like, optional</span>
<span class="sd">        list containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="sd">    data_errors: np.array</span>
<span class="sd">        the 1D array uncertainties.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: PSF1D</span>
<span class="sd">        the PSF1D fitted model.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Create the model:</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; X = np.arange(0, 50)</span>
<span class="sd">    &gt;&gt;&gt; PSF = PSF1D()</span>
<span class="sd">    &gt;&gt;&gt; p = (50, 25, 5, 1, -0.2, 1, 60)</span>
<span class="sd">    &gt;&gt;&gt; Y = PSF.evaluate(X, *p)</span>
<span class="sd">    &gt;&gt;&gt; Y_err = np.sqrt(1+Y)</span>

<span class="sd">    Prepare the fit:</span>
<span class="sd">    &gt;&gt;&gt; guess = (60, 20, 3.2, 1.2, -0.1, 2,  60)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((0, 200), (10, 40), (0.5, 10), (0.5, 5), (-1, 0), (0.01, 10), (0, 400))</span>

<span class="sd">    Fit with error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF1D_minuit(X, Y, guess=guess, bounds=bounds, data_errors=Y_err)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-2))</span>

<span class="sd">    Fit without error bars:</span>
<span class="sd">    &gt;&gt;&gt; model = fit_PSF1D_minuit(X, Y, guess=guess, bounds=bounds, data_errors=None)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-2))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">PSF1D_chisq_v2</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">-</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">diff</span> <span class="o">/</span> <span class="n">data_errors</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">PSF1D_chisq_v2_jac</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">data</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yy_err2</span> <span class="o">=</span> <span class="n">data_errors</span> <span class="o">*</span> <span class="n">data_errors</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">yy_err2</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span>

    <span class="n">error</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">fix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">fix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># noinspection PyArgumentList</span>
    <span class="c1"># 3 times faster with gradient</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Minuit</span><span class="o">.</span><span class="n">from_array_func</span><span class="p">(</span><span class="n">fcn</span><span class="o">=</span><span class="n">PSF1D_chisq_v2</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">errordef</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="n">fix</span><span class="p">,</span>
                               <span class="n">print_level</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="n">PSF1D_chisq_v2_jac</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">migrad</span><span class="p">()</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">np_values</span><span class="p">())</span>

    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">PSF best fitting parameters:</span><span class="se">\n</span><span class="si">{PSF}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PSF</span></div>


<div class="viewcode-block" id="fit_PSF1D_minuit_outlier_removal"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.psf.fit_PSF1D_minuit_outlier_removal">[docs]</a><span class="k">def</span> <span class="nf">fit_PSF1D_minuit_outlier_removal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_errors</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">consecutive</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit a PSF 1D model with parameters:</span>
<span class="sd">        amplitude_gauss, x_mean, stddev, amplitude_moffat, alpha, gamma, saturation</span>

<span class="sd">    using Minuit. Find outliers data point above sigma*data_errors from the fit over niter iterations.</span>
<span class="sd">    Only at least 3 consecutive outliers are considered.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: np.array</span>
<span class="sd">        1D array of the x coordinates.</span>
<span class="sd">    data: np.array</span>
<span class="sd">        the 1D array profile.</span>
<span class="sd">    data_errors: np.array</span>
<span class="sd">        the 1D array uncertainties.</span>
<span class="sd">    guess: array_like, optional</span>
<span class="sd">        list containing a first guess for the PSF parameters (default: None).</span>
<span class="sd">    bounds: list, optional</span>
<span class="sd">        2D list containing bounds for the PSF parameters with format ((min,...), (max...)) (default: None)</span>
<span class="sd">    sigma: int</span>
<span class="sd">        the sigma limit to exclude data points (default: 3).</span>
<span class="sd">    niter: int</span>
<span class="sd">        the number of loop iterations to exclude  outliers and refit the model (default: 2).</span>
<span class="sd">    consecutive: int</span>
<span class="sd">        the number of outliers that have to be consecutive to be considered (default: 3).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fitted_model: PSF1D</span>
<span class="sd">        the PSF1D fitted model.</span>
<span class="sd">    outliers: list</span>
<span class="sd">        the list of the outlier indices.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Create the model:</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; X = np.arange(0, 50)</span>
<span class="sd">    &gt;&gt;&gt; PSF = PSF1D()</span>
<span class="sd">    &gt;&gt;&gt; p = (1000, 25, 5, 1, -0.2, 1, 6000)</span>
<span class="sd">    &gt;&gt;&gt; Y = PSF.evaluate(X, *p)</span>
<span class="sd">    &gt;&gt;&gt; Y += 100*np.exp(-((X-10)/2)**2)</span>
<span class="sd">    &gt;&gt;&gt; Y_err = np.sqrt(1+Y)</span>

<span class="sd">    Prepare the fit:</span>
<span class="sd">    &gt;&gt;&gt; guess = (600, 20, 3.2, 1.2, -0.1, 2,  6000)</span>
<span class="sd">    &gt;&gt;&gt; bounds = ((0, 6000), (10, 40), (0.5, 10), (0.5, 5), (-1, 0), (0.01, 10), (0, 8000))</span>

<span class="sd">    Fit with error bars:</span>
<span class="sd">    &gt;&gt;&gt; model, outliers = fit_PSF1D_minuit_outlier_removal(X, Y, guess=guess, bounds=bounds, data_errors=Y_err,</span>
<span class="sd">    ... sigma=3, niter=2, consecutive=3)</span>
<span class="sd">    &gt;&gt;&gt; res = [getattr(model, p).value for p in model.param_names]</span>
<span class="sd">    &gt;&gt;&gt; assert np.all(np.isclose(p[:-1], res[:-1], rtol=1e-1))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">(</span><span class="o">*</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">()</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outliers</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">PSF1D_chisq_v2</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">diff</span> <span class="o">/</span> <span class="n">data_errors</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">PSF1D_chisq_v2_jac</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">data</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yy_err2</span> <span class="o">=</span> <span class="n">data_errors</span> <span class="o">*</span> <span class="n">data_errors</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jac</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">yy_err2</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))])</span>

    <span class="n">error</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">fix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
    <span class="n">fix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">consecutive_outliers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
        <span class="c1"># noinspection PyArgumentList</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Minuit</span><span class="o">.</span><span class="n">from_array_func</span><span class="p">(</span><span class="n">fcn</span><span class="o">=</span><span class="n">PSF1D_chisq_v2</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">errordef</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="n">fix</span><span class="p">,</span>
                                   <span class="n">print_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="n">PSF1D_chisq_v2_jac</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">migrad</span><span class="p">()</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">np_values</span><span class="p">()</span>
        <span class="n">PSF</span> <span class="o">=</span> <span class="n">PSF1D</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">np_values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">guess</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
        <span class="c1"># remove outliers</span>
        <span class="n">indices_no_nan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">indices_no_nan</span><span class="p">])</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">indices_no_nan</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_errors</span><span class="p">[</span><span class="n">indices_no_nan</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="n">sigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># test if 3 consecutive pixels are in the outlier list</span>
            <span class="n">test</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">consecutive_outliers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">outliers</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">-</span> <span class="n">outliers</span><span class="p">[</span><span class="n">o</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">+=</span> <span class="n">t</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">test</span> <span class="o">&gt;=</span> <span class="n">consecutive</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">consecutive</span><span class="p">):</span>
                        <span class="n">consecutive_outliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outliers</span><span class="p">[</span><span class="n">o</span> <span class="o">-</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">consecutive_outliers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">consecutive_outliers</span><span class="p">))</span>
            <span class="c1"># my_logger.debug(f&quot;\n\tConsecutive oultlier indices: {consecutive_outliers}&quot;)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outliers</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># my_logger.debug(f&#39;\n\tPSF best fitting parameters:\n{PSF}&#39;)</span>
    <span class="k">return</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">consecutive_outliers</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s2">&quot;1.14.0&quot;</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">legacy</span><span class="o">=</span><span class="s2">&quot;1.13&quot;</span><span class="p">)</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jeremy Neveu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>