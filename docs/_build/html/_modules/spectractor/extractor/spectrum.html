

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectractor.extractor.spectrum &mdash; Spectractor 1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Spectractor
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/modules.html">spectractor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spectractor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>spectractor.extractor.spectrum</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectractor.extractor.spectrum</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">argrelextrema</span><span class="p">,</span> <span class="n">savgol_filter</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">iminuit</span> <span class="k">import</span> <span class="n">Minuit</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">spectractor</span> <span class="k">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">spectractor.config</span> <span class="k">import</span> <span class="n">set_logger</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.dispersers</span> <span class="k">import</span> <span class="n">Hologram</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.targets</span> <span class="k">import</span> <span class="n">load_target</span>
<span class="kn">from</span> <span class="nn">spectractor.tools</span> <span class="k">import</span> <span class="p">(</span><span class="n">ensure_dir</span><span class="p">,</span> <span class="n">load_fits</span><span class="p">,</span> <span class="n">extract_info_from_CTIO_header</span><span class="p">,</span> <span class="n">plot_image_simple</span><span class="p">,</span>
                               <span class="n">find_nearest</span><span class="p">,</span> <span class="n">plot_spectrum_simple</span><span class="p">,</span> <span class="n">fit_poly1d_legendre</span><span class="p">,</span> <span class="n">gauss</span><span class="p">,</span>
                               <span class="n">rescale_x_for_legendre</span><span class="p">,</span> <span class="n">fit_multigauss_and_bgd</span><span class="p">,</span> <span class="n">multigauss_and_bgd</span><span class="p">,</span>
                               <span class="n">from_lambda_to_colormap</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.psf</span> <span class="k">import</span> <span class="n">ChromaticPSF1D</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.background</span> <span class="k">import</span> <span class="n">extract_background_photutils</span>


<div class="viewcode-block" id="Spectrum"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum">[docs]</a><span class="k">class</span> <span class="nc">Spectrum</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Spectrum class used to store information and methods</span>
<span class="sd">        relative to spectra nd their extraction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            Path to the spectrum file (default: &quot;&quot;).</span>
<span class="sd">        image: Image, optional</span>
<span class="sd">            Image object from which to create the Spectrum object:</span>
<span class="sd">            copy the information from the Image header (default: None).</span>
<span class="sd">        order: int</span>
<span class="sd">            Order of the spectrum (default: 1)</span>
<span class="sd">        target: Target, optional</span>
<span class="sd">            Target object if provided (default: None)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Load a spectrum from a fits file</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(file_name=&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(s.order)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; print(s.target.label)</span>
<span class="sd">        PNG321.0+3.9</span>
<span class="sd">        &gt;&gt;&gt; print(s.disperser_label)</span>
<span class="sd">        HoloPhAg</span>

<span class="sd">        Load a spectrum from a fits image file</span>
<span class="sd">        &gt;&gt;&gt; from spectractor.extractor.images import Image</span>
<span class="sd">        &gt;&gt;&gt; image = Image(&#39;tests/data/reduc_20170605_028.fits&#39;, target=&#39;PNG321.0+3.9&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(image=image)</span>
<span class="sd">        &gt;&gt;&gt; print(s.target.label)</span>
<span class="sd">        PNG321.0+3.9</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;ADU/s&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_GAIN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span> <span class="o">=</span> <span class="n">ChromaticPSF1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_bgd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_residuals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_fit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">file_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_spectrum</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_obs</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">date_obs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">airmass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expo</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">expo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">filters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">filter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disperser_label</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">disperser_label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">disperser</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">lines</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_pixcoords</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">gain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrum info copied from image&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_filter</span><span class="p">()</span>

<div class="viewcode-block" id="Spectrum.convert_from_ADUrate_to_flam"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.convert_from_ADUrate_to_flam">[docs]</a>    <span class="k">def</span> <span class="nf">convert_from_ADUrate_to_flam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert units from ADU/s to erg/s/cm^2/nm.</span>
<span class="sd">        The SED is supposed to be in flam units ie erg/s/cm^2/nm</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(file_name=&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s.convert_from_ADUrate_to_flam()</span>
<span class="sd">        &gt;&gt;&gt; assert np.max(s.data) &lt; 1e-2</span>
<span class="sd">        &gt;&gt;&gt; assert np.max(s.err) &lt; 1e-2</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">parameters</span><span class="o">.</span><span class="n">FLAM_TO_ADURATE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">/</span> <span class="n">parameters</span><span class="o">.</span><span class="n">FLAM_TO_ADURATE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">/=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;erg/s/cm$^2$/nm&#39;</span></div>

<div class="viewcode-block" id="Spectrum.convert_from_flam_to_ADUrate"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.convert_from_flam_to_ADUrate">[docs]</a>    <span class="k">def</span> <span class="nf">convert_from_flam_to_ADUrate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert units from erg/s/cm^2/nm to ADU/s.</span>
<span class="sd">        The SED is supposed to be in flam units ie erg/s/cm^2/nm</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(file_name=&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s.convert_from_flam_to_ADUrate()</span>
<span class="sd">        &gt;&gt;&gt; assert np.max(s.data) &gt; 1e-2</span>
<span class="sd">        &gt;&gt;&gt; assert np.max(s.err) &gt; 1e-2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">FLAM_TO_ADURATE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">FLAM_TO_ADURATE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;ADU/s&#39;</span></div>

<div class="viewcode-block" id="Spectrum.load_filter"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.load_filter">[docs]</a>    <span class="k">def</span> <span class="nf">load_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load filter properties and set relevant LAMBDA_MIN and LAMBDA_MAX values.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum()</span>
<span class="sd">        &gt;&gt;&gt; s.filter = &#39;FGB37&#39;</span>
<span class="sd">        &gt;&gt;&gt; s.load_filter()</span>
<span class="sd">        &gt;&gt;&gt; assert parameters.LAMBDA_MIN == parameters.FGB37[&#39;min&#39;]</span>
<span class="sd">        &gt;&gt;&gt; assert parameters.LAMBDA_MAX == parameters.FGB37[&#39;max&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">FILTERS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">:</span>
                <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
                <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Load filter </span><span class="si">%s</span><span class="s1">: lambda between </span><span class="si">%.1f</span><span class="s1"> and </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span><span class="p">))</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="Spectrum.plot_spectrum"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.plot_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">force_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot spectrum with emission and absorption lines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax: Axes, optional</span>
<span class="sd">            Axes instance (default: None).</span>
<span class="sd">        label: str</span>
<span class="sd">            Label for the legend (default: &#39;&#39;).</span>
<span class="sd">        xlim: list, optional</span>
<span class="sd">            List of minimum and maximum abscisses (default: None)</span>
<span class="sd">        live_fit: bool, optional</span>
<span class="sd">            If True the spectrum is plotted in live during the fitting procedures</span>
<span class="sd">            (default: False).</span>
<span class="sd">        force_lines: bool</span>
<span class="sd">            Force the over plot of vertical lines for atomic lines if set to True (default: False).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(file_name=&#39;tests/data/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s.plot_spectrum(xlim=[500,900], live_fit=False, force_lines=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Order </span><span class="si">{self.order:d}</span><span class="s1"> spectrum</span><span class="se">\n</span><span class="s1">D=</span><span class="si">{self.disperser.D:.2f}</span><span class="s1">mm&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;, x0=</span><span class="si">{self.x0[0]:.2f}</span><span class="s1">pix&#39;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">label</span>
        <span class="n">plot_spectrum_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data_err</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">spectra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">spectra</span><span class="p">)):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tabulated spectra #</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">plot_detected_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">print_table</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">plot_atomic_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force_lines</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">live_fit</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Spectrum.plot_spectrogram"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.plot_spectrogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;Image units&quot;</span><span class="p">,</span> <span class="n">plot_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">target_pixcoords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">9.3</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax: Axes, optional</span>
<span class="sd">            Axes instance (default: None).</span>
<span class="sd">        scale: str</span>
<span class="sd">            Scaling of the image (choose between: lin, log or log10) (default: lin)</span>
<span class="sd">        title: str</span>
<span class="sd">            Title of the image (default: &quot;&quot;)</span>
<span class="sd">        units: str</span>
<span class="sd">            Units of the image to be written in the color bar label (default: &quot;Image units&quot;)</span>
<span class="sd">        cmap: colormap</span>
<span class="sd">            Color map label (default: None)</span>
<span class="sd">        target_pixcoords: array_like, optional</span>
<span class="sd">            2D array  giving the (x,y) coordinates of the targets on the image: add a scatter plot (default: None)</span>
<span class="sd">        vmin: float</span>
<span class="sd">            Minimum value of the image (default: None)</span>
<span class="sd">        vmax: float</span>
<span class="sd">            Maximum value of the image (default: None)</span>
<span class="sd">        aspect: str</span>
<span class="sd">            Aspect keyword to be passed to imshow (default: None)</span>
<span class="sd">        cax: Axes, optional</span>
<span class="sd">            Color bar axes if necessary (default: None).</span>
<span class="sd">        figsize: tuple</span>
<span class="sd">            Figure size (default: [9.3, 8]).</span>
<span class="sd">        plot_stats: bool</span>
<span class="sd">            If True, plot the uncertainty map instead of the spectrogram (default: False).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(file_name=&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s.plot_spectrogram()</span>
<span class="sd">        &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_stats</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_err</span><span class="p">)</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span>
                          <span class="n">target_pixcoords</span><span class="o">=</span><span class="n">target_pixcoords</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Spectrum.save_spectrum"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.save_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">save_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the spectrum into a fits file (data, error and wavelengths).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_file_name: str</span>
<span class="sd">            Path of the output fits file.</span>
<span class="sd">        overwrite: bool</span>
<span class="sd">            If True overwrite the output file if needed (default: False).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum(file_name=&#39;tests/data/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s.save_spectrum(&#39;./tests/test.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert os.path.isfile(&#39;./tests/test.fits&#39;)</span>

<span class="sd">        Overwrite previous file:</span>
<span class="sd">        &gt;&gt;&gt; s.save_spectrum(&#39;./tests/test.fits&#39;, overwrite=True)</span>
<span class="sd">        &gt;&gt;&gt; assert os.path.isfile(&#39;./tests/test.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; os.remove(&#39;./tests/test.fits&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UNIT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nanometer&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UNIT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;First column gives the wavelength in unit UNIT1, &#39;</span> \
                                  <span class="s1">&#39;second column gives the spectrum in unit UNIT2, &#39;</span> \
                                  <span class="s1">&#39;third column the corresponding errors.&#39;</span>
        <span class="n">hdu1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
        <span class="n">hdu2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">()</span>
        <span class="n">hdu3</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">()</span>
        <span class="n">hdu1</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="n">hdu1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">]</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_fit</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_residuals</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu1</span><span class="p">,</span> <span class="n">hdu2</span><span class="p">,</span> <span class="n">hdu3</span><span class="p">])</span>
        <span class="n">output_directory</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ensure_dir</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="c1"># OLD: save_fits(output_file_name, self.header, [self.lambdas, self.data, self.err], overwrite=overwrite)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrum saved in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">output_file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spectrum.save_spectrogram"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.save_spectrogram">[docs]</a>    <span class="k">def</span> <span class="nf">save_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the spectrogram into a fits file (data, error and background).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_file_name: str</span>
<span class="sd">            Path of the output fits file.</span>
<span class="sd">        overwrite: bool,  optional</span>
<span class="sd">            If True overwrite the output file if needed (default: False).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UNIT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;First HDU gives the data in UNIT1 units, &#39;</span> \
                                  <span class="s1">&#39;second HDU gives the uncertainties, &#39;</span> \
                                  <span class="s1">&#39;third HDU the  fitted background.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_X0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_Y0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_y0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_XMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_xmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_XMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_xmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_YMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_YMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_DEG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_SAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_saturation</span>
        <span class="n">hdu1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
        <span class="n">hdu2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">()</span>
        <span class="n">hdu3</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">()</span>
        <span class="n">hdu1</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="n">hdu1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span>
        <span class="n">hdu2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_err</span>
        <span class="n">hdu3</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_bgd</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu1</span><span class="p">,</span> <span class="n">hdu2</span><span class="p">,</span> <span class="n">hdu3</span><span class="p">])</span>
        <span class="n">output_directory</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ensure_dir</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrogram saved in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">output_file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spectrum.load_spectrum"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.load_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">load_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the spectrum from a fits file (data, error and wavelengths).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_file_name: str</span>
<span class="sd">            Path to the input fits file</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum()</span>
<span class="sd">        &gt;&gt;&gt; s.load_spectrum(&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(s.units)</span>
<span class="sd">        erg/s/cm$^2$/nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">extract_info_from_CTIO_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGET&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">load_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGET&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">lines</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UNIT2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UNIT2&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGETX&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGETY&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGETX&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGETY&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Loading disperser </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">disperser_label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">Hologram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER2&#39;</span><span class="p">],</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">HOLO_DIR</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrum loaded from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">input_file_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_spectrogram</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrogram&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_chromatic_psf</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;spectrum.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;table.csv&#39;</span><span class="p">))</span>
            <span class="n">hdu_list</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_fit</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_residuals</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrum file </span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="n">input_file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spectrum.load_spectrogram"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.load_spectrogram">[docs]</a>    <span class="k">def</span> <span class="nf">load_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the spectrum from a fits file (data, error and wavelengths).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_file_name: str</span>
<span class="sd">            Path to the input fits file</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum()</span>
<span class="sd">        &gt;&gt;&gt; s.load_spectrum(&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">):</span>
            <span class="n">hdu_list</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_err</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_bgd</span> <span class="o">=</span> <span class="n">hdu_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_x0</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_X0&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_y0</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_Y0&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_xmin</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_XMIN&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_xmax</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_XMAX&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymin</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_YMIN&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymax</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_YMAX&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_deg</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_DEG&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_saturation</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;S_SAT&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_xmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_xmin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_ymin</span>
            <span class="n">hdu_list</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># need to free allocation for file descripto</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrogram loaded from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">input_file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrogram file </span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="n">input_file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spectrum.load_chromatic_psf"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.Spectrum.load_chromatic_psf">[docs]</a>    <span class="k">def</span> <span class="nf">load_chromatic_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the spectrum from a fits file (data, error and wavelengths).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_file_name: str</span>
<span class="sd">            Path to the input fits file</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; s = Spectrum()</span>
<span class="sd">        &gt;&gt;&gt; s.load_spectrum(&#39;outputs/reduc_20170530_134_spectrum.fits&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chromatic_psf</span> <span class="o">=</span> <span class="n">ChromaticPSF1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_Ny</span><span class="p">,</span>
                                                <span class="n">deg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_deg</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrogram_saturation</span><span class="p">,</span>
                                                <span class="n">file_name</span><span class="o">=</span><span class="n">input_file_name</span><span class="p">)</span>
            <span class="c1"># self.chromatic_psf.table = Table.read(input_file_name)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrogram loaded from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">input_file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Spectrogram file </span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="n">input_file_name</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="calibrate_spectrum"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.calibrate_spectrum">[docs]</a><span class="k">def</span> <span class="nf">calibrate_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert pixels into wavelengths given the position of the order 0,</span>
<span class="sd">    the data for the spectrum, and the properties of the disperser. Convert the</span>
<span class="sd">    spectrum amplitude from ADU rate to flams. Truncate the outputs to the wavelenghts</span>
<span class="sd">    between parameters.LAMBDA_MIN and parameters.LAMBDA_MAX.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum: Spectrum</span>
<span class="sd">        Spectrum object to calibrate</span>
<span class="sd">    xlim: list, optional</span>
<span class="sd">        List of minimum and maximum abscisses</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left_cut</span><span class="p">,</span> <span class="n">right_cut</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">left_cut</span><span class="p">,</span> <span class="n">right_cut</span> <span class="o">=</span> <span class="n">xlim</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">left_cut</span><span class="p">:</span><span class="n">right_cut</span><span class="p">]</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">pixels</span><span class="p">[</span><span class="n">left_cut</span><span class="p">:</span><span class="n">right_cut</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">,</span>
                                                                  <span class="n">order</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span><span class="p">)</span>
    <span class="c1"># Cut spectra</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_indices</span> <span class="o">=</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">&gt;</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_indices</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_binwidths</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_binwidths</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_indices</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_indices</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas_indices</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">convert_from_ADUrate_to_flam</span><span class="p">()</span></div>


<div class="viewcode-block" id="detect_lines"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.detect_lines">[docs]</a><span class="k">def</span> <span class="nf">detect_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fwhm_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snr_minlevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Detect and fit the lines in a spectrum. The method is to look at maxima or minima</span>
<span class="sd">    around emission or absorption tabulated lines, and to select surrounding pixels</span>
<span class="sd">    to fit a (positive or negative) gaussian and a polynomial background. If several regions</span>
<span class="sd">    overlap, a multi-gaussian fit is performed above a common polynomial background.</span>
<span class="sd">    The mean global shift (in nm) between the detected and tabulated lines is returned, considering</span>
<span class="sd">    only the lines with a signal-to-noise ratio above a threshold.</span>
<span class="sd">    The order of the polynomial background is set in parameters.py with CALIB_BGD_ORDER.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lines: Lines</span>
<span class="sd">        The Lines object containing the line characteristics</span>
<span class="sd">    lambdas: float array</span>
<span class="sd">        The wavelength array (in nm)</span>
<span class="sd">    spec: float array</span>
<span class="sd">        The spectrum amplitude array</span>
<span class="sd">    spec_err: float array, optional</span>
<span class="sd">        The spectrum amplitude uncertainty array (default: None)</span>
<span class="sd">    fwhm_func: callable, optional</span>
<span class="sd">        The fwhm of the cross spectrum to reset CALIB_PEAK_WIDTH parameter as a function of lambda (default: None)</span>
<span class="sd">    snr_minlevel: float</span>
<span class="sd">        The minimum signal over noise ratio to consider using a fitted line in the computation of the mean</span>
<span class="sd">        shift output and to print it in the outpur table (default: 3)</span>
<span class="sd">    ax: Axes, optional</span>
<span class="sd">        An Axes instance to over plot the result of the fit (default: None).</span>
<span class="sd">    xlim: array, optional</span>
<span class="sd">        (min, max) list limiting the wavelength interval where to detect spectral lines (default:</span>
<span class="sd">        (parameters.LAMBDA_MIN, parameters.LAMBDA_MAX))</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    shift: float</span>
<span class="sd">        The mean shift (in nm) between the detected and tabulated lines</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Creation of a mock spectrum with emission and absorption lines</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from spectractor.extractor.spectroscopy import Lines, HALPHA, HBETA, O2</span>
<span class="sd">    &gt;&gt;&gt; lambdas = np.arange(300,1000,1)</span>
<span class="sd">    &gt;&gt;&gt; spectrum = 1e4*np.exp(-((lambdas-600)/200)**2)</span>
<span class="sd">    &gt;&gt;&gt; spectrum += HALPHA.gaussian_model(lambdas, A=5000, sigma=3)</span>
<span class="sd">    &gt;&gt;&gt; spectrum += HBETA.gaussian_model(lambdas, A=3000, sigma=2)</span>
<span class="sd">    &gt;&gt;&gt; spectrum += O2.gaussian_model(lambdas, A=-3000, sigma=7)</span>
<span class="sd">    &gt;&gt;&gt; spectrum_err = np.sqrt(spectrum)</span>
<span class="sd">    &gt;&gt;&gt; spectrum = np.random.poisson(spectrum)</span>
<span class="sd">    &gt;&gt;&gt; spec = Spectrum()</span>
<span class="sd">    &gt;&gt;&gt; spec.lambdas = lambdas</span>
<span class="sd">    &gt;&gt;&gt; spec.data = spectrum</span>
<span class="sd">    &gt;&gt;&gt; spec.err = spectrum_err</span>
<span class="sd">    &gt;&gt;&gt; fwhm_func = interp1d(lambdas, 0.01 * lambdas)</span>

<span class="sd">    Detect the lines</span>
<span class="sd">    &gt;&gt;&gt; lines = Lines([HALPHA, HBETA, O2], hydrogen_only=True,</span>
<span class="sd">    ... atmospheric_lines=True, redshift=0, emission_spectrum=True)</span>
<span class="sd">    &gt;&gt;&gt; global_chisq = detect_lines(lines, lambdas, spectrum, spectrum_err, fwhm_func=fwhm_func)</span>
<span class="sd">    &gt;&gt;&gt; assert(global_chisq &lt; 2)</span>

<span class="sd">    Plot the result</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; spec.lines = lines</span>
<span class="sd">    &gt;&gt;&gt; fig = plt.figure()</span>
<span class="sd">    &gt;&gt;&gt; plot_spectrum_simple(plt.gca(), lambdas, spec.data, data_err=spec.err)</span>
<span class="sd">    &gt;&gt;&gt; lines.plot_detected_lines(plt.gca())</span>
<span class="sd">    &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># main settings</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">bgd_npar</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_BGD_NPARAMS</span>
    <span class="n">peak_width</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_PEAK_WIDTH</span>
    <span class="n">bgd_width</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_BGD_WIDTH</span>
    <span class="k">if</span> <span class="n">lines</span><span class="o">.</span><span class="n">hydrogen_only</span><span class="p">:</span>
        <span class="n">peak_width</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">bgd_width</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">fwhm_to_peak_width_factor</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">len_index_to_bgd_npar_factor</span> <span class="o">=</span> <span class="mf">0.12</span>
    <span class="n">baseline_prior</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># *sigma gaussian prior on base line fit</span>
    <span class="c1"># filter the noise</span>
    <span class="c1"># plt.errorbar(lambdas,spec,yerr=spec_err)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># plt.plot(lambdas,spec)</span>
    <span class="c1"># plt.show()</span>
    <span class="c1"># initialisation</span>
    <span class="n">lambda_shifts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">snrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bgd_npar_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">peak_index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">guess_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bounds_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
        <span class="c1"># reset line fit attributes</span>
        <span class="n">line</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">line</span><span class="o">.</span><span class="n">fit_popt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">line</span><span class="o">.</span><span class="n">high_snr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># wavelength of the line: find the nearest pixel index</span>
        <span class="n">line_wavelength</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">wavelength</span>
        <span class="k">if</span> <span class="n">fwhm_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peak_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fwhm_to_peak_width_factor</span> <span class="o">*</span> <span class="n">fwhm_func</span><span class="p">(</span><span class="n">line_wavelength</span><span class="p">),</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_PEAK_WIDTH</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line_wavelength</span> <span class="o">&lt;</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">line_wavelength</span> <span class="o">&gt;</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">l_index</span><span class="p">,</span> <span class="n">l_lambdas</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">line_wavelength</span><span class="p">)</span>
        <span class="c1"># reject if pixel index is too close to image bounds</span>
        <span class="k">if</span> <span class="n">l_index</span> <span class="o">&lt;</span> <span class="n">peak_width</span> <span class="ow">or</span> <span class="n">l_index</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambdas</span><span class="p">)</span> <span class="o">-</span> <span class="n">peak_width</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># search for local extrema to detect emission or absorption line</span>
        <span class="c1"># around pixel index +/- peak_width</span>
        <span class="n">line_strategy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span>  <span class="c1"># look for emission line</span>
        <span class="n">bgd_strategy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="o">.</span><span class="n">emission_spectrum</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">atmospheric</span><span class="p">:</span>
            <span class="n">line_strategy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span>  <span class="c1"># look for absorption line</span>
            <span class="n">bgd_strategy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l_index</span> <span class="o">-</span> <span class="n">peak_width</span><span class="p">,</span> <span class="n">l_index</span> <span class="o">+</span> <span class="n">peak_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># skip if data is masked with NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">])):</span>
            <span class="k">continue</span>
        <span class="n">extrema</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">line_strategy</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">peak_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">extrema</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># if several extrema, look for the greatest</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line_strategy</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e20</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">extrema</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span>
                    <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">test</span><span class="p">:</span>
                        <span class="n">peak_index</span> <span class="o">=</span> <span class="n">idx</span>
                        <span class="n">test</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">line_strategy</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="mf">1e20</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">extrema</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span>
                    <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">test</span><span class="p">:</span>
                        <span class="n">peak_index</span> <span class="o">=</span> <span class="n">idx</span>
                        <span class="n">test</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># search for first local minima around the local maximum</span>
        <span class="c1"># or for first local maxima around the local minimum</span>
        <span class="c1"># around +/- 3*peak_width</span>
        <span class="n">index_inf</span> <span class="o">=</span> <span class="n">peak_index</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># extrema on the left</span>
        <span class="k">while</span> <span class="n">index_inf</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peak_index</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">peak_width</span><span class="p">):</span>
            <span class="n">test_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">index_inf</span><span class="p">,</span> <span class="n">peak_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">minm</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">test_index</span><span class="p">],</span> <span class="n">bgd_strategy</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">minm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index_inf</span> <span class="o">=</span> <span class="n">index_inf</span> <span class="o">+</span> <span class="n">minm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_inf</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">index_sup</span> <span class="o">=</span> <span class="n">peak_index</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># extrema on the right</span>
        <span class="k">while</span> <span class="n">index_sup</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">peak_index</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">peak_width</span><span class="p">):</span>
            <span class="n">test_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">peak_index</span><span class="p">,</span> <span class="n">index_sup</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">minm</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">test_index</span><span class="p">],</span> <span class="n">bgd_strategy</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">minm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index_sup</span> <span class="o">=</span> <span class="n">peak_index</span> <span class="o">+</span> <span class="n">minm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_sup</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">index_sup</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_sup</span><span class="p">,</span> <span class="n">peak_index</span> <span class="o">+</span> <span class="n">peak_width</span><span class="p">)</span>
        <span class="n">index_inf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">index_inf</span><span class="p">,</span> <span class="n">peak_index</span> <span class="o">-</span> <span class="n">peak_width</span><span class="p">)</span>
        <span class="c1"># pixel range to consider around the peak, adding bgd_width pixels</span>
        <span class="c1"># to fit for background around the peak</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_inf</span> <span class="o">-</span> <span class="n">bgd_width</span><span class="p">),</span>
                               <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lambdas</span><span class="p">),</span> <span class="n">index_sup</span> <span class="o">+</span> <span class="n">bgd_width</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="c1"># skip if data is masked with NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">])):</span>
            <span class="k">continue</span>
        <span class="c1"># first guess and bounds to fit the line properties and</span>
        <span class="c1"># the background with CALIB_BGD_ORDER order polynom</span>
        <span class="c1"># guess = [0] * bgd_npar + [0.5 * np.max(spec[index]), lambdas[peak_index],</span>
        <span class="c1">#                          0.5 * (line.width_bounds[0] + line.width_bounds[1])]</span>
        <span class="n">bgd_npar</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_BGD_NPARAMS</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">len_index_to_bgd_npar_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">bgd_npar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bgd_npar</span><span class="p">)</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">bgd_npar</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">line_wavelength</span><span class="p">,</span>
                                  <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">width_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">width_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">if</span> <span class="n">line_strategy</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">:</span>
            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="n">guess</span><span class="p">[</span><span class="n">bgd_npar</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>  <span class="c1"># look for abosrption under bgd</span>
        <span class="c1"># bounds = [[-np.inf] * bgd_npar + [-abs(np.max(spec[index])), lambdas[index_inf], line.width_bounds[0]],</span>
        <span class="c1">#          [np.inf] * bgd_npar + [abs(np.max(spec[index])), lambdas[index_sup], line.width_bounds[1]]]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="n">bgd_npar</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">])),</span> <span class="n">line_wavelength</span> <span class="o">-</span> <span class="n">peak_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                          <span class="n">line</span><span class="o">.</span><span class="n">width_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="n">bgd_npar</span> <span class="o">+</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">])),</span> <span class="n">line_wavelength</span> <span class="o">+</span> <span class="n">peak_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                         <span class="n">line</span><span class="o">.</span><span class="n">width_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
        <span class="c1"># gaussian amplitude bounds depend if line is emission/absorption</span>
        <span class="k">if</span> <span class="n">line_strategy</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">:</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">bgd_npar</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># look for absorption under bgd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">bgd_npar</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># look for emission above bgd</span>
        <span class="n">peak_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_index</span><span class="p">)</span>
        <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">lines_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">guess_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
        <span class="n">bounds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
    <span class="c1"># now gather lines together if pixel index ranges overlap</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">merges</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">merges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">index_list</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">index_list</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">merges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># reorder merge list with respect to lambdas in guess list</span>
    <span class="n">new_merges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">merge</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tmp_guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">guess_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merge</span><span class="p">]</span>
        <span class="n">new_merges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tmp_guess</span><span class="p">,</span> <span class="n">merge</span><span class="p">))])</span>
    <span class="c1"># reorder lists with merges</span>
    <span class="n">new_peak_index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_index_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_guess_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_bounds_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_lines_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">merge</span> <span class="ow">in</span> <span class="n">new_merges</span><span class="p">:</span>
        <span class="n">new_peak_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">new_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">new_guess_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">new_bounds_list</span><span class="o">.</span><span class="n">append</span><span class="p">([[],</span> <span class="p">[]])</span>
        <span class="n">new_lines_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">merge</span><span class="p">:</span>
            <span class="c1"># add the bgd parameters</span>
            <span class="n">bgd_npar</span> <span class="o">=</span> <span class="n">bgd_npar_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># if i == merge[0]:</span>
            <span class="c1">#     new_guess_list[-1] += guess_list[i][:bgd_npar]</span>
            <span class="c1">#     new_bounds_list[-1][0] += bounds_list[i][0][:bgd_npar]</span>
            <span class="c1">#     new_bounds_list[-1][1] += bounds_list[i][1][:bgd_npar]</span>
            <span class="c1"># add the gauss parameters</span>
            <span class="n">new_peak_index_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_index_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_index_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">new_guess_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">guess_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bgd_npar</span><span class="p">:]</span>
            <span class="n">new_bounds_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">bounds_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">bgd_npar</span><span class="p">:]</span>
            <span class="n">new_bounds_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">bounds_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">bgd_npar</span><span class="p">:]</span>
            <span class="n">new_lines_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># set central peak bounds exactly between two close lines</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merge</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">new_bounds_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">new_guess_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_guess_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">new_bounds_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">new_guess_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_guess_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1e-3</span>
            <span class="c1"># last term is to avoid equalities</span>
            <span class="c1"># between bounds in some pathological case</span>
        <span class="c1"># sort pixel indices and remove doublons</span>
        <span class="n">new_index_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_index_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
    <span class="c1"># fit the line subsets and background</span>
    <span class="n">global_chisq</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_index_list</span><span class="p">)):</span>
        <span class="c1"># first guess for the base line with the lateral bands</span>
        <span class="n">peak_index</span> <span class="o">=</span> <span class="n">new_peak_index_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">new_index_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">new_guess_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">new_bounds_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">bgd_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">fwhm_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peak_width</span> <span class="o">=</span> <span class="n">fwhm_to_peak_width_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fwhm_func</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">is_close_to_peak</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">peak_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">peak_width</span><span class="p">:</span>
                    <span class="n">is_close_to_peak</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_close_to_peak</span><span class="p">:</span>
                <span class="n">bgd_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># add background guess and bounds</span>
        <span class="n">bgd_npar</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_BGD_ORDER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">len_index_to_bgd_npar_factor</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bgd_index</span><span class="p">)))</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_BGD_NPARAMS</span> <span class="o">=</span> <span class="n">bgd_npar</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">bgd_npar</span> <span class="o">+</span> <span class="n">guess</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="n">bgd_npar</span> <span class="o">+</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="n">bgd_npar</span> <span class="o">+</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bgd_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">fit_poly1d_legendre</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">],</span>
                                                      <span class="n">order</span><span class="o">=</span><span class="n">bgd_npar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">spec_err</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">fit_poly1d_legendre</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                                                      <span class="n">order</span><span class="o">=</span><span class="n">bgd_npar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">spec_err</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">fit_poly1d_legendre</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                                                  <span class="n">order</span><span class="o">=</span><span class="n">bgd_npar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">spec_err</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="c1"># lines.my_logger.warning(f&#39;{bgd_npar} {fit}&#39;)</span>
        <span class="c1"># fig = plt.figure()</span>
        <span class="c1"># plt.plot(lambdas[index], spec[index])</span>
        <span class="c1"># plt.plot(lambdas[bgd_index], spec[bgd_index], &#39;ro&#39;)</span>
        <span class="c1"># x_norm = rescale_x_for_legendre(lambdas[index])</span>
        <span class="c1"># lines.my_logger.warning(f&#39;tototot {x_norm}&#39;)</span>
        <span class="c1"># plt.plot(lambdas[index], np.polynomial.legendre.legval(x_norm, fit), &#39;b-&#39;)</span>
        <span class="c1"># plt.plot(lambdas[bgd_index], model, &#39;b--&#39;)</span>
        <span class="c1"># plt.title(f&quot;{fit}&quot;)</span>
        <span class="c1"># plt.show()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bgd_npar</span><span class="p">):</span>
            <span class="c1"># guess[n] = getattr(bgd, bgd.param_names[parameters.CALIB_BGD_ORDER - n]).value</span>
            <span class="n">guess</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">baseline_prior</span> <span class="o">*</span> <span class="n">guess</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-2</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">]))):</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">baseline_prior</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-2</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">bgd_index</span><span class="p">]))):</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_lines_list</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">new_peak_index_list</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="n">x_norm</span> <span class="o">=</span> <span class="n">rescale_x_for_legendre</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">guess</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">guess</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">guess</span><span class="p">[:</span><span class="n">bgd_npar</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">guess</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># absorption</span>
                <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">guess</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># emission</span>
                <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">guess</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span>
        <span class="c1"># fit local extrema with a multigaussian + CALIB_BGD_ORDER polynom</span>
        <span class="c1"># account for the spectrum uncertainties if provided</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">spec_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">spec_err</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># my_logger.warning(f&#39;\n{guess} {np.mean(spec[bgd_index])} {np.std(spec[bgd_index])}&#39;)</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">fit_multigauss_and_bgd</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                                            <span class="n">fix_centroids</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># noise level defined as the std of the residuals if no error</span>
        <span class="n">noise_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">multigauss_and_bgd</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">*</span><span class="n">popt</span><span class="p">))</span>
        <span class="c1"># otherwise mean of error bars of bgd lateral bands</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">multigauss_and_bgd</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span> <span class="o">-</span> <span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">multigauss_and_bgd</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span> <span class="o">-</span> <span class="n">spec</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">chisq</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">global_chisq</span> <span class="o">+=</span> <span class="n">chisq</span>
        <span class="k">if</span> <span class="n">spec_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec_err</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_lines_list</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">new_lines_list</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="n">peak_pos</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># FWHM</span>
            <span class="n">FWHM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">2.355</span>
            <span class="c1"># SNR computation</span>
            <span class="c1"># signal_level = popt[bgd_npar+3*j]</span>
            <span class="n">signal_level</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span>
                <span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># multigauss_and_bgd(peak_pos, *popt) - np.polyval(popt[:bgd_npar], peak_pos)</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signal_level</span> <span class="o">/</span> <span class="n">noise_level</span><span class="p">)</span>
            <span class="c1"># save fit results</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_lambdas</span> <span class="o">=</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_popt</span> <span class="o">=</span> <span class="n">popt</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">*</span><span class="n">popt</span><span class="p">[</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">:</span><span class="n">bgd_npar</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>
            <span class="n">x_norm</span> <span class="o">=</span> <span class="n">rescale_x_for_legendre</span><span class="p">(</span><span class="n">lambdas</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_bgd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">popt</span><span class="p">[:</span><span class="n">bgd_npar</span><span class="p">])</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_snr</span> <span class="o">=</span> <span class="n">snr</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_chisq</span> <span class="o">=</span> <span class="n">chisq</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_fwhm</span> <span class="o">=</span> <span class="n">FWHM</span>
            <span class="n">line</span><span class="o">.</span><span class="n">fit_bgd_npar</span> <span class="o">=</span> <span class="n">bgd_npar</span>
            <span class="k">if</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="n">snr_minlevel</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">line</span><span class="o">.</span><span class="n">high_snr</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">use_for_calibration</span><span class="p">:</span>
                <span class="c1"># wavelength shift between tabulate and observed lines</span>
                <span class="n">lambda_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_pos</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
                <span class="n">snrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">plot_detected_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">print_table</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_shifts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">global_chisq</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_shifts</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambda_shifts</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snrs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># if guess values on tabulated lines have not moved: penalize the chisq</span>
        <span class="n">global_chisq</span> <span class="o">+=</span> <span class="n">shift</span>
        <span class="c1"># lines.my_logger.debug(f&#39;\n\tNumber of calibration lines detected {len(lambda_shifts):d}&#39;</span>
        <span class="c1">#                      f&#39;\n\tTotal chisq: {global_chisq:.3f} with shift {shift:.3f}pix&#39;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">global_chisq</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDAS</span><span class="p">)</span>
        <span class="c1"># lines.my_logger.debug(</span>
        <span class="c1">#    f&#39;\n\tNumber of calibration lines detected {len(lambda_shifts):d}\n\tTotal chisq: {global_chisq:.3f}&#39;)</span>
    <span class="k">return</span> <span class="n">global_chisq</span></div>


<span class="c1"># noinspection PyArgumentList</span>
<div class="viewcode-block" id="calibrate_spectrum_with_lines"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.calibrate_spectrum_with_lines">[docs]</a><span class="k">def</span> <span class="nf">calibrate_spectrum_with_lines</span><span class="p">(</span><span class="n">spectrum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert pixels into wavelengths given the position of the order 0,</span>
<span class="sd">    the data for the spectrum, the properties of the disperser. Fit the absorption</span>
<span class="sd">    (and eventually the emission) lines to perform a second calibration of the</span>
<span class="sd">    distance between the CCD and the disperser. The number of fitting steps is</span>
<span class="sd">    limited to 30.</span>

<span class="sd">    Prerequisites: a first calibration from pixels to wavelengths must have been performed before</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum: Spectrum</span>
<span class="sd">        Spectrum object to calibrate</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lambdas: array_like</span>
<span class="sd">        The new wavelength array in nm.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; spectrum = Spectrum(&#39;tests/data/reduc_20170605_028_spectrum.fits&#39;)</span>
<span class="sd">    &gt;&gt;&gt; parameters.LAMBDA_MIN = 550</span>
<span class="sd">    &gt;&gt;&gt; parameters.LAMBDA_MAX = 800</span>
<span class="sd">    &gt;&gt;&gt; lambdas = calibrate_spectrum_with_lines(spectrum)</span>
<span class="sd">    &gt;&gt;&gt; spectrum.plot_spectrum()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># Convert wavelength array into original pixels</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">x0</span>
    <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">target_pixcoords</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="c1"># MFL notes: the logic with D seems confused here</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span>
    <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
    <span class="n">delta_pixels</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_lambda_to_pixel</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

    <span class="c1"># Detect emission/absorption lines and calibrate pixel/lambda</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span>  <span class="c1"># - parameters.DISTANCE2CCD_ERR</span>
    <span class="n">D_err</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD_ERR</span>
    <span class="n">fwhm_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;lambdas&#39;</span><span class="p">],</span>
                         <span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">],</span>
                         <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_PEAK_WIDTH</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALIB_PEAK_WIDTH</span><span class="p">),</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shift_minimizer</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">lambdas_test</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">delta_pixels</span> <span class="o">-</span> <span class="n">shift</span><span class="p">,</span>
                                                                  <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">order</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="n">detect_lines</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="n">lambdas_test</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">spec_err</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">err</span><span class="p">,</span>
                             <span class="n">fwhm_func</span><span class="o">=</span><span class="n">fwhm_func</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">chisq</span> <span class="o">+=</span> <span class="p">(</span><span class="n">shift</span> <span class="o">*</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">PIXSHIFT_PRIOR</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LIVE_FIT</span><span class="p">:</span>
                <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas_test</span>
                <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">(</span><span class="n">live_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;Order </span><span class="si">{spectrum.order:d}</span><span class="s1"> spectrum&#39;</span>
                                                        <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">D=</span><span class="si">{D:.2f}</span><span class="s1">mm, shift=</span><span class="si">{shift:.2f}</span><span class="s1">pix&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chisq</span>

    <span class="c1"># grid exploration of the parameters</span>
    <span class="c1"># necessary because of the the line detection algo</span>
    <span class="n">D_step</span> <span class="o">=</span> <span class="n">D_err</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">pixel_shift_step</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">pixel_shift_prior</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">PIXSHIFT_PRIOR</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">D_err</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">D_err</span><span class="p">,</span> <span class="n">D_step</span><span class="p">)</span>
    <span class="n">pixel_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">pixel_shift_prior</span><span class="p">,</span> <span class="n">pixel_shift_prior</span> <span class="o">+</span> <span class="n">pixel_shift_step</span><span class="p">,</span> <span class="n">pixel_shift_step</span><span class="p">)</span>
    <span class="c1"># pixel_shifts = np.array([0])</span>
    <span class="n">chisq_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Ds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pixel_shifts</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">D</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Ds</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pixel_shift</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pixel_shifts</span><span class="p">):</span>
            <span class="n">chisq_grid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_minimizer</span><span class="p">([</span><span class="n">D</span><span class="p">,</span> <span class="n">pixel_shift</span><span class="p">])</span>
    <span class="n">imin</span><span class="p">,</span> <span class="n">jmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">chisq_grid</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">chisq_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>
    <span class="n">pixel_shift</span> <span class="o">=</span> <span class="n">pixel_shifts</span><span class="p">[</span><span class="n">jmin</span><span class="p">]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">D</span><span class="p">,</span> <span class="n">pixel_shift</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">imin</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">imin</span> <span class="o">==</span> <span class="n">Ds</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="n">jmin</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">jmin</span> <span class="o">==</span> <span class="n">pixel_shifts</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Minimum chisq is on the edge of the exploration grid.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">chisq_grid</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                        <span class="n">extent</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pixel_shifts</span><span class="p">)</span> <span class="o">-</span> <span class="n">pixel_shift_step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pixel_shifts</span><span class="p">)</span> <span class="o">+</span> <span class="n">pixel_shift_step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">D_step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Ds</span><span class="p">)</span> <span class="o">+</span> <span class="n">D_step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pixel_shift</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minimum&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Log10(chisq)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel shift [pix]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;D [mm]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="c1"># now minimize around the global minimum found previously</span>
    <span class="c1"># res = opt.minimize(shift_minimizer, start, args=(), method=&#39;L-BFGS-B&#39;,</span>
    <span class="c1">#                    options={&#39;maxiter&#39;: 200, &#39;ftol&#39;: 1e-3},</span>
    <span class="c1">#                    bounds=((D - 5 * parameters.DISTANCE2CCD_ERR, D + 5 * parameters.DISTANCE2CCD_ERR), (-2, 2)))</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD_ERR</span><span class="p">,</span> <span class="n">pixel_shift_step</span><span class="p">]</span>
    <span class="n">fix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Minuit</span><span class="o">.</span><span class="n">from_array_func</span><span class="p">(</span><span class="n">fcn</span><span class="o">=</span><span class="n">shift_minimizer</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">errordef</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="n">fix</span><span class="p">,</span> <span class="n">print_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">limit</span><span class="o">=</span><span class="p">((</span><span class="n">D</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD_ERR</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD_ERR</span><span class="p">),</span>
                                      <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">migrad</span><span class="p">()</span>
    <span class="c1"># if parameters.DEBUG:</span>
    <span class="c1">#     print(m.prin)</span>
    <span class="c1"># if not res.success:</span>
    <span class="c1">#     spectrum.my_logger.warning(&#39;\n\tMinimizer failed.&#39;)</span>
    <span class="c1">#     print(res)</span>
    <span class="n">D</span><span class="p">,</span> <span class="n">pixel_shift</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">np_values</span><span class="p">()</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pixel_shift</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="c1"># check success, xO ou D sur les bords du prior</span>
    <span class="n">lambdas</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">delta_pixels</span> <span class="o">-</span> <span class="n">pixel_shift</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdas</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="n">delta_pixels</span> <span class="o">-</span> <span class="n">pixel_shift</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Order0 total shift: </span><span class="si">{:.2f}</span><span class="s1">pix&#39;</span>
        <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">D = </span><span class="si">{:.2f}</span><span class="s1"> mm (default: DISTANCE2CCD = </span><span class="si">{:.2f}</span><span class="s1"> +/- </span><span class="si">{:.2f}</span><span class="s1"> mm, </span><span class="si">{:.1f}</span><span class="s1"> sigma shift)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pixel_shift</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD_ERR</span><span class="p">,</span>
            <span class="p">(</span><span class="n">D</span> <span class="o">-</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">)</span> <span class="o">/</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD_ERR</span><span class="p">))</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_shift</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
    <span class="k">return</span> <span class="n">lambdas</span></div>


<div class="viewcode-block" id="extract_spectrum_from_image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.spectrum.extract_spectrum_from_image">[docs]</a><span class="k">def</span> <span class="nf">extract_spectrum_from_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">right_edge</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span> <span class="o">-</span> <span class="mi">200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract the 1D spectrum from the image.</span>

<span class="sd">    Method : remove a uniform background estimated from the rectangular lateral bands</span>

<span class="sd">    The spectrum amplitude is the sum of the pixels in the 2*w rectangular window</span>
<span class="sd">    centered on the order 0 y position.</span>
<span class="sd">    The up and down backgrounds are estimated as the median in rectangular regions</span>
<span class="sd">    above and below the spectrum, in the ws-defined rectangular regions; stars are filtered</span>
<span class="sd">    as nan values using an hessian analysis of the image to remove structures.</span>
<span class="sd">    The subtracted background is the mean of the two up and down backgrounds.</span>
<span class="sd">    Stars are filtered.</span>

<span class="sd">    Prerequisites: the target position must have been found before, and the</span>
<span class="sd">        image turned to have an horizontal dispersion line</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        Image object from which to extract the spectrum</span>
<span class="sd">    spectrum: Spectrum</span>
<span class="sd">        Spectrum object to store new wavelengths, data and error arrays</span>
<span class="sd">    w: int</span>
<span class="sd">        Half width of central region where the spectrum is extracted and summed (default: 10)</span>
<span class="sd">    ws: list</span>
<span class="sd">        up/down region extension where the sky background is estimated with format [int, int] (default: [20,30])</span>
<span class="sd">    right_edge: int</span>
<span class="sd">        Right-hand pixel position above which no pixel should be used (default: 1800)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Extracting spectrum from image: spectrum with width 2*</span><span class="si">{w:d}</span><span class="s1"> pixels &#39;</span>
        <span class="n">f</span><span class="s1">&#39;and background from </span><span class="si">{ws[0]:d}</span><span class="s1"> to </span><span class="si">{ws[1]:d}</span><span class="s1"> pixels&#39;</span><span class="p">)</span>

    <span class="c1"># Make a data copy</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data_rotated</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">right_edge</span><span class="p">]</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">stat_errors_rotated</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">right_edge</span><span class="p">]</span>

    <span class="c1"># Lateral bands to remove sky background</span>
    <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Ny</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">ws</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">ws</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Roughly estimates the wavelengths and set start 0 nm before parameters.LAMBDA_MIN</span>
    <span class="c1"># and end 0 nm after parameters.LAMBDA_MAX</span>
    <span class="n">lambdas</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">)</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">x0</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">)</span>
    <span class="n">pixel_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span> <span class="o">-</span> <span class="mi">0</span><span class="p">))))</span>
    <span class="n">pixel_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">right_edge</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)))))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pixel_end</span> <span class="o">-</span> <span class="n">pixel_start</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># spectrogram table must have odd size in x for the fourier simulation</span>
        <span class="n">pixel_end</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># Create spectrogram</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">pixel_start</span><span class="p">:</span><span class="n">pixel_end</span><span class="p">]</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">pixel_start</span><span class="p">:</span><span class="n">pixel_end</span><span class="p">]</span>
    <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Extract spectrogram: crop rotated image [</span><span class="si">{pixel_start}</span><span class="s1">:</span><span class="si">{pixel_end}</span><span class="s1">,</span><span class="si">{ymin}</span><span class="s1">:</span><span class="si">{ymax}</span><span class="s1">] (size (</span><span class="si">{Nx}</span><span class="s1">, </span><span class="si">{Ny}</span><span class="s1">))&#39;</span><span class="p">)</span>

    <span class="c1"># Extract the background on the rotated image</span>
    <span class="n">bgd_model_func</span> <span class="o">=</span> <span class="n">extract_background_photutils</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">)</span>
    <span class="c1"># bgd_model_func = extract_background_poly2D(data, ws=ws)</span>

    <span class="c1"># Fit the transverse profile</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start PSF1D transverse fit...&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">ChromaticPSF1D</span><span class="p">(</span><span class="n">Nx</span><span class="o">=</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="o">=</span><span class="n">Ny</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">PSF_POLY_ORDER</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">fit_transverse_PSF1D_profile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">pixel_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bgd_model_func</span><span class="o">=</span><span class="n">bgd_model_func</span><span class="p">,</span>
                                   <span class="n">saturation</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">,</span> <span class="n">live_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Fill spectrum object</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pixel_start</span><span class="p">,</span> <span class="n">pixel_end</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_sum&#39;</span><span class="p">])</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">])</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Transverse fit table:</span><span class="se">\n</span><span class="si">{s.table}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">plot_summary</span><span class="p">()</span>

    <span class="c1"># Fit the data:</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Start ChromaticPSF1D polynomial fit...&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">fit_chromatic_PSF1D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bgd_model_func</span><span class="o">=</span><span class="n">bgd_model_func</span><span class="p">,</span> <span class="n">data_errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_fit</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">poly_params</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_fit</span> <span class="o">-</span> <span class="n">bgd_model_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">),</span>
                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ny</span><span class="p">)))</span> <span class="o">/</span> <span class="n">err</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_integral&#39;</span><span class="p">])</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx_rot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx_rot&#39;</span><span class="p">])</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_fwhm_inf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_fwhm_sup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;x_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Transverse fit table before derotation:</span><span class="se">\n</span><span class="s2">{s.table[[&#39;Dx_rot&#39;, &#39;Dx&#39;, &#39;x_mean&#39;, &#39;Dy&#39;]]}&quot;</span><span class="p">)</span>

    <span class="c1"># rotate and save the table</span>
    <span class="n">s</span><span class="o">.</span><span class="n">rotate_table</span><span class="p">(</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Transverse fit table after derotation:</span><span class="se">\n</span><span class="s2">{s.table[[&#39;Dx_rot&#39;, &#39;Dx&#39;, &#39;x_mean&#39;, &#39;Dy&#39;]]}&quot;</span><span class="p">)</span>

    <span class="c1"># Extract the spectrogram edges</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">right_edge</span><span class="p">]</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">stat_errors</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">right_edge</span><span class="p">]</span>
    <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Ny</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="n">ws</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># +1 to  include edges</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">-</span> <span class="n">ws</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_distance_along_dispersion_axis</span><span class="p">()</span>
    <span class="n">lambdas</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">)</span>
    <span class="n">lambda_min_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MIN</span> <span class="o">-</span> <span class="mi">0</span><span class="p">))))</span>
    <span class="n">lambda_max_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span> <span class="o">-</span> <span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LAMBDA_MAX</span> <span class="o">+</span> <span class="mi">0</span><span class="p">))))</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">][</span><span class="n">lambda_min_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">right_edge</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx&#39;</span><span class="p">][</span><span class="n">lambda_max_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># +1 to  include edges</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># spectrogram must have odd size in x for the fourier simulation</span>
        <span class="n">xmax</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">remove_row</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Position of the order 0 in the spectrogram coordinates</span>
    <span class="n">target_pixcoords_spectrogram</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">]</span>

    <span class="c1"># Create spectrogram</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
    <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Extract the non rotated background</span>
    <span class="n">bgd_model_func</span> <span class="o">=</span> <span class="n">extract_background_photutils</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">)</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="n">bgd_model_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ny</span><span class="p">))</span>

    <span class="c1"># Crop the background lateral regions</span>
    <span class="c1"># bgd_width = ws[1] - w</span>
    <span class="c1"># yeven = 0</span>
    <span class="c1"># if (Ny - 2 * bgd_width) % 2 == 0:  # spectrogram must have odd size in y for the fourier simulation</span>
    <span class="c1">#     yeven = 1</span>
    <span class="c1"># ymax = ymax - bgd_width + yeven</span>
    <span class="c1"># ymin += bgd_width</span>
    <span class="c1"># bgd = bgd[bgd_width:-bgd_width + yeven, :]</span>
    <span class="c1"># data = data[bgd_width:-bgd_width + yeven, :]</span>
    <span class="c1"># err = err[bgd_width:-bgd_width + yeven, :]</span>
    <span class="c1"># Ny, Nx = data.shape</span>
    <span class="c1"># target_pixcoords_spectrogram[1] -= bgd_width</span>

    <span class="c1"># Spectrogram must have odd size in y for the fourier simulation</span>
    <span class="k">if</span> <span class="n">Ny</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">bgd</span> <span class="o">=</span> <span class="n">bgd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># First guess for lambdas</span>
    <span class="n">first_guess_lambdas</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">grating_pixel_to_lambda</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_distance_along_dispersion_axis</span><span class="p">(),</span>
                                                                  <span class="n">x0</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;lambdas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_guess_lambdas</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">first_guess_lambdas</span><span class="p">)</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Transverse fit table after derotation:</span><span class="se">\n</span><span class="s2">{s.table[[&#39;lambdas&#39;, &#39;Dx_rot&#39;, &#39;Dx&#39;]]}&quot;</span><span class="p">)</span>

    <span class="c1"># Position of the order 0 in the spectrogram coordinates</span>
    <span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Extract spectrogram: crop image [</span><span class="si">{xmin}</span><span class="s1">:</span><span class="si">{xmax}</span><span class="s1">,</span><span class="si">{ymin}</span><span class="s1">:</span><span class="si">{ymax}</span><span class="s1">] (size (</span><span class="si">{Nx}</span><span class="s1">, </span><span class="si">{Ny}</span><span class="s1">))&#39;</span>
                   <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">New target position in spectrogram frame: </span><span class="si">{target_pixcoords_spectrogram}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Save results</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_err</span> <span class="o">=</span> <span class="n">err</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_bgd</span> <span class="o">=</span> <span class="n">bgd</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_x0</span> <span class="o">=</span> <span class="n">target_pixcoords_spectrogram</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_y0</span> <span class="o">=</span> <span class="n">target_pixcoords_spectrogram</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_xmin</span> <span class="o">=</span> <span class="n">xmin</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_xmax</span> <span class="o">=</span> <span class="n">xmax</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_ymin</span> <span class="o">=</span> <span class="n">ymin</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_ymax</span> <span class="o">=</span> <span class="n">ymax</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_deg</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrogram_saturation</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">chromatic_psf</span><span class="o">.</span><span class="n">saturation</span>

    <span class="c1"># Summary plot</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">or</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dx_rot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">target_pixcoords_spectrogram</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_mean&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Dispersion axis&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">target_pixcoords_spectrogram</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">],</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;lambdas&#39;</span><span class="p">],</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">from_lambda_to_colormap</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;lambdas&#39;</span><span class="p">]),</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted spectrum centers&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">target_pixcoords_spectrogram</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_fwhm_inf&#39;</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted FWHM&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">target_pixcoords_spectrogram</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Dy_fwhm_sup&#39;</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xx</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">plot_spectrum_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data_err</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">err</span><span class="p">,</span>
                             <span class="n">units</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted spectrum&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_sum&#39;</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cross spectrum&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xx</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_integral&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux_sum&#39;</span><span class="p">],</span>
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;(model_integral-cross_sum)/cross_sum&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Relative difference&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pos0</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">pos2</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">pos0</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">pos2</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">pos0</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">pos2</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">pos1</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">pos2</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">pos1</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">,</span> <span class="s1">&#39;spectrum.pdf&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">spectrum</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s2">&quot;1.14.0&quot;</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">legacy</span><span class="o">=</span><span class="s2">&quot;1.13&quot;</span><span class="p">)</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jeremy Neveu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>