

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectractor.extractor.images &mdash; Spectractor 1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Spectractor
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/spectractor.extractor.html">spectractor.extractor package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/modules.html">spectractor</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Spectractor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>spectractor.extractor.images</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectractor.extractor.images</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="k">import</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">units</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">spectractor</span> <span class="k">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">spectractor.config</span> <span class="k">import</span> <span class="n">set_logger</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.targets</span> <span class="k">import</span> <span class="n">load_target</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.dispersers</span> <span class="k">import</span> <span class="n">Hologram</span>
<span class="kn">from</span> <span class="nn">spectractor.extractor.psf</span> <span class="k">import</span> <span class="n">fit_PSF2D_minuit</span>
<span class="kn">from</span> <span class="nn">spectractor.tools</span> <span class="k">import</span> <span class="p">(</span><span class="n">plot_image_simple</span><span class="p">,</span> <span class="n">save_fits</span><span class="p">,</span> <span class="n">load_fits</span><span class="p">,</span> <span class="n">extract_info_from_CTIO_header</span><span class="p">,</span>
                               <span class="n">fit_poly1d</span><span class="p">,</span> <span class="n">fit_poly1d_outlier_removal</span><span class="p">,</span> <span class="n">weighted_avg_and_std</span><span class="p">,</span>
                               <span class="n">fit_poly2d_outlier_removal</span><span class="p">,</span> <span class="n">hessian_and_theta</span><span class="p">)</span>


<div class="viewcode-block" id="Image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image">[docs]</a><span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">disperser_label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The image class contains all the features necessary to load an image and extract a spectrum.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str</span>
<span class="sd">            The file name where the image is.</span>
<span class="sd">        target: str, optional</span>
<span class="sd">            The target name, to be found in data bases.</span>
<span class="sd">        disperser_label: str, optional</span>
<span class="sd">            The disperser label to load its properties</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. doctest::</span>

<span class="sd">            &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>

<span class="sd">        .. doctest::</span>
<span class="sd">            :hide:</span>

<span class="sd">            &gt;&gt;&gt; assert im.file_name == &#39;tests/data/reduc_20170605_028.fits&#39;</span>
<span class="sd">            &gt;&gt;&gt; assert im.data is not None and np.mean(im.data) &gt; 0</span>
<span class="sd">            &gt;&gt;&gt; assert im.stat_errors is not None and np.mean(im.stat_errors) &gt; 0</span>
<span class="sd">            &gt;&gt;&gt; assert im.header is not None</span>
<span class="sd">            &gt;&gt;&gt; assert im.gain is not None and np.mean(im.gain) &gt; 0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span> <span class="o">=</span> <span class="n">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expo</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_obs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser_label</span> <span class="o">=</span> <span class="n">disperser_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rotated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># in e-/ADU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_out_noise</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors_rotated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallactic_angle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saturation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CALLING_CODE</span> <span class="o">!=</span> <span class="s1">&#39;LSST_DM&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># data provided by the LSST shim, just instantiate objects</span>
            <span class="c1"># necessary for the following code not to fail</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="c1"># Load the target if given</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pixcoords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_bkgd2D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_star2D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">load_target</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;TARGET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;object targeted in the image&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;REDSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">redshift</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;REDSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;redshift of the target&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Image.load_image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image.load_image">[docs]</a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the image and store some information from header in class attributes.</span>
<span class="sd">        Then load the target and disperser properties. Called when an Image instance is created.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str</span>
<span class="sd">            The fits file name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">OBS_NAME</span> <span class="o">==</span> <span class="s1">&#39;CTIO&#39;</span><span class="p">:</span>
            <span class="n">load_CTIO_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">parameters</span><span class="o">.</span><span class="n">OBS_NAME</span> <span class="o">==</span> <span class="s1">&#39;LPNHE&#39;</span><span class="p">:</span>
            <span class="n">load_LPNHE_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Load the disperser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Loading disperser </span><span class="si">{self.disperser_label}</span><span class="s1">...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="n">Hologram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disperser_label</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span><span class="p">,</span>
                                  <span class="n">data_dir</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">HOLO_DIR</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_statistical_error</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_ADU_rate_units</span><span class="p">()</span></div>

<div class="viewcode-block" id="Image.save_image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image.save_image">[docs]</a>    <span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the image in a fits file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_file_name: str</span>
<span class="sd">            The output file name.</span>
<span class="sd">        overwrite: bool</span>
<span class="sd">            If True, overwrite the file if it exists previously (default: False).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; im.save_image(&#39;tests/data/reduc_20170605_028_copy.fits&#39;, overwrite=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">save_fits</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Image saved in </span><span class="si">{output_file_name}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.convert_to_ADU_rate_units"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image.convert_to_ADU_rate_units">[docs]</a>    <span class="k">def</span> <span class="nf">convert_to_ADU_rate_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert Image data from ADU to ADU/s units.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(im.expo)</span>
<span class="sd">        600.0</span>
<span class="sd">        &gt;&gt;&gt; data_before = np.copy(im.data)</span>
<span class="sd">        &gt;&gt;&gt; im.convert_to_ADU_rate_units()</span>

<span class="sd">        .. doctest::</span>
<span class="sd">            :hide:</span>

<span class="sd">            &gt;&gt;&gt; assert np.all(np.isclose(data_before, im.data * im.expo))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">expo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expo</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors_rotated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors_rotated</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;ADU/s&#39;</span></div>

<div class="viewcode-block" id="Image.convert_to_ADU_units"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image.convert_to_ADU_units">[docs]</a>    <span class="k">def</span> <span class="nf">convert_to_ADU_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert Image data from ADU/s to ADU units.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(im.expo)</span>
<span class="sd">        600.0</span>
<span class="sd">        &gt;&gt;&gt; data_before = np.copy(im.data)</span>
<span class="sd">        &gt;&gt;&gt; im.convert_to_ADU_rate_units()</span>
<span class="sd">        &gt;&gt;&gt; data_after = np.copy(im.data)</span>
<span class="sd">        &gt;&gt;&gt; im.convert_to_ADU_units()</span>

<span class="sd">        .. doctest::</span>
<span class="sd">            :hide:</span>

<span class="sd">            &gt;&gt;&gt; assert np.all(np.isclose(data_before, im.data))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expo</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors_rotated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors_rotated</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span></div>

<div class="viewcode-block" id="Image.compute_statistical_error"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image.compute_statistical_error">[docs]</a>    <span class="k">def</span> <span class="nf">compute_statistical_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the image noise map from Image.data. The latter must be in ADU.</span>
<span class="sd">        The function first converts the image in electron counts units, evaluate the Poisson noise,</span>
<span class="sd">        add in quadrature the read-out noise, takes the square root and returns a map in ADU units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="s1">&#39;ADU&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Noise must be estimated on an image in ADU units&#39;</span><span class="p">)</span>
        <span class="c1"># removes the zeros and negative pixels first</span>
        <span class="c1"># set to minimum positive value</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">min_noz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_noz</span>
        <span class="c1"># OLD: compute poisson noise in ADU/s without read-out noise</span>
        <span class="c1"># self.stat_errors = np.sqrt(data) / np.sqrt(self.gain * self.expo)</span>
        <span class="c1"># convert in e- counts</span>
        <span class="n">err2</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_out_noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_out_noise</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_out_noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err2</span><span class="p">)</span>
        <span class="c1"># convert in ADU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">fit</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">fit_poly1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;fitted gain=</span><span class="si">{gain:.3g}</span><span class="s2"> [e-/ADU]</span><span class="se">\n</span><span class="s2">intercept=</span><span class="si">{fit[1]:.3g}</span><span class="s2"> [ADU$^2$]&quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">fitted read-out={np.sqrt(fit[1]) * gain:.3g} [ADU]&quot;</span><span class="p">,</span>
                       <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sigma_{\mathrm</span><span class="si">{ADU}</span><span class="s2">}^2$ [ADU$^2$]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Data pixel values [ADU]&quot;</span><span class="p">)</span>
            <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;log10&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Uncertainty map&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                              <span class="n">target_pixcoords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">,</span> <span class="s1">&#39;uncertainty_map.png&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Image.compute_parallactic_angle"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image.compute_parallactic_angle">[docs]</a>    <span class="k">def</span> <span class="nf">compute_parallactic_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the parallactic angle.</span>

<span class="sd">        Script from A. Guyonnet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">OBS_LATITUDE</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">latitude</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">60.</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">latitude</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3600.</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">radian</span>
        <span class="n">ha</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HA&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;hourangle&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">radian</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">units</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">radian</span>
        <span class="n">parallactic_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallactic_angle</span> <span class="o">=</span> <span class="n">parallactic_angle</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PARANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallactic_angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;PARANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;parallactic angle in degree&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallactic_angle</span></div>

<div class="viewcode-block" id="Image.plot_image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.Image.plot_image">[docs]</a>    <span class="k">def</span> <span class="nf">plot_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;Image units&quot;</span><span class="p">,</span> <span class="n">plot_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">target_pixcoords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">9.3</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax: Axes, optional</span>
<span class="sd">            Axes instance (default: None).</span>
<span class="sd">        scale: str</span>
<span class="sd">            Scaling of the image (choose between: lin, log or log10) (default: lin)</span>
<span class="sd">        title: str</span>
<span class="sd">            Title of the image (default: &quot;&quot;)</span>
<span class="sd">        units: str</span>
<span class="sd">            Units of the image to be written in the color bar label (default: &quot;Image units&quot;)</span>
<span class="sd">        cmap: colormap</span>
<span class="sd">            Color map label (default: None)</span>
<span class="sd">        target_pixcoords: array_like, optional</span>
<span class="sd">            2D array  giving the (x,y) coordinates of the targets on the image: add a scatter plot (default: None)</span>
<span class="sd">        vmin: float</span>
<span class="sd">            Minimum value of the image (default: None)</span>
<span class="sd">        vmax: float</span>
<span class="sd">            Maximum value of the image (default: None)</span>
<span class="sd">        aspect: str</span>
<span class="sd">            Aspect keyword to be passed to imshow (default: None)</span>
<span class="sd">        cax: Axes, optional</span>
<span class="sd">            Color bar axes if necessary (default: None).</span>
<span class="sd">        figsize: tuple</span>
<span class="sd">            Figure size (default: [9.3, 8]).</span>
<span class="sd">        plot_stats: bool</span>
<span class="sd">            If True, plot the uncertainty map instead of the image (default: False).</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt; im.plot_image(target_pixcoords=[820, 580])</span>
<span class="sd">        &gt;&gt;&gt; if parameters.DISPLAY: plt.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_stats</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stat_errors</span><span class="p">)</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span>
                          <span class="n">target_pixcoords</span><span class="o">=</span><span class="n">target_pixcoords</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>   <span class="c1"># pragma: no cover</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="load_CTIO_image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.load_CTIO_image">[docs]</a><span class="k">def</span> <span class="nf">load_CTIO_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Specific routine to load CTIO fits files and load their data and properties for Spectractor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance to fill with file data and header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Loading CTIO image </span><span class="si">{image.file_name}</span><span class="s1">...&#39;</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">extract_info_from_CTIO_header</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;LSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XLENGTH&#39;</span><span class="p">])</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_PIXEL2ARCSEC</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;XPIXSIZE&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;YLENGTH&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Image rectangular: X=</span><span class="si">{parameters.CCD_IMSIZE:d}</span><span class="s1"> pix, Y=</span><span class="si">{image.header[&quot;YLENGTH&quot;]:d}</span><span class="s1"> pix&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;YPIXSIZE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_PIXEL2ARCSEC</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Pixel size rectangular: X=</span><span class="si">%d</span><span class="s1"> arcsec, Y=</span><span class="si">%d</span><span class="s1"> arcsec&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_PIXEL2ARCSEC</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;YPIXSIZE&#39;</span><span class="p">]))</span>
    <span class="n">image</span><span class="o">.</span><span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                           <span class="n">obstime</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">])</span>
    <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Image </span><span class="si">{image.file_name}</span><span class="s1"> loaded.&#39;</span><span class="p">)</span>
    <span class="c1"># compute CCD gain map</span>
    <span class="n">build_CTIO_gain_map</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">build_CTIO_read_out_noise_map</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">compute_parallactic_angle</span><span class="p">()</span></div>


<div class="viewcode-block" id="build_CTIO_gain_map"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.build_CTIO_gain_map">[docs]</a><span class="k">def</span> <span class="nf">build_CTIO_gain_map</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the CTIO gain map according to header GAIN values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance to fill with file data and header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span>
    <span class="n">image</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># ampli 11</span>
    <span class="n">image</span><span class="o">.</span><span class="n">gain</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTGAIN11&#39;</span><span class="p">]</span>
    <span class="c1"># ampli 12</span>
    <span class="n">image</span><span class="o">.</span><span class="n">gain</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTGAIN12&#39;</span><span class="p">]</span>
    <span class="c1"># ampli 21</span>
    <span class="n">image</span><span class="o">.</span><span class="n">gain</span><span class="p">[</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTGAIN21&#39;</span><span class="p">]</span>
    <span class="c1"># ampli 22</span>
    <span class="n">image</span><span class="o">.</span><span class="n">gain</span><span class="p">[</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTGAIN22&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="build_CTIO_read_out_noise_map"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.build_CTIO_read_out_noise_map">[docs]</a><span class="k">def</span> <span class="nf">build_CTIO_read_out_noise_map</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the CTIO gain map according to header GAIN values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance to fill with file data and header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span>
    <span class="n">image</span><span class="o">.</span><span class="n">read_out_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># ampli 11</span>
    <span class="n">image</span><span class="o">.</span><span class="n">read_out_noise</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTRON11&#39;</span><span class="p">]</span>
    <span class="c1"># ampli 12</span>
    <span class="n">image</span><span class="o">.</span><span class="n">read_out_noise</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTRON12&#39;</span><span class="p">]</span>
    <span class="c1"># ampli 21</span>
    <span class="n">image</span><span class="o">.</span><span class="n">read_out_noise</span><span class="p">[</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTRON21&#39;</span><span class="p">]</span>
    <span class="c1"># ampli 22</span>
    <span class="n">image</span><span class="o">.</span><span class="n">read_out_noise</span><span class="p">[</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GTRON22&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="load_LPNHE_image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.load_LPNHE_image">[docs]</a><span class="k">def</span> <span class="nf">load_LPNHE_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
    <span class="sd">&quot;&quot;&quot;Specific routine to load LPNHE fits files and load their data and properties for Spectractor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance to fill with file data and header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Loading LPNHE image </span><span class="si">{image.file_name}</span><span class="s1">...&#39;</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">data1</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">data2</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data1</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="n">data2</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">]))</span>
    <span class="n">image</span><span class="o">.</span><span class="n">date_obs</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">]</span>
    <span class="n">image</span><span class="o">.</span><span class="n">expo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">])</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;LSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;D2CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISTANCE2CCD</span>
    <span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span>
    <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Image loaded&#39;</span><span class="p">)</span>
    <span class="c1"># compute CCD gain map</span>
    <span class="n">image</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CCDGAIN&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="find_target"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.find_target">[docs]</a><span class="k">def</span> <span class="nf">find_target</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the target in the Image instance.</span>

<span class="sd">    The object is search in a windows of size defined by the XWINDOW and YWINDOW parameters,</span>
<span class="sd">    using two iterative fits of a PSF2D model.</span>
<span class="sd">    User must give a guess array in the raw image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance.</span>
<span class="sd">    guess: array_like</span>
<span class="sd">        Two parameter array giving the estimated position of the target in the image.</span>
<span class="sd">    rotated: bool</span>
<span class="sd">        If True, the target is searched in the rotated image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x0: float</span>
<span class="sd">        The x position of the target.</span>
<span class="sd">    y0: float</span>
<span class="sd">        The y position of the target.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Dx</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">XWINDOW</span>
    <span class="n">Dy</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span>
    <span class="n">theX</span><span class="p">,</span> <span class="n">theY</span> <span class="o">=</span> <span class="n">guess</span>
    <span class="k">if</span> <span class="n">rotated</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]])</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">guess2</span> <span class="o">=</span> <span class="n">rotmat</span> <span class="o">@</span> <span class="n">vec</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data_rotated</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">guess2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">guess2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">]</span>
        <span class="n">Dx</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">XWINDOW_ROT</span>
        <span class="n">Dy</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW_ROT</span>
    <span class="n">niter</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
        <span class="n">sub_image</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">sub_errors</span> <span class="o">=</span> <span class="n">find_target_init</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="n">rotated</span><span class="p">,</span>
                                                                 <span class="n">widths</span><span class="o">=</span><span class="p">[</span><span class="n">Dx</span><span class="p">,</span> <span class="n">Dy</span><span class="p">])</span>
        <span class="c1"># find the target</span>
        <span class="n">avX</span><span class="p">,</span> <span class="n">avY</span> <span class="o">=</span> <span class="n">find_target_2Dprofile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sub_image</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">sub_errors</span><span class="o">=</span><span class="n">sub_errors</span><span class="p">)</span>
        <span class="c1"># compute target position</span>
        <span class="n">theX</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">Dx</span> <span class="o">+</span> <span class="n">avX</span>
        <span class="n">theY</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">Dy</span> <span class="o">+</span> <span class="n">avY</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">theX</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">theY</span><span class="p">)]</span>
        <span class="n">Dx</span> <span class="o">=</span> <span class="n">Dx</span> <span class="o">//</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">Dy</span> <span class="o">=</span> <span class="n">Dy</span> <span class="o">//</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">X,Y target position in pixels: </span><span class="si">{theX:.3f}</span><span class="s1">,</span><span class="si">{theY:.3f}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rotated</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span> <span class="o">=</span> <span class="p">[</span><span class="n">theX</span><span class="p">,</span> <span class="n">theY</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">theX</span><span class="p">,</span> <span class="n">theY</span><span class="p">]</span>
        <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGETX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theX</span>
        <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;TARGETX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;target position on X axis&#39;</span>
        <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARGETY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theY</span>
        <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;TARGETY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;target position on Y axis&#39;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">theX</span><span class="p">,</span> <span class="n">theY</span><span class="p">]</span></div>


<div class="viewcode-block" id="find_target_init"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.find_target_init">[docs]</a><span class="k">def</span> <span class="nf">find_target_init</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="p">[</span><span class="n">parameters</span><span class="o">.</span><span class="n">XWINDOW</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the search of the target cropping the image and setting the saturation level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance.</span>
<span class="sd">    guess: array_like</span>
<span class="sd">        Two parameter array giving the estimated position of the target in the image.</span>
<span class="sd">    rotated: bool</span>
<span class="sd">        If True, the target is searched in the rotated image.</span>
<span class="sd">    widths: array_like</span>
<span class="sd">        Two parameter array to define the width of the cropped image (default: [parameters.XWINDOW, parameters.YWINDOW])</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sub_image: array_like</span>
<span class="sd">        The cropped image data array where the fit has to be performed.</span>
<span class="sd">    x0: float</span>
<span class="sd">        The x position of the target.</span>
<span class="sd">    y0: float</span>
<span class="sd">        The y position of the target.</span>
<span class="sd">    Dx: int</span>
<span class="sd">        The width of the cropped image.</span>
<span class="sd">    Dy: int</span>
<span class="sd">        The height of the cropped image.</span>
<span class="sd">    sub_errors: array_like</span>
<span class="sd">        The cropped image uncertainty array where the fit has to be performed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">guess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Dx</span><span class="p">,</span> <span class="n">Dy</span> <span class="o">=</span> <span class="n">widths</span>
    <span class="k">if</span> <span class="n">rotated</span><span class="p">:</span>
        <span class="n">sub_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data_rotated</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="n">Dy</span><span class="p">:</span><span class="n">y0</span> <span class="o">+</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">:</span><span class="n">x0</span> <span class="o">+</span> <span class="n">Dx</span><span class="p">])</span>
        <span class="n">sub_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">stat_errors</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="n">Dy</span><span class="p">:</span><span class="n">y0</span> <span class="o">+</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">:</span><span class="n">x0</span> <span class="o">+</span> <span class="n">Dx</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sub_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="n">Dy</span><span class="p">:</span><span class="n">y0</span> <span class="o">+</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">:</span><span class="n">x0</span> <span class="o">+</span> <span class="n">Dx</span><span class="p">])</span>
        <span class="n">sub_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">stat_errors</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="n">Dy</span><span class="p">:</span><span class="n">y0</span> <span class="o">+</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">Dx</span><span class="p">:</span><span class="n">x0</span> <span class="o">+</span> <span class="n">Dx</span><span class="p">])</span>
    <span class="n">image</span><span class="o">.</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_MAXADU</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">expo</span>
    <span class="c1"># sub_image = clean_target_spikes(sub_image, image.saturation)</span>
    <span class="k">return</span> <span class="n">sub_image</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">Dy</span><span class="p">,</span> <span class="n">sub_errors</span></div>


<div class="viewcode-block" id="find_target_1Dprofile"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.find_target_1Dprofile">[docs]</a><span class="k">def</span> <span class="nf">find_target_1Dprofile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sub_image</span><span class="p">,</span> <span class="n">guess</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find precisely the position of the targeted object fitting a PSF1D model</span>
<span class="sd">    on each projection of the image along x and y, using outlier removal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance.</span>
<span class="sd">    sub_image: array_like</span>
<span class="sd">        The cropped image data array where the fit is performed.</span>
<span class="sd">    guess: array_like</span>
<span class="sd">        Two parameter array giving the estimated position of the target in the image.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">    &gt;&gt;&gt; guess = [820, 580]</span>

<span class="sd">    .. plot::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        from spectractor.extractor.images import Image</span>
<span class="sd">        im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">        im.plot_image(target_pixcoords=[820, 580])</span>

<span class="sd">    &gt;&gt;&gt; parameters.DEBUG = True</span>
<span class="sd">    &gt;&gt;&gt; sub_image, x0, y0, Dx, Dy, sub_errors = find_target_init(im, guess, rotated=False)</span>
<span class="sd">    &gt;&gt;&gt; x1, y1 = find_target_1Dprofile(im, sub_image, guess)</span>

<span class="sd">    .. doctest::</span>
<span class="sd">        :hide:</span>

<span class="sd">        &gt;&gt;&gt; assert np.isclose(x1, np.argmax(np.nansum(sub_image, axis=0)), rtol=1e-2)</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(y1, np.argmax(np.nansum(sub_image, axis=1)), rtol=1e-2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NY</span><span class="p">,</span> <span class="n">NX</span> <span class="o">=</span> <span class="n">sub_image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NY</span><span class="p">)</span>
    <span class="c1"># Mask aigrette</span>
    <span class="n">saturated_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sub_image</span> <span class="o">&gt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">%d</span><span class="s1"> saturated pixels: set saturation level to </span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">saturated_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
        <span class="c1"># sub_image[sub_image &gt;= 0.5*image.saturation] = np.nan</span>
    <span class="c1"># compute profiles</span>
    <span class="n">profile_X_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">profile_Y_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># fit and subtract smooth polynomial background</span>
    <span class="c1"># with 3sigma rejection of outliers (star peaks)</span>
    <span class="n">bkgd_X</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">fit_poly1d_outlier_removal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">profile_X_raw</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bkgd_Y</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">fit_poly1d_outlier_removal</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">profile_Y_raw</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">profile_X</span> <span class="o">=</span> <span class="n">profile_X_raw</span> <span class="o">-</span> <span class="n">bkgd_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># np.min(profile_X)</span>
    <span class="n">profile_Y</span> <span class="o">=</span> <span class="n">profile_Y_raw</span> <span class="o">-</span> <span class="n">bkgd_Y</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>  <span class="c1"># np.min(profile_Y)</span>
    <span class="n">avX</span><span class="p">,</span> <span class="n">sigX</span> <span class="o">=</span> <span class="n">weighted_avg_and_std</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">profile_X</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">avY</span><span class="p">,</span> <span class="n">sigY</span> <span class="o">=</span> <span class="n">weighted_avg_and_std</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">profile_Y</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">profile_X</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">avX</span><span class="p">)]</span> <span class="o">&lt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">profile_X</span><span class="p">):</span>
        <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">X position determination of the target probably wrong&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">profile_Y</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">avY</span><span class="p">)]</span> <span class="o">&lt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">profile_Y</span><span class="p">):</span>
        <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Y position determination of the target probably wrong&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sub_image</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">target_pixcoords</span><span class="o">=</span><span class="p">[</span><span class="n">avX</span><span class="p">,</span> <span class="n">avY</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">profile_X_raw</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">bkgd_X</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;bkgd&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">avX</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">profile_Y_raw</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">bkgd_Y</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;bkgd&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">avY</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">,</span> <span class="s1">&#39;namethisplot1.pdf&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">avX</span><span class="p">,</span> <span class="n">avY</span></div>


<div class="viewcode-block" id="find_target_2Dprofile"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.find_target_2Dprofile">[docs]</a><span class="k">def</span> <span class="nf">find_target_2Dprofile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sub_image</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">sub_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find precisely the position of the targeted object fitting a PSF2D model.</span>
<span class="sd">    A polynomial 2D background is subtracted first. Saturated pixels are masked with np.nan values.</span>

<span class="sd">    THE ERROR ARRAY IS NOT USED FOR THE MOMENT.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance.</span>
<span class="sd">    sub_image: array_like</span>
<span class="sd">        The cropped image data array where the fit is performed.</span>
<span class="sd">    guess: array_like</span>
<span class="sd">        Two parameter array giving the estimated position of the target in the image.</span>
<span class="sd">    sub_errors: array_like</span>
<span class="sd">        The image data uncertainties.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">    &gt;&gt;&gt; guess = [820, 580]</span>

<span class="sd">    .. plot::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        from spectractor.extractor.images import Image</span>
<span class="sd">        im = Image(&#39;tests/data/reduc_20170605_028.fits&#39;)</span>
<span class="sd">        im.plot_image(target_pixcoords=[820, 580])</span>

<span class="sd">    &gt;&gt;&gt; parameters.DEBUG = True</span>
<span class="sd">    &gt;&gt;&gt; sub_image, x0, y0, Dx, Dy, sub_errors = find_target_init(im, guess, rotated=False)</span>
<span class="sd">    &gt;&gt;&gt; xmax = np.argmax(np.sum(sub_image, axis=0))</span>
<span class="sd">    &gt;&gt;&gt; ymax = np.argmax(np.sum(sub_image, axis=1))</span>
<span class="sd">    &gt;&gt;&gt; x1, y1 = find_target_2Dprofile(im, sub_image, guess)</span>

<span class="sd">    .. doctest::</span>
<span class="sd">        :hide:</span>

<span class="sd">        &gt;&gt;&gt; assert np.isclose(x1, xmax, rtol=1e-2)</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(y1, ymax, rtol=1e-2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: replace with minuit and test on image _133.fits or decrease mean_prior</span>
    <span class="c1"># fit and subtract smooth polynomial background</span>
    <span class="c1"># with 3sigma rejection of outliers (star peaks)</span>
    <span class="n">NY</span><span class="p">,</span> <span class="n">NX</span> <span class="o">=</span> <span class="n">sub_image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span>
    <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NY</span><span class="p">)</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">NY</span><span class="p">,</span> <span class="p">:</span><span class="n">NX</span><span class="p">]</span>
    <span class="n">bkgd_2D</span> <span class="o">=</span> <span class="n">fit_poly2d_outlier_removal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">sub_image</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">target_bkgd2D</span> <span class="o">=</span> <span class="n">bkgd_2D</span>
    <span class="n">sub_image_subtracted</span> <span class="o">=</span> <span class="n">sub_image</span> <span class="o">-</span> <span class="n">bkgd_2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="c1"># find a first guess of the target position</span>
    <span class="n">avX</span><span class="p">,</span> <span class="n">sigX</span> <span class="o">=</span> <span class="n">weighted_avg_and_std</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_image_subtracted</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">avY</span><span class="p">,</span> <span class="n">sigY</span> <span class="o">=</span> <span class="n">weighted_avg_and_std</span><span class="p">(</span><span class="n">YY</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_image_subtracted</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
    <span class="c1"># fit a 2D star profile close to this position</span>
    <span class="c1"># guess = [np.max(sub_image_subtracted),avX,avY,1,1] #for Moffat2D</span>
    <span class="c1"># guess = [np.max(sub_image_subtracted),avX-2,avY-2,2,2,0] #for Gauss2D</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sub_image_subtracted</span><span class="p">),</span> <span class="n">avX</span><span class="p">,</span> <span class="n">avY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">target_star2D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">_model_to_fit_params</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_star2D</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">guess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">avX</span>
        <span class="n">guess</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">avY</span>
    <span class="n">mean_prior</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># in pixels</span>
    <span class="c1"># bounds = [ [0.5*np.max(sub_image_subtracted),avX-mean_prior,avY-mean_prior,0,-np.inf],</span>
    <span class="c1"># [2*np.max(sub_image_subtracted),avX+mean_prior,avY+mean_prior,np.inf,np.inf] ] #for Moffat2D</span>
    <span class="c1"># bounds = [ [0.5*np.max(sub_image_subtracted),avX-mean_prior,avY-mean_prior,0,0,0],</span>
    <span class="c1"># [100*image.saturation,avX+mean_prior,avY+mean_prior,10,10,np.pi] ] #for Gauss2D</span>
    <span class="c1"># bounds = [[0.5 * np.max(sub_image_subtracted), avX - mean_prior, avY - mean_prior, 2, 0.9 * image.saturation],</span>
    <span class="c1"># [10 * image.saturation, avX + mean_prior, avY + mean_prior, 15, 1.1 * image.saturation]]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sub_image_subtracted</span><span class="p">),</span> <span class="n">avX</span> <span class="o">-</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="n">avY</span> <span class="o">-</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
               <span class="mf">0.9</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">10</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">,</span> <span class="n">avX</span> <span class="o">+</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="n">avY</span> <span class="o">+</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">]]</span>
    <span class="n">saturated_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sub_image</span> <span class="o">&gt;=</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">saturated_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">{len(saturated_pixels[0])} saturated pixels: set saturation level &#39;</span>
                <span class="n">f</span><span class="s1">&#39;to </span><span class="si">{image.saturation}</span><span class="s1"> </span><span class="si">{image.units}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">sub_image_subtracted</span><span class="p">[</span><span class="n">sub_image</span> <span class="o">&gt;=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">sub_image</span><span class="p">[</span><span class="n">sub_image</span> <span class="o">&gt;=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">saturation</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># fit</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="c1"># star2D = fit_PSF2D(X, Y, sub_image_subtracted, guess=guess, bounds=bounds)</span>
    <span class="n">star2D</span> <span class="o">=</span> <span class="n">fit_PSF2D_minuit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">sub_image_subtracted</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">new_avX</span> <span class="o">=</span> <span class="n">star2D</span><span class="o">.</span><span class="n">x_mean</span><span class="o">.</span><span class="n">value</span>
    <span class="n">new_avY</span> <span class="o">=</span> <span class="n">star2D</span><span class="o">.</span><span class="n">y_mean</span><span class="o">.</span><span class="n">value</span>
    <span class="n">image</span><span class="o">.</span><span class="n">target_star2D</span> <span class="o">=</span> <span class="n">star2D</span>
    <span class="c1"># check target positions</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">new_avY</span> <span class="o">-</span> <span class="n">avY</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_avX</span> <span class="o">-</span> <span class="n">avX</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">mean_prior</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">X=</span><span class="si">{new_avX:.2f}</span><span class="s1">, Y=</span><span class="si">{new_avY:.2f}</span><span class="s1"> target position determination probably wrong: &#39;</span>
            <span class="n">f</span><span class="s1">&#39;</span><span class="si">{dist:.1f}</span><span class="s1"> pixels from profile detection (</span><span class="si">{avX:.2f}</span><span class="s1">, </span><span class="si">{avY:.2f}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="c1"># debugging plots</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sub_image</span><span class="p">))</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sub_image</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                          <span class="n">target_pixcoords</span><span class="o">=</span><span class="p">[</span><span class="n">new_avX</span><span class="p">,</span> <span class="n">new_avY</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">star2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">+</span> <span class="n">bkgd_2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                          <span class="n">units</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;Background+Star2D (</span><span class="si">{image.units}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sub_image</span> <span class="o">-</span> <span class="n">star2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-</span> <span class="n">bkgd_2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;lin&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                          <span class="n">units</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;Background+Star2D subtracted image</span><span class="se">\n</span><span class="s1">(</span><span class="si">{image.units}</span><span class="s1">)&#39;</span><span class="p">,</span>
                          <span class="n">target_pixcoords</span><span class="o">=</span><span class="p">[</span><span class="n">new_avX</span><span class="p">,</span> <span class="n">new_avY</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">,</span> <span class="s1">&#39;namethisplot2.pdf&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_avX</span><span class="p">,</span> <span class="n">new_avY</span></div>


<div class="viewcode-block" id="compute_rotation_angle_hessian"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.compute_rotation_angle_hessian">[docs]</a><span class="k">def</span> <span class="nf">compute_rotation_angle_hessian</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">deg_threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width_cut</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">,</span>
                                   <span class="n">right_edge</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span>
                                   <span class="n">margin_cut</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the rotation angle in degree of a spectrogram with the Hessian of the image.</span>
<span class="sd">    Use the disperser rotation angle map as a prior and the target_pixcoords values to crop the image</span>
<span class="sd">    around the spectrogram.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance.</span>
<span class="sd">    deg_threshold: float</span>
<span class="sd">        Don&#39;t consider pixel with Hessian angle above deg_threshold or below -deg_threshold (default: 10).</span>
<span class="sd">    width_cut: int</span>
<span class="sd">        Half with of the image to consider in height (default: parameters.YWINDOW).</span>
<span class="sd">    right_edge: int</span>
<span class="sd">        Maximum pixel on the right edge (default: parameters.CCD_IMSIZE - 200).</span>
<span class="sd">    margin_cut: int</span>
<span class="sd">        After computing the Hessian, to avoid bad values on the edges the function cut on the</span>
<span class="sd">        edge of image margin_cut pixels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    theta: float</span>
<span class="sd">        The median value of the histogram of angles deduced with the Hessian of the pixels (in degree).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; im=Image(&#39;tests/data/reduc_20170605_028.fits&#39;, disperser_label=&#39;HoloPhAg&#39;)</span>

<span class="sd">    Create a mock spectrogram:</span>

<span class="sd">    &gt;&gt;&gt; N = parameters.CCD_IMSIZE</span>
<span class="sd">    &gt;&gt;&gt; im.data = np.ones((N, N))</span>
<span class="sd">    &gt;&gt;&gt; slope = -0.1</span>
<span class="sd">    &gt;&gt;&gt; y = lambda x: slope * (x - 0.5*N) + 0.5*N</span>
<span class="sd">    &gt;&gt;&gt; for x in np.arange(N):</span>
<span class="sd">    ...     im.data[int(y(x)), x] = 10</span>
<span class="sd">    ...     im.data[int(y(x))+1, x] = 10</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from spectractor.extractor.images import Image</span>
<span class="sd">        import spectractor.parameters as parameters</span>
<span class="sd">        im=Image(&#39;tests/data/reduc_20170605_028.fits&#39;, disperser_label=&#39;HoloPhAg&#39;)</span>
<span class="sd">        N = parameters.CCD_IMSIZE</span>
<span class="sd">        N = parameters.CCD_IMSIZE</span>
<span class="sd">        im.data = np.ones((N, N))</span>
<span class="sd">        slope = -0.1</span>
<span class="sd">        y = lambda x: slope * (x - 0.5*N) + 0.5*N</span>
<span class="sd">        for x in np.arange(N):</span>
<span class="sd">            im.data[int(y(x)), x] = 10</span>
<span class="sd">            im.data[int(y(x))+1, x] = 10</span>
<span class="sd">        plt.imshow(im.data, origin=&#39;lower&#39;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &gt;&gt;&gt; im.target_pixcoords=(N//2, N//2)</span>
<span class="sd">    &gt;&gt;&gt; parameters.DEBUG = True</span>
<span class="sd">    &gt;&gt;&gt; theta = compute_rotation_angle_hessian(im)</span>
<span class="sd">    &gt;&gt;&gt; print(f&#39;{theta:.2f}, {np.arctan(slope)*180/np.pi:.2f}&#39;)</span>
<span class="sd">    -5.72, -5.71</span>

<span class="sd">    .. doctest::</span>
<span class="sd">        :hide:</span>

<span class="sd">        &gt;&gt;&gt; assert np.isclose(theta, np.arctan(slope)*180/np.pi, rtol=1e-2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># extract a region</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="n">width_cut</span><span class="p">:</span><span class="n">y0</span> <span class="o">+</span> <span class="n">width_cut</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">right_edge</span><span class="p">])</span>
    <span class="n">lambda_plus</span><span class="p">,</span> <span class="n">lambda_minus</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">hessian_and_theta</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">margin_cut</span><span class="p">)</span>
    <span class="c1"># thresholds</span>
    <span class="n">lambda_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lambda_minus</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lambda_minus</span> <span class="o">&gt;</span> <span class="n">lambda_threshold</span><span class="p">)</span>
    <span class="n">theta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">theta_mask</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">minimum_pixels</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">width_cut</span> <span class="o">*</span> <span class="n">right_edge</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta_mask</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">theta_mask</span><span class="p">)])</span> <span class="o">&lt;</span> <span class="n">minimum_pixels</span><span class="p">:</span>
        <span class="n">lambda_threshold</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lambda_minus</span> <span class="o">&gt;</span> <span class="n">lambda_threshold</span><span class="p">)</span>
        <span class="n">theta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">theta_mask</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># print len(theta_mask[~np.isnan(theta_mask)]), lambda_threshold</span>
    <span class="n">theta_guess</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">disperser</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">)</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">theta</span> <span class="o">-</span> <span class="n">theta_guess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">deg_threshold</span><span class="p">)</span>
    <span class="n">theta_mask</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">theta_mask</span> <span class="o">=</span> <span class="n">theta_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">theta_hist</span> <span class="o">=</span> <span class="n">theta_mask</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">theta_mask</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">OBS_OBJECT_TYPE</span> <span class="o">!=</span> <span class="s1">&#39;STAR&#39;</span><span class="p">:</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">theta_mask</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">theta_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta_median</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">))</span>
    <span class="n">theta_critical</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">20.</span> <span class="o">/</span> <span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;THETAFIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_median</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;THETAFIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[USED] rotation angle from the Hessian analysis&#39;</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;THETAINT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_guess</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;THETAINT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rotation angle interp from disperser scan&#39;</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">theta_median</span> <span class="o">-</span> <span class="n">theta_guess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">theta_critical</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Interpolated angle and fitted angle disagrees with more than 20 pixels &#39;</span>
            <span class="n">f</span><span class="s1">&#39;over </span><span class="si">{parameters.CCD_IMSIZE:d}</span><span class="s1"> pixels: </span><span class="si">{theta_median:.2f}</span><span class="s1"> vs </span><span class="si">{theta_guess:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">xindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xindex</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xindex</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">y_new</span> <span class="o">=</span> <span class="n">width_cut</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_new</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta_median</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">theta_mask</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">brg</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">deg_threshold</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">deg_threshold</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">width_cut</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [pixels]&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Y [pixels]&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_hist</span><span class="p">))))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">theta_median</span><span class="p">,</span> <span class="n">theta_median</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Rotation angles [degrees]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>   <span class="c1"># pragma: no cover</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">,</span> <span class="s1">&#39;rotation_hessian.pdf&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">theta_median</span></div>


<div class="viewcode-block" id="turn_image"><a class="viewcode-back" href="../../../source/spectractor.extractor.html#spectractor.extractor.images.turn_image">[docs]</a><span class="k">def</span> <span class="nf">turn_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the rotation angle using the Hessian algorithm and turn the image.</span>

<span class="sd">    The results are stored in Image.data_rotated and Image.stat_errors_rotated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: Image</span>
<span class="sd">        The Image instance.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Create of False spectrogram:</span>

<span class="sd">    &gt;&gt;&gt; im=Image(&#39;tests/data/reduc_20170605_028.fits&#39;, disperser_label=&#39;HoloPhAg&#39;)</span>
<span class="sd">    &gt;&gt;&gt; N = parameters.CCD_IMSIZE</span>
<span class="sd">    &gt;&gt;&gt; im.data = np.ones((N, N))</span>
<span class="sd">    &gt;&gt;&gt; slope = -0.1</span>
<span class="sd">    &gt;&gt;&gt; y = lambda x: slope * (x - 0.5*N) + 0.5*N</span>
<span class="sd">    &gt;&gt;&gt; for x in np.arange(N):</span>
<span class="sd">    ...     im.data[int(y(x)), x] = 10</span>
<span class="sd">    ...     im.data[int(y(x))+1, x] = 10</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from spectractor.extractor.images import Image</span>
<span class="sd">        import spectractor.parameters as parameters</span>
<span class="sd">        im=Image(&#39;tests/data/reduc_20170605_028.fits&#39;, disperser_label=&#39;HoloPhAg&#39;)</span>
<span class="sd">        N = parameters.CCD_IMSIZE</span>
<span class="sd">        im.data = np.ones((N, N))</span>
<span class="sd">        slope = -0.1</span>
<span class="sd">        y = lambda x: slope * (x - 0.5*N) + 0.5*N</span>
<span class="sd">        for x in np.arange(N):</span>
<span class="sd">            im.data[int(y(x)), x] = 10</span>
<span class="sd">            im.data[int(y(x))+1, x] = 10</span>
<span class="sd">        plt.imshow(im.data, origin=&#39;lower&#39;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &gt;&gt;&gt; im.target_pixcoords=(N//2, N//2)</span>
<span class="sd">    &gt;&gt;&gt; parameters.DEBUG = True</span>
<span class="sd">    &gt;&gt;&gt; turn_image(im)</span>

<span class="sd">    .. doctest::</span>
<span class="sd">        :hide:</span>

<span class="sd">        &gt;&gt;&gt; assert im.data_rotated is not None</span>
<span class="sd">        &gt;&gt;&gt; assert np.isclose(im.rotation_angle, np.arctan(slope)*180/np.pi, rtol=1e-2)</span>

<span class="sd">    .. plot::</span>

<span class="sd">        from spectractor.extractor.images import Image, turn_image</span>
<span class="sd">        import spectractor.parameters as parameters</span>
<span class="sd">        im=Image(&#39;tests/data/reduc_20170605_028.fits&#39;, disperser_label=&#39;HoloPhAg&#39;)</span>
<span class="sd">        N = parameters.CCD_IMSIZE</span>
<span class="sd">        im.data = np.ones((N, N))</span>
<span class="sd">        slope = -0.1</span>
<span class="sd">        y = lambda x: slope * (x - 0.5*N) + 0.5*N</span>
<span class="sd">        for x in np.arange(N):</span>
<span class="sd">            im.data[int(y(x)), x] = 10</span>
<span class="sd">            im.data[int(y(x))+1, x] = 10</span>

<span class="sd">        im.target_pixcoords=(N//2, N//2)</span>
<span class="sd">        turn_image(im)</span>
<span class="sd">        plt.imshow(im.data_rotated, origin=&#39;lower&#39;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span> <span class="o">=</span> <span class="n">compute_rotation_angle_hessian</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width_cut</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">,</span>
                                                          <span class="n">right_edge</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">CCD_IMSIZE</span> <span class="o">-</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span>
    <span class="n">image</span><span class="o">.</span><span class="n">my_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Rotate the image with angle theta=</span><span class="si">{image.rotation_angle:.2f}</span><span class="s1"> degree&#39;</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">data_rotated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span><span class="p">):</span>
        <span class="n">image</span><span class="o">.</span><span class="n">data_rotated</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span><span class="p">,</span>
                                                          <span class="n">prefilter</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">ROT_PREFILTER</span><span class="p">,</span>
                                                          <span class="n">order</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">ROT_ORDER</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">stat_errors_rotated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">stat_errors</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">rotation_angle</span><span class="p">,</span>
                                                <span class="n">prefilter</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">ROT_PREFILTER</span><span class="p">,</span>
                                                <span class="n">order</span><span class="o">=</span><span class="n">parameters</span><span class="o">.</span><span class="n">ROT_ORDER</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">,</span>
                                                                                       <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                    <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">],</span>
                          <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Raw image (log10 scale)&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                          <span class="n">target_pixcoords</span><span class="o">=</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">],</span> <span class="p">[</span><span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
        <span class="n">plot_image_simple</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">data_rotated</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">):</span>
                                                       <span class="nb">min</span><span class="p">(</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                    <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">],</span>
                          <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Turned image (log10 scale)&#39;</span><span class="p">,</span>
                          <span class="n">units</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">target_pixcoords</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">target_pixcoords_rotated</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">data_rotated</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">parameters</span><span class="o">.</span><span class="n">YWINDOW</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">DISPLAY</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">:</span>   <span class="c1"># pragma: no cover</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">LSST_SAVEFIGPATH</span><span class="p">,</span> <span class="s1">&#39;rotated_image.pdf&#39;</span><span class="p">))</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jeremy Neveu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>